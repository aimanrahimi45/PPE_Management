<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPE Management - Admin Dashboard</title>
    <link rel="manifest" href="/frontend/manifest.json?v={{MANIFEST_VERSION}}">
    <meta name="theme-color" content="#000000">
    
    <!-- Chart.js for professional analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Cache control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        /* CSS Custom Properties - Minimalist Black/White Theme */
        :root {
            --primary-color: #000000;
            --primary-dark: #000000;
            --primary-light: #333333;
            --secondary-color: #666666;
            --accent-color: #000000;
            --danger-color: #000000;
            --warning-color: #000000;
            --success-color: #000000;
            --info-color: #000000;
            
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #EEEEEE;
            --gray-300: #E0E0E0;
            --gray-400: #BDBDBD;
            --gray-500: #9E9E9E;
            --gray-600: #757575;
            --gray-700: #616161;
            --gray-800: #424242;
            --gray-900: #212121;
            
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 80px;
            --header-height: 72px;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 250ms ease-in-out;
            --transition-slow: 350ms ease-in-out;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.6;
            font-size: 14px;
            overflow-x: hidden;
        }
        
        /* Layout Structure */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 100;
            overflow-y: auto;
            transition: transform var(--transition-normal);
        }
        
        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: var(--gray-900);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
            transition: all var(--transition-fast);
        }
        
        .sidebar-logo:hover {
            transform: scale(1.05);
            backdrop-filter: blur(10px);
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .sidebar-subtitle {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 2px;
        }
        
        /* Navigation */
        .nav-section {
            padding: var(--spacing-md) 0;
        }
        
        .nav-section-title {
            padding: 0 var(--spacing-lg);
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-sm);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--gray-600);
            text-decoration: none;
            transition: all 300ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            font-size: 14px;
            position: relative;
            will-change: transform, background-color;
        }
        
        .nav-item:hover {
            background: rgba(0, 0, 0, 0.03);
            color: var(--gray-900);
            backdrop-filter: blur(10px);
            transform: translateX(6px) scale(1.02);
        }
        
        .nav-item.active {
            background: rgba(0, 0, 0, 0.08);
            color: var(--gray-900);
            font-weight: 600;
            backdrop-filter: blur(10px);
            transform: translateX(8px) scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--gray-900);
        }
        
        /* PowerPoint-style navigation morphing */
        .nav-item.morphing {
            transform: scale(0.96);
            opacity: 0.7;
        }
        
        .nav-item-icon {
            width: 20px;
            height: 20px;
            margin-right: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .nav-item-text {
            flex: 1;
            font-weight: 500;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header */
        .main-header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-xl);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--gray-500);
            font-size: 14px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .worker-link {
            background: var(--primary-color);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .worker-link:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            padding: var(--spacing-xl);
            overflow-y: auto;
            transition: padding 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Dashboard Stats - Smooth Morphing System */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            transition: all 300ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            z-index: 10;
        }
        
        /* Subtle morphing state without repositioning */
        .stats-grid.morphing {
            opacity: 0.9;
            /* No transforms to prevent shaking */
        }
        
        /* Compact Dashboard Mode */
        .stats-grid.compact {
            height: 70px;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }
        
        /* Full Dashboard Mode (default) */
        .stats-grid.full {
            height: auto;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            padding: 0;
            background: transparent;
            border: none;
        }
        
        .stat-card {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            transition: all 300ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            /* Optimized for smooth morphing without layout shifts */
        }
        
        /* Compact Stat Card */
        .stats-grid.compact .stat-card {
            padding: 12px 16px;
            border-radius: 8px;
            min-height: 60px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }
        
        .stats-grid.compact .stat-card .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 0;
            gap: 8px;
        }
        
        .stats-grid.compact .stat-card .stat-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .stats-grid.compact .stat-card .stat-number {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-800);
            line-height: 1;
        }
        
        .stats-grid.compact .stat-card .stat-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        
        .stats-grid.compact .stat-card .stat-icon svg {
            width: 16px;
            height: 16px;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Contextual highlighting for active tab relevance */
        .stat-card.stat-highlighted {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }
        
        .stats-grid.compact .stat-card.stat-highlighted {
            background: var(--gray-50);
            border-color: var(--primary-color);
        }
        
        /* Compact dashboard hover effect */
        .stats-grid.compact {
            cursor: pointer;
            border-radius: 12px;
            transition: all 250ms ease;
        }
        
        .stats-grid.compact:hover {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-card[onclick] {
            cursor: pointer;
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-lg);
        }
        
        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .stat-icon::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.3));
        }
        
        .stat-icon.blue { 
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }
        .stat-icon.red { 
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }
        .stat-icon.green { 
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }
        .stat-icon.orange { 
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-800);
            line-height: 1.2;
            margin-bottom: var(--spacing-xs);
        }
        
        .stat-label {
            color: var(--gray-500);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: var(--spacing-md);
        }
        
        .stat-change {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 12px;
            font-weight: 500;
        }
        
        .stat-change.positive {
            color: var(--success-color);
        }
        
        .stat-change.negative {
            color: var(--danger-color);
        }
        
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: slideInMorph 400ms cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* PowerPoint-style morphing states - for outgoing tabs */
        .tab-content.morphing-out {
            animation: slideOutMorph 300ms cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* Cards and Components */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }
        
        /* Mini-chart container styling */
        .mini-chart-container {
            height: 120px !important;
            width: 100% !important;
            position: relative !important;
            overflow: hidden !important;
            margin-bottom: 8px !important;
        }
        
        .mini-chart-container canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        .card-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }
        
        .card-body {
            padding: var(--spacing-xl);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: var(--spacing-sm);
        }
        
        .section-subtitle {
            color: var(--gray-500);
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 14px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }
        
        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .btn-secondary:hover {
            background: var(--gray-200);
            color: var(--gray-800);
            backdrop-filter: blur(10px);
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--primary-color);
            transform: translateY(-1px);
            backdrop-filter: blur(10px);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-1px);
            backdrop-filter: blur(10px);
        }
        
        /* Mobile Responsiveness */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray-600);
            cursor: pointer;
            padding: var(--spacing-sm);
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }
        
        /* PWA Mobile Design - Tablet and Large Phones */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                width: var(--sidebar-width);
                height: 100vh;
                z-index: 100;
                overflow-y: auto;
                transform: translateX(-100%);
                transition: transform var(--transition-normal);
                box-shadow: var(--shadow-lg);
                background: white;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding-bottom: 80px; /* Space for bottom navigation on mobile */
            }
            
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 44px;
                min-height: 44px;
                border-radius: var(--radius-md);
                transition: background-color var(--transition-fast);
            }
            
            .mobile-menu-toggle:hover {
                background: var(--gray-100);
            }
            
            .mobile-overlay.open {
                display: block;
            }
            
            /* Improved navigation for touch devices */
            .nav-item {
                min-height: 48px;
                padding: var(--spacing-md) var(--spacing-lg);
                font-size: 16px;
                border-radius: 0;
                transition: all var(--transition-fast);
            }
            
            .nav-item:active {
                background: var(--gray-200);
                transform: scale(0.98);
            }
            
            .nav-item-icon svg {
                width: 24px;
                height: 24px;
            }
            
            /* Enhanced stats grid for tablets */
            .stats-grid.full {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: var(--spacing-md);
            }
            
            .stats-grid.compact {
                grid-template-columns: repeat(2, 1fr);
                height: auto;
                min-height: 100px;
                gap: var(--spacing-sm);
            }
            
            .stats-grid.compact .stat-card {
                min-height: 80px;
                padding: var(--spacing-md);
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            .stats-grid.compact .stat-card .stat-number {
                font-size: 18px;
                margin: var(--spacing-xs) 0;
            }
            
            .stats-grid.compact .stat-card .stat-label {
                font-size: 11px;
                margin-bottom: var(--spacing-xs);
            }
            
            .stat-card {
                padding: var(--spacing-lg);
                border-radius: var(--radius-lg);
            }
            
            .content-area {
                padding: var(--spacing-md);
            }
            
            /* Touch-friendly buttons */
            .btn {
                min-height: 44px;
                padding: var(--spacing-md) var(--spacing-lg);
                font-size: 16px;
                border-radius: var(--radius-md);
                transition: all var(--transition-fast);
            }
            
            .btn:active {
                transform: scale(0.98);
            }
            
            /* Improved header layout */
            .main-header {
                padding: var(--spacing-md) var(--spacing-lg);
                flex-wrap: wrap;
                gap: var(--spacing-md);
                min-height: 70px;
            }
            
            .header-actions {
                flex-wrap: wrap;
                gap: var(--spacing-sm);
            }
            
            /* Better tab navigation */
            .tab-headers {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .tab-headers::-webkit-scrollbar {
                display: none;
            }
            
            .tab-header {
                white-space: nowrap;
                flex-shrink: 0;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
        
        /* PWA Bottom Navigation for Mobile */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--gray-200);
            padding: var(--spacing-sm) 0 calc(var(--spacing-sm) + env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .bottom-nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 500px;
            margin: 0 auto;
            padding: 0 var(--spacing-md);
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            cursor: pointer;
            border: none;
            background: none;
            color: var(--gray-600);
            font-size: 11px;
            font-weight: 500;
            min-width: 60px;
            text-align: center;
        }
        
        .bottom-nav-item:active {
            transform: scale(0.95);
        }
        
        .bottom-nav-item.active {
            color: var(--gray-900);
            background: var(--gray-100);
        }
        
        .bottom-nav-item .nav-icon {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }
        
        .bottom-nav-item .nav-label {
            font-size: 10px;
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Mobile Phones - PWA Style */
        @media (max-width: 640px) {
            /* Hide desktop sidebar completely on mobile */
            .sidebar {
                display: none !important;
            }
            
            /* Show bottom navigation */
            .mobile-bottom-nav {
                display: block;
            }
            
            /* Full width main content on mobile */
            .main-content {
                width: 100vw;
                max-width: 100vw;
                margin: 0;
                padding: 0;
                overflow-x: hidden;
            }
            
            /* Mobile header adjustments */
            .main-header {
                padding: var(--spacing-sm) var(--spacing-md);
                min-height: 60px;
                background: white;
                border-bottom: 1px solid var(--gray-200);
                position: sticky;
                top: 0;
                z-index: 50;
                width: 100%;
                box-sizing: border-box;
            }
            
            .header-left {
                display: flex;
                align-items: center;
                gap: var(--spacing-md);
                width: 100%;
            }
            
            .mobile-menu-toggle {
                display: none; /* Hide hamburger since we have bottom nav */
            }
            
            .page-title {
                font-size: 18px;
                font-weight: 600;
                color: var(--gray-900);
                flex: 1;
            }
            
            .breadcrumb {
                display: none; /* Hide breadcrumb on mobile */
            }
            
            .header-actions {
                display: flex;
                gap: var(--spacing-sm);
                align-items: center;
            }
            
            .worker-link {
                display: none; /* Hide on mobile to save space */
            }
            
            .auth-status {
                font-size: 14px;
                padding: var(--spacing-sm) var(--spacing-md);
                min-height: 36px;
                border-radius: var(--radius-md);
                background: var(--gray-100);
                border: none;
                color: var(--gray-700);
            }
            /* Single column layout for stats */
            .stats-grid.full {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
            
            .stats-grid.compact {
                grid-template-columns: 1fr;
                height: auto;
                gap: var(--spacing-sm);
            }
            
            .stats-grid.compact .stat-card {
                min-height: 70px;
                padding: var(--spacing-md);
                display: flex;
                align-items: center;
                justify-content: space-between;
                border-radius: var(--radius-lg);
            }
            
            .stats-grid.compact .stat-card .stat-content {
                display: flex;
                flex-direction: column;
                flex: 1;
            }
            
            .stats-grid.compact .stat-card .stat-icon {
                width: 32px;
                height: 32px;
                flex-shrink: 0;
                margin-left: var(--spacing-md);
            }
            
            .stats-grid.compact .stat-card .stat-number {
                font-size: 20px;
                font-weight: 700;
                line-height: 1;
            }
            
            .stats-grid.compact .stat-card .stat-label {
                font-size: 12px;
                margin-top: var(--spacing-xs);
            }
            
            /* Mobile header optimization */
            .main-header {
                padding: var(--spacing-sm) var(--spacing-md);
                min-height: 60px;
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-left {
                display: flex;
                align-items: center;
                gap: var(--spacing-md);
                margin-bottom: var(--spacing-sm);
            }
            
            .page-title {
                font-size: 20px;
                line-height: 1.2;
                margin: 0;
            }
            
            .breadcrumb {
                font-size: 12px;
                color: var(--gray-500);
                margin-top: 2px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: flex-start;
                gap: var(--spacing-sm);
            }
            
            .worker-link {
                font-size: 14px;
                padding: var(--spacing-sm) var(--spacing-md);
                min-height: 36px;
                border-radius: var(--radius-md);
            }
            
            .auth-status {
                font-size: 14px;
                padding: var(--spacing-sm) var(--spacing-md);
                min-height: 36px;
            }
            
            /* Mobile content area */
            .content-area {
                padding: var(--spacing-md);
                width: 100%;
                max-width: 100%;
                margin: 0;
            }
            
            .stat-number {
                font-size: 24px;
                font-weight: 700;
            }
            
            .stat-label {
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--gray-600);
            }
            
            /* Mobile tab improvements */
            .tab-headers {
                padding: var(--spacing-xs);
                margin: 0 -var(--spacing-md) var(--spacing-lg) -var(--spacing-md);
                border-radius: 0;
            }
            
            .tab-header {
                padding: var(--spacing-md) var(--spacing-lg);
                font-size: 14px;
                font-weight: 500;
                border-radius: var(--radius-md);
                margin: 0 var(--spacing-xs);
            }
            
            .tab-header.active {
                background: var(--gray-900);
                color: white;
                font-weight: 600;
            }
            
            /* Mobile table improvements */
            .table-container {
                margin: 0 -var(--spacing-md);
                border-radius: 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table {
                min-width: 500px;
                margin: 0;
            }
            
            .table th,
            .table td {
                padding: var(--spacing-md);
                font-size: 14px;
                white-space: nowrap;
            }
            
            .table th {
                position: sticky;
                top: 0;
                background: var(--gray-50);
                z-index: 10;
            }
            
            /* Mobile form improvements */
            .form-row {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            
            .form-group {
                margin-bottom: var(--spacing-lg);
            }
            
            .form-control {
                min-height: 44px;
                font-size: 16px; /* Prevent zoom on iOS */
                padding: var(--spacing-md);
                border-radius: var(--radius-md);
                border: 1px solid var(--gray-300);
            }
            
            .form-control:focus {
                outline: none;
                border-color: var(--gray-900);
                box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
            }
            
            /* Mobile button improvements */
            .btn {
                min-height: 44px;
                font-size: 16px;
                padding: var(--spacing-md) var(--spacing-lg);
                border-radius: var(--radius-md);
                font-weight: 500;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                touch-action: manipulation;
            }
            
            .btn-sm {
                min-height: 36px;
                font-size: 14px;
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            /* Mobile modal improvements */
            .modal {
                padding: var(--spacing-md);
            }
            
            .modal-content {
                max-width: 100%;
                margin: 0;
                border-radius: var(--radius-lg);
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-header {
                padding: var(--spacing-lg);
                border-bottom: 1px solid var(--gray-200);
            }
            
            .modal-body {
                padding: var(--spacing-lg);
            }
            
            .modal-footer {
                padding: var(--spacing-lg);
                border-top: 1px solid var(--gray-200);
                display: flex;
                gap: var(--spacing-md);
                justify-content: flex-end;
            }
            
            /* Mobile alert improvements */
            .alert {
                margin: var(--spacing-md) 0;
                padding: var(--spacing-lg);
                border-radius: var(--radius-md);
                font-size: 14px;
                line-height: 1.5;
            }
            
            /* Mobile status badges */
            .status-badge {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 12px;
                border-radius: var(--radius-sm);
                display: inline-block;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            /* Mobile dashboard improvements */
            .dashboard-card {
                margin-bottom: var(--spacing-lg);
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: var(--shadow-sm);
            }
            
            .dashboard-card-header {
                padding: var(--spacing-lg);
                border-bottom: 1px solid var(--gray-200);
                background: white;
            }
            
            .dashboard-card-body {
                padding: var(--spacing-lg);
                background: white;
            }
            
            /* Improved touch targets */
            .nav-item,
            .tab-header,
            .btn,
            .mobile-menu-toggle {
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                touch-action: manipulation;
                user-select: none;
            }
            
            /* Mobile menu grid - optimized for better mobile experience */
            .mobile-menu-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-md);
                padding: var(--spacing-md) 0;
                max-height: 60vh;
                overflow-y: auto;
            }
            
            .mobile-menu-option {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: var(--spacing-xs);
                padding: var(--spacing-md);
                border: 1px solid var(--gray-200);
                border-radius: var(--radius-md);
                background: white;
                color: var(--gray-700);
                text-decoration: none;
                cursor: pointer;
                transition: all var(--transition-fast);
                min-height: 70px;
                justify-content: center;
                touch-action: manipulation;
            }
            
            .mobile-menu-option:hover,
            .mobile-menu-option:active {
                background: var(--primary-color);
                border-color: var(--primary-color);
                color: white;
                transform: scale(0.95);
            }
            
            .mobile-menu-option svg {
                width: 24px;
                height: 24px;
                color: currentColor;
                transition: color var(--transition-fast);
            }
            
            .mobile-menu-option span {
                font-size: 11px;
                font-weight: 500;
                text-align: center;
                line-height: 1.2;
            }
            
            /* Loading states for mobile */
            .loading {
                opacity: 0.6;
                pointer-events: none;
                position: relative;
            }
            
            .loading::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 20px;
                height: 20px;
                border: 2px solid var(--gray-300);
                border-radius: 50%;
                border-top-color: var(--gray-900);
                animation: spin 1s linear infinite;
                transform: translate(-50%, -50%);
            }
            
            @keyframes spin {
                to {
                    transform: translate(-50%, -50%) rotate(360deg);
                }
            }
            
            /* PPE Inventory Mobile Optimizations */
            #ppe-inventory-tab {
                padding-bottom: 120px !important; /* Extra space above bottom nav */
            }
            
            .ppe-sub-section {
                margin-bottom: 100px !important; /* Ensure content doesn't get cut off */
            }
            
            .ppe-sub-section:last-child {
                padding-bottom: 40px !important; /* Additional padding for last section */
            }
            
            /* Table container mobile optimization */
            .ppe-sub-section .table-container {
                margin-bottom: 60px !important;
                max-height: calc(100vh - 300px) !important; /* Prevent table from being too tall */
                overflow-y: auto !important;
            }
            
            /* Inventory grid mobile optimization */
            #inventoryGrid {
                margin-bottom: 80px !important;
                padding-bottom: 40px !important;
            }
            
            /* Sub-tab buttons mobile spacing */
            .sub-tab-button {
                padding: 12px 16px !important;
                font-size: 14px !important;
                margin-bottom: 20px !important;
            }
            
            /* Action buttons mobile spacing */
            .ppe-sub-section > div:first-child {
                margin-bottom: 30px !important;
                flex-wrap: wrap !important;
            }
            
            .ppe-sub-section > div:first-child button {
                margin-bottom: 10px !important;
            }
            
            /* Search box mobile spacing */
            .search-box {
                margin-bottom: 25px !important;
            }
        }
        
        /* Extra small devices optimization */
        @media (max-width: 480px) {
            .stats-grid.compact .stat-card {
                min-height: 60px;
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .stats-grid.compact .stat-card .stat-number {
                font-size: 18px;
            }
            
            .stats-grid.compact .stat-card .stat-label {
                font-size: 11px;
            }
            
            .main-header {
                padding: var(--spacing-sm);
            }
            
            .content-area {
                padding: var(--spacing-sm);
            }
            
            .btn {
                font-size: 14px;
                padding: var(--spacing-sm) var(--spacing-md);
                min-height: 40px;
            }
            
            .tab-header {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 13px;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .nav-item {
                font-size: 15px;
                min-height: 44px;
            }
        }
        
        /* Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }
        
        @keyframes modalFadeOut {
            from {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
            to {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
        }
        
        @keyframes tabFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes tabFadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        .animate-slide-up {
            animation: slideInUp 0.3s ease-out;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.2s ease-out;
        }
        
        /* Enhanced tab content animations */
        .tab-content {
            animation: tabFadeIn 0.4s ease-out;
        }
        
        .tab-content.hiding {
            animation: tabFadeOut 0.3s ease-in;
        }
        
        /* Modal closing animation */
        .modal.closing {
            animation: modalFadeOut 0.3s ease-out forwards;
        }
        
        /* PowerPoint-style morphing keyframes */
        @keyframes slideInMorph {
            0% {
                opacity: 0;
                transform: translateX(25px) scale(0.97);
            }
            60% {
                opacity: 0.8;
                transform: translateX(5px) scale(0.99);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        @keyframes slideOutMorph {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(-25px) scale(0.97);
            }
        }
        
        /* PowerPoint-style loading bar */
        @keyframes loadingBar {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Enhanced mobile morphing */
        @keyframes slideInMorphMobile {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Synchronized card animation to prevent shaking */
        .stats-grid.morphing .stat-card {
            opacity: 0.8;
            transition-delay: 0ms; /* All cards animate together */
        }
        
        /* Smooth content area transition without movement */
        .content-area.morphing {
            position: relative;
            /* Removed translateY and loading bar to prevent shaking */
        }
        
        /* Enhanced mobile morphing */
        @media (max-width: 768px) {
            .tab-content.morphing-in {
                animation: slideInMorphMobile 350ms cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            }

            /* Mobile Chart Fixes */
            #analyticsModal .modal-content {
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 95vh !important;
                margin: 2.5vh auto !important;
            }

            #analyticsChartContainer {
                padding: 15px !important;
                height: 60vh !important;
                min-height: 300px !important;
            }

            #analyticsChart {
                width: 100% !important;
                height: 100% !important;
                max-width: 100% !important;
                max-height: 100% !important;
            }

            /* Mini chart grid mobile responsive */
            .reports-container div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }

            /* Chart control buttons mobile */
            #chartControls div[style*="display: flex"] {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 12px !important;
            }

            #analyticsModal select,
            #analyticsModal button {
                width: 100% !important;
                text-align: center !important;
            }
        }

        /* Extra mobile optimization for very small screens */
        @media (max-width: 480px) {
            #analyticsModal .modal-content {
                width: 98vw !important;
                max-width: 98vw !important;
                height: 95vh !important;
                max-height: 95vh !important;
                margin: 2.5vh auto !important;
            }

            #analyticsChartContainer {
                padding: 10px !important;
                height: 50vh !important;
                min-height: 250px !important;
            }

            .mini-chart-container {
                height: 180px !important;
            }

            /* Make chart cards more mobile friendly */
            .reports-container div[onclick*="openAnalyticsChart"] {
                padding: 16px !important;
                margin-bottom: 12px !important;
            }

            .reports-container h4 {
                font-size: 16px !important;
                flex-wrap: wrap !important;
            }

            .reports-container h4 span {
                display: block !important;
                margin-top: 4px !important;
            }
        }
        
        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1f2937;
        }
        
        .approval-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            background: white;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .btn-primary:hover {
            background: #219a52;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-modal.hidden {
            display: none;
        }
        
        /* Generic Modal Styles with fade effects */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            opacity: 0;
            animation: modalFadeIn 0.3s ease-out forwards;
            align-items: center;
            z-index: 10000;
        }
        
        .modal.hidden {
            display: none !important;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            color: #6b7280;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            color: #dc2626;
            background: #fee2e2;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        /* Sub-tab buttons for PPE & Inventory */
        .sub-tab-button {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        
        .sub-tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .sub-tab-button:hover {
            color: var(--primary-color);
            background: rgba(0, 0, 0, 0.02);
            backdrop-filter: blur(10px);
            transform: translateY(-1px);
        }
        
        .ppe-sub-section {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .refreshing {
            animation: spin 1s linear infinite;
        }
        
        .dashboard-content {
            opacity: 0.3;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .dashboard-content.authenticated {
            opacity: 1;
            pointer-events: auto;
        }
        
        .alert-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .alert-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #f59e0b;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .alert-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .alert-card.critical {
            border-left-color: #dc2626;
        }
        
        .alert-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .alert-title {
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .alert-severity {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }
        
        .alert-severity.critical {
            background: #dc2626;
        }
        
        .alert-severity.warning {
            background: #f59e0b;
        }
        
        .alert-info {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .threshold-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .threshold-table-container {
            overflow-x: auto;
        }
        
        .threshold-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .threshold-table th,
        .threshold-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .threshold-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .threshold-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .threshold-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }
        
        .stock-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }
        
        .stock-status.good {
            background: var(--primary-color);
        }
        
        .stock-status.low {
            background: #f59e0b;
        }
        
        .stock-status.critical {
            background: #dc2626;
        }
        
        .login-form {
            background: white;
            padding: 32px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
            color: #1f2937;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .auth-status {
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 15000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .toast.success { background: var(--primary-color); }
        .toast.error { background: #dc2626; }
        .toast.warning { background: #f59e0b; }
        .toast.info { background: #3b82f6; }
        .toast.show { opacity: 1; }
        
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        
        .inventory-table th,
        .inventory-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .inventory-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            position: relative;
        }
        
        .sortable-table th {
            user-select: none;
        }
        
        .sortable-table th:hover {
            background: #f3f4f6;
        }
        
        .sort-indicator {
            margin-left: 5px;
            font-size: 12px;
            opacity: 0.5;
        }
        
        .sort-indicator.active {
            opacity: 1;
        }
        
        .status-good { color: var(--primary-color); }
        .status-low { color: #f59e0b; }
        .status-out { color: #dc2626; }
        
        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        /* Reports Sub-sections */
        .reports-sub-section {
            min-height: 400px;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileSidebar()"></div>
        
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">🛡️</div>
                <div>
                    <div class="sidebar-title">PPE Manager</div>
                    <div class="sidebar-subtitle">Admin Dashboard</div>
                </div>
            </div>
            
            <!-- Navigation Menu -->
            <nav class="nav-section">
                <div class="nav-section-title">Overview</div>
                <button class="nav-item active" onclick="switchTab('dashboard')" data-tab="dashboard">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="9"/>
                            <rect x="14" y="3" width="7" height="5"/>
                            <rect x="14" y="12" width="7" height="9"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">Dashboard</div>
                </button>
            </nav>
            
            <nav class="nav-section">
                <div class="nav-section-title">PPE Management</div>
                <button class="nav-item" onclick="switchTab('pending-approvals')" data-tab="pending-approvals">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2l4-4"/>
                            <circle cx="12" cy="12" r="9"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">Pending Approvals</div>
                </button>
                <button class="nav-item" onclick="switchTab('condition-reports')" data-tab="condition-reports">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">Condition Reports</div>
                </button>
                <button class="nav-item" onclick="switchTab('ppe-inventory')" data-tab="ppe-inventory">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">PPE & Inventory</div>
                </button>
                <button class="nav-item" onclick="switchTab('stock-alerts')" data-tab="stock-alerts">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">Stock Alerts</div>
                </button>
            </nav>
            
            <nav class="nav-section">
                <div class="nav-section-title">Administration</div>
                <button class="nav-item" onclick="switchTab('station-management')" data-tab="station-management">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7l9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9,22 9,12 15,12 15,22"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">Station Management</div>
                </button>
                <button class="nav-item" onclick="switchTab('staff-management')" data-tab="staff-management">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">Staff Management</div>
                </button>
                <button class="nav-item" onclick="switchTab('features')" data-tab="features">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83a2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33a1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2a2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2a2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83a2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2a2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0a2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2a2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">System Settings</div>
                </button>
            </nav>
            
            <nav class="nav-section">
                <div class="nav-section-title">Communications</div>
                <button class="nav-item" onclick="switchTab('email-config')" data-tab="email-config">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">Email Settings</div>
                </button>
                <button class="nav-item" onclick="switchTab('reports')" data-tab="reports">
                    <div class="nav-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 20V10"/>
                            <path d="M12 20V4"/>
                            <path d="M6 20v-6"/>
                        </svg>
                    </div>
                    <div class="nav-item-text">Reports</div>
                </button>
            </nav>
            
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="mobile-menu-toggle" onclick="toggleMobileSidebar()">☰</button>
                    <h1 class="page-title">Dashboard</h1>
                    <div class="breadcrumb">
                        <span>Admin</span>
                        <span>›</span>
                        <span id="currentPageTitle">Dashboard</span>
                    </div>
                </div>
                <div class="header-actions">
                    <a href="worker.html" class="worker-link">
                        <span>👷</span>
                        Worker Interface
                    </a>
                    <button id="authStatus" class="auth-status">🔓 Login</button>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="content-area" id="contentArea">
                <!-- Dashboard Content - Requires Authentication -->
                <div class="dashboard-content">
                    <!-- Dashboard Stats -->
            <div class="stats-grid full" id="dashboardStats">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Total Stock</div>
                        <div class="stat-number" id="totalStock">0</div>
                    </div>
                    <div class="stat-icon blue">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Low Stock Items</div>
                        <div class="stat-number" id="lowStock">0</div>
                    </div>
                    <div class="stat-icon red">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Daily PPE Issued</div>
                        <div class="stat-number" id="dailyIssued">0</div>
                    </div>
                    <div class="stat-icon green">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 20V10"/>
                            <path d="M12 20V4"/>
                            <path d="M6 20v-6"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card" onclick="switchTab('pending-approvals')" style="cursor: pointer;">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Pending Approvals</div>
                        <div class="stat-number" id="pendingApprovals">0</div>
                    </div>
                    <div class="stat-icon red">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2l4-4"/>
                            <circle cx="12" cy="12" r="9"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Management Tabs -->
        <div class="inventory-section">
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="card">
                    <h3 class="section-title">📊 Dashboard Overview</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Comprehensive overview of your PPE management system</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-top: 32px;">
                        <!-- Quick Actions Panel -->
                        <div class="card" style="background: var(--gray-50); border: 2px dashed var(--gray-300); padding: 24px;">
                            <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--gray-800);">⚡ Quick Actions</h4>
                            <div style="display: grid; gap: 12px;">
                                <button class="btn-secondary" onclick="switchTab('pending-approvals')" style="text-align: left; justify-content: flex-start; gap: 12px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 12l2 2l4-4"/>
                                        <circle cx="12" cy="12" r="9"/>
                                    </svg>
                                    Review Pending Approvals
                                </button>
                                <button class="btn-secondary" onclick="switchTab('ppe-inventory')" style="text-align: left; justify-content: flex-start; gap: 12px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                    </svg>
                                    Manage PPE Inventory
                                </button>
                                <button class="btn-secondary" onclick="switchTab('stock-alerts')" style="text-align: left; justify-content: flex-start; gap: 12px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                    Check Stock Alerts
                                </button>
                                <button class="btn-secondary" onclick="switchTab('reports')" style="text-align: left; justify-content: flex-start; gap: 12px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 17H7A5 5 0 0 1 7 7h2m0 10a5 5 0 0 0 10 0V7a5 5 0 0 0-10 0m0 10V7"/>
                                    </svg>
                                    View Reports & Analytics
                                </button>
                            </div>
                        </div>
                        
                        <!-- System Status Panel -->
                        <div class="card" style="padding: 24px;">
                            <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--gray-800);">🔧 System Status</h4>
                            <div style="display: grid; gap: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--gray-800);">Database Status</div>
                                        <div style="font-size: 12px; color: var(--gray-600);">Connection healthy</div>
                                    </div>
                                    <div style="width: 8px; height: 8px; background: #10B981; border-radius: 50%;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--gray-800);">Email Notifications</div>
                                        <div style="font-size: 12px; color: var(--gray-600);">SMTP configured</div>
                                    </div>
                                    <div style="width: 8px; height: 8px; background: #10B981; border-radius: 50%;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                                    <div>
                                        <div style="font-weight: 500; color: var(--gray-800);">License Status</div>
                                        <div style="font-size: 12px; color: var(--gray-600);">Enterprise active</div>
                                    </div>
                                    <div style="width: 8px; height: 8px; background: #10B981; border-radius: 50%;"></div>
                                </div>
                            </div>
                            <button class="btn-secondary" onclick="switchTab('features')" style="margin-top: 16px; width: 100%;">
                                View License Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pending Approvals Tab -->
            <div id="pending-approvals-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-title">Pending PPE Approvals</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Review and approve PPE requests from staff members</p>
                    
                    <div id="pendingApprovalsContent">
                        <div id="pendingApprovalsList">
                            <p style="text-align: center; padding: 40px; color: #6b7280;">Loading pending approvals...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Condition Reports Tab -->
            <div id="condition-reports-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-title">🔧 PPE Condition Reports</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Review and manage PPE condition reports from staff members</p>
                    
                    <!-- Filter Controls -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="conditionReportStatusFilter" onchange="loadConditionReports()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <option value="all">All Status</option>
                            <option value="reported">Reported</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="dismissed">Dismissed</option>
                        </select>
                        <button class="btn-secondary" onclick="loadConditionReports()">🔄 Refresh</button>
                    </div>
                    
                    <div id="conditionReportsContent">
                        <div id="conditionReportsList">
                            <p style="text-align: center; padding: 40px; color: #6b7280;">Loading condition reports...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PPE & Inventory Management Tab -->
            <div id="ppe-inventory-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-title">📦 PPE & Inventory Management</h3>
                    <p style="color: #6b7280; margin-bottom: 24px;">Manage PPE types, costs, and inventory stock levels in one place</p>
                    
                    <!-- Sub-navigation for PPE & Inventory sections -->
                    <div style="border-bottom: 1px solid #e5e7eb; margin-bottom: 24px;">
                        <div style="display: flex; gap: 4px;">
                            <button id="ppeTypesSubTab" class="sub-tab-button active" onclick="switchPPESubTab('types')">🛡️ PPE Types</button>
                            <button id="stockLevelsSubTab" class="sub-tab-button" onclick="switchPPESubTab('stock')">📊 Stock Levels</button>
                        </div>
                    </div>
                    
                    <!-- PPE Types Section -->
                    <div id="ppeTypesSection" class="ppe-sub-section">
                        <div style="display: flex; gap: 16px; margin-bottom: 20px; align-items: center;">
                            <button class="btn-primary" onclick="showAddPPEModal()">➕ Add New PPE Type</button>
                            <button class="btn-secondary" onclick="refreshPPEList()">🔄 Refresh List</button>
                            <span style="color: #6b7280; font-size: 14px;">Define PPE types with emoji icons, costs, and inventory thresholds</span>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th>Unit Cost</th>
                                        <th>Min Threshold</th>
                                        <th>Critical Threshold</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ppeTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">Loading PPE types...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Stock Levels Section -->
                    <div id="stockLevelsSection" class="ppe-sub-section" style="display: none;">
                        <div style="display: flex; gap: 16px; margin-bottom: 20px; align-items: center;">
                            <button class="btn-primary" onclick="showStockUpdateModal()">📦 Update Stock</button>
                            <button class="btn-secondary" onclick="refreshStockLevels()">🔄 Refresh</button>
                            <span style="color: #6b7280; font-size: 14px;">Manage inventory quantities at different stations</span>
                        </div>
                        
                        <div class="search-box" style="margin-bottom: 16px;">
                            <input type="text" id="inventorySearch" placeholder="🔍 Search inventory by item or station..." oninput="filterInventory()">
                        </div>
                        
                        <div class="table-container">
                            <table class="inventory-table sortable-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable(0, 'inventoryTableBody')" style="cursor: pointer;">PPE Item <span class="sort-indicator">↕️</span></th>
                                        <th onclick="sortTable(1, 'inventoryTableBody')" style="cursor: pointer;">Station <span class="sort-indicator">↕️</span></th>
                                        <th onclick="sortTable(2, 'inventoryTableBody', 'number')" style="cursor: pointer;">Current Stock <span class="sort-indicator">↕️</span></th>
                                        <th onclick="sortTable(3, 'inventoryTableBody', 'number')" style="cursor: pointer;">Capacity <span class="sort-indicator">↕️</span></th>
                                        <th onclick="sortTable(4, 'inventoryTableBody')" style="cursor: pointer;">Status <span class="sort-indicator">↕️</span></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">Loading inventory...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stock Alerts Tab -->
            <div id="stock-alerts-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-title">🚨 Stock Alerts</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Monitor and manage low stock alerts</p>
                    
                    <div class="alert-controls">
                        <button class="btn-secondary" onclick="refreshAlerts()">🔄 Refresh</button>
                        <button class="btn-primary" onclick="acknowledgeAllAlerts()">✅ Acknowledge All</button>
                    </div>
                    
                    <div id="stockAlertsContent">
                        <div class="loading-spinner" style="text-align: center; padding: 40px;">
                            <div style="color: #6b7280;">Loading alerts...</div>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- Station Management Tab -->
            <div id="station-management-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-title">🏢 Station Management</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Configure locations where PPE can be distributed and managed</p>
                    
                    <!-- Station Setup Status -->
                    <div id="stationSetupStatus" style="margin-bottom: 20px;"></div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <button class="btn-primary" onclick="showAddStation()">➕ Add New Station</button>
                        <button class="btn-secondary" onclick="refreshStationList()">🔄 Refresh List</button>
                        <button class="btn-secondary" onclick="generateQRCodes()">📱 Generate QR Codes</button>
                    </div>
                    
                    <!-- Add Station Form -->
                    <div id="addStationForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #374151;">Add New Station</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Station ID *</label>
                                <input type="text" id="stationId" placeholder="e.g., store-1, warehouse-main" 
                                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <small style="color: #6b7280;">Unique identifier (letters, numbers, hyphens only)</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Station Name *</label>
                                <input type="text" id="stationName" placeholder="e.g., Main Store, Warehouse 1" 
                                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Location *</label>
                                <input type="text" id="stationLocation" placeholder="e.g., Building A, Floor 1" 
                                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description</label>
                                <input type="text" id="stationDescription" placeholder="Optional description" 
                                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn-primary" onclick="addStation()">✅ Create Station</button>
                            <button class="btn-secondary" onclick="hideAddStation()">❌ Cancel</button>
                        </div>
                    </div>
                    
                    <!-- Stations List -->
                    <div id="stationsList" style="margin-top: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #374151;">Configured Stations</h4>
                        <div id="stationsContent">Loading stations...</div>
                    </div>
                </div>
            </div>

            <!-- Staff Management Tab -->
            <div id="staff-management-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-title">👥 Staff Management</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Manage staff directory for PPE request validation</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <button class="btn-primary" onclick="downloadStaffTemplate()">📄 Download Excel Template</button>
                        <button class="btn-primary" onclick="showStaffImport()">📤 Import Staff File</button>
                        <button class="btn-secondary" onclick="showAddStaff()">➕ Add Single Staff</button>
                        <button class="btn-secondary" onclick="refreshStaffList()">🔄 Refresh List</button>
                    </div>
                    
                    <!-- Staff Filtering and Management Controls -->
                    <div style="display: flex; gap: 16px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label style="font-weight: 500; color: #374151;">Filter:</label>
                            <select id="staffStatusFilter" onchange="filterStaffByStatus()" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white;">
                                <option value="all">All Staff</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Inactive Only</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="staffSearchInput" placeholder="🔍 Search by name or ID..." 
                                   style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; min-width: 200px;"
                                   oninput="filterStaffBySearch()">
                        </div>
                        
                        <div style="margin-left: auto; display: flex; gap: 8px;">
                            <button class="btn-danger" onclick="bulkDeleteInactiveStaff()" id="bulkDeleteBtn" style="font-size: 12px;">
                                🗑️ Delete All Inactive
                            </button>
                            <span id="staffFilterInfo" style="color: #6b7280; font-size: 14px; font-weight: 500;"></span>
                        </div>
                    </div>
                    
                    <!-- File Upload Modal -->
                    <div id="staffImportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; min-width: 400px; max-width: 600px;">
                            <h3 style="margin-bottom: 20px;">📤 Import Staff File</h3>
                            <p style="color: #6b7280; margin-bottom: 20px;">Upload Excel (.xlsx, .xls) or CSV file with staff information</p>
                            
                            <div style="border: 2px dashed #d1d5db; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 8px;">
                                <input type="file" id="staffFileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileSelect(event)">
                                <button onclick="document.getElementById('staffFileInput').click()" class="btn-secondary">
                                    📁 Choose File
                                </button>
                                <p style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                                    <span id="selectedFileName">No file selected</span>
                                </p>
                            </div>
                            
                            <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <p style="margin: 0; font-size: 14px; color: #374151;">
                                    <strong>Required columns:</strong> staff_id, name<br>
                                    <strong>Optional columns:</strong> email, department, position
                                </p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button onclick="closeStaffImportModal()" class="btn-secondary">Cancel</button>
                                <button onclick="uploadStaffFile()" class="btn-primary" id="uploadStaffBtn" disabled>Upload & Import</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="staffStatsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <!-- Staff stats will be loaded here -->
                    </div>
                    
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Staff ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Position</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staffTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                                        Loading staff directory...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Features Tab -->
            <div id="features-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-title">🔧 Features & Subscription</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Manage your subscription and view available features</p>
                    
                    <div id="featuresContent">
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            Loading features...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Email Settings Tab -->
            <div id="email-config-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-title">📧 Email Notification Settings</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Configure SMTP settings and notification preferences (Pro Feature)</p>
                    
                    <div class="email-config-container">
                        <!-- SMTP Configuration Section -->
                        <div class="email-section" style="margin-bottom: 24px;">
                            <div class="collapsible-header" onclick="toggleEmailSection('smtp')" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; user-select: none;">
                                <span id="smtp-arrow" style="transition: transform 0.2s; transform: rotate(-90deg);">▼</span>
                                <h4 style="margin: 0; flex: 1;">⚙️ SMTP Configuration</h4>
                                <button id="testEmailBtn" class="btn-secondary" onclick="event.stopPropagation(); testEmailConfiguration()" style="font-size: 12px; padding: 4px 8px;">
                                    📤 Test Email
                                </button>
                            </div>
                            <div id="smtp-content" class="collapsible-content" style="margin-top: 8px; padding: 16px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; display: none;">
                            
                            <div style="display: grid; gap: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">SMTP Host *</label>
                                        <input type="text" id="smtpHost" placeholder="smtp.gmail.com" 
                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">SMTP Port *</label>
                                        <input type="number" id="smtpPort" placeholder="587" 
                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email Username *</label>
                                        <input type="email" id="smtpUser" placeholder="your-email@gmail.com" 
                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email Password *</label>
                                        <div style="position: relative;">
                                            <input type="password" id="smtpPass" placeholder="your-app-password" 
                                                   style="width: 100%; padding: 8px 40px 8px 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                            <button type="button" id="togglePassword" onclick="togglePasswordVisibility()" 
                                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 4px; color: #6b7280;"
                                                    title="Show password">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">From Address *</label>
                                        <input type="email" id="smtpFrom" placeholder="PPE System <noreply@company.com>" 
                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Company Name</label>
                                        <input type="text" id="companyName" placeholder="PPE Management System" 
                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                            <input type="checkbox" id="smtpSecure" style="margin: 0;">
                                            Use TLS/SSL Security
                                        </label>
                                    </div>
                                    <div>
                                        <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                            <input type="checkbox" id="emailEnabled" style="margin: 0;" checked>
                                            Enable Email Notifications
                                        </label>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Test Email Address</label>
                                    <input type="email" id="testEmail" placeholder="admin@company.com" 
                                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <small style="color: #6b7280;">Email address to use for testing configuration</small>
                                </div>
                                
                                <div style="display: flex; gap: 12px; margin-top: 16px;">
                                    <button class="btn-primary" onclick="saveEmailConfiguration()">💾 Save SMTP Settings</button>
                                    <button class="btn-secondary" onclick="loadEmailConfiguration()">🔄 Reload</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notification Recipients Section -->
                        <div class="email-section" style="margin-bottom: 24px;">
                            <div class="collapsible-header" onclick="toggleEmailSection('recipients')" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; user-select: none;">
                                <span id="recipients-arrow" style="transition: transform 0.2s; transform: rotate(-90deg);">▼</span>
                                <h4 style="margin: 0; flex: 1;">📧 Notification Recipients</h4>
                                <span style="font-size: 12px; color: #6b7280;">Who receives notifications</span>
                            </div>
                            <div id="recipients-content" class="collapsible-content" style="margin-top: 8px; padding: 16px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; display: none;">
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Safety Officer Email</label>
                                        <input type="email" id="safetyOfficerEmail" placeholder="safety@yourcompany.com" 
                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <small style="color: #6b7280;">Receives new PPE request notifications</small>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Store Personnel Email</label>
                                        <input type="email" id="storePersonnelEmail" placeholder="store@yourcompany.com" 
                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <small style="color: #6b7280;">Receives approved PPE requests and stock alerts</small>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Admin Email</label>
                                        <input type="email" id="adminEmail" placeholder="admin@yourcompany.com" 
                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <small style="color: #6b7280;">Receives system alerts and reports</small>
                                    </div>
                                    <div style="display: flex; gap: 12px; margin-top: 8px;">
                                        <button class="btn-primary" onclick="saveEmailConfiguration()">💾 Save Recipients</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notification Preferences Section -->
                        <div class="email-section" style="margin-bottom: 24px;">
                            <div class="collapsible-header" onclick="toggleEmailSection('preferences')" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; user-select: none;">
                                <span id="preferences-arrow" style="transition: transform 0.2s; transform: rotate(-90deg);">▼</span>
                                <h4 style="margin: 0; flex: 1;">🔔 Notification Preferences</h4>
                                <span style="font-size: 12px; color: #6b7280;">What notifications to send</span>
                            </div>
                            <div id="preferences-content" class="collapsible-content" style="margin-top: 8px; padding: 16px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; display: none;">
                                <div id="notificationPreferences">
                                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                                        Loading notification preferences...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- END Email Config Tab -->
            <!-- Force close any unclosed divs -->
            </div></div></div>
            
            <!-- BEGIN Advanced Reports Tab - Ensure it's at root level -->
            <div id="reports-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-title">📊 Advanced Reports & Analytics</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Comprehensive reporting and data analytics for PPE usage (Enterprise subscription active)</p>
                    
                    <!-- Sub-navigation for Reports sections -->
                    <div style="border-bottom: 1px solid #e5e7eb; margin-bottom: 24px;">
                        <div style="display: flex; gap: 4px;">
                            <button id="reportsAnalyticsSubTab" class="sub-tab-button active" onclick="switchReportsSubTab('analytics')">📈 Analytics</button>
                            <button id="scheduledReportsSubTab" class="sub-tab-button" onclick="switchReportsSubTab('scheduled')">⏰ Scheduled Reports</button>
                        </div>
                    </div>
                    
                    <!-- Analytics Section -->
                    <div id="reportsAnalyticsSection" class="reports-sub-section">
                        <div id="reportsContent">
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                Loading reports...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scheduled Reports Section -->
                    <div id="scheduledReportsSection" class="reports-sub-section" style="display: none;">
                        <div style="display: flex; gap: 16px; margin-bottom: 20px; align-items: center;">
                            <button class="btn-primary" onclick="showAddScheduledReportModal()">➕ Schedule New Report</button>
                            <button class="btn-secondary" onclick="refreshScheduledReports()">🔄 Refresh</button>
                            <span style="color: #6b7280; font-size: 14px;">Automated report generation and email delivery</span>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Report Name</th>
                                        <th>Type</th>
                                        <th>Schedule</th>
                                        <th>Recipients</th>
                                        <th>Last Run</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduledReportsTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                            No scheduled reports found. Click "Schedule New Report" to get started.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add PPE Modal -->
            <div id="addPPEModal" class="modal-overlay" style="display: none;" onclick="closeAddPPEModal(event)">
                <div class="modal-content" style="max-width: 500px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1f2937;">➕ Add New PPE Type</h3>
                        <button onclick="closeAddPPEModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">PPE Name *</label>
                            <input type="text" id="ppeName" placeholder="e.g., Safety Shoes" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Type Code *</label>
                            <input type="text" id="ppeType" placeholder="e.g., SHOES" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Symbol *</label>
                            <input type="text" id="ppeSymbol" placeholder="e.g., 👞" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <small style="color: #6b7280;">Use emoji symbols (Windows: Win + . or Mac: Cmd + Control + Space)</small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description</label>
                            <textarea id="ppeDescription" placeholder="Brief description of the PPE item" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; height: 60px;"></textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Available at Stations *</label>
                            <div id="stationSelection" style="max-height: 120px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; background: #f9fafb;">
                                <div style="text-align: center; color: #6b7280; padding: 10px;">Loading stations...</div>
                            </div>
                            <small style="color: #6b7280;">Select which stations can request this PPE type</small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Unit Cost ($)</label>
                            <input type="number" id="ppeUnitCost" placeholder="e.g., 25.50" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <small style="color: #6b7280;">Cost per unit for budget tracking and analytics</small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Minimum Threshold</label>
                            <input type="number" id="ppeMinThreshold" value="10" min="1" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Initial Stock Quantity *</label>
                            <input type="number" id="ppeInitialStock" value="20" min="0" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <small style="color: #6b7280;">Initial inventory stock for the main store</small>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeAddPPEModal()" class="btn-secondary">Cancel</button>
                        <button onclick="addPPEType()" class="btn-primary">Add PPE Type</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div> <!-- End Dashboard Content -->

    <!-- Analytics Chart Modal -->
    <div id="analyticsModal" class="modal hidden" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; width: 1200px;">
            <div class="modal-header">
                <h2 id="analyticsModalTitle">📊 Professional Analytics</h2>
                <button onclick="closeAnalyticsModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="chartControls" style="padding: 20px; background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                        <select id="chartPeriod" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                        <button onclick="refreshChart()" class="btn-secondary">🔄 Refresh</button>
                        <button onclick="exportChart()" class="btn-primary">📤 Export Chart</button>
                    </div>
                </div>
                <div id="analyticsChartContainer" style="padding: 30px; background: white; position: relative;">
                    <canvas id="analyticsChart" style="width: 100%; height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal hidden">
        <div class="login-form">
            <h2 class="login-title">🔐 Admin Login</h2>
            <p style="color: #6b7280; margin-bottom: 24px; text-align: center;">Authentication required to access the admin dashboard</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Login</button>
            </form>
            <div style="text-align: center; margin-top: 16px;">
                <a href="/password-reset.html" style="color: #000000; font-size: 14px; text-decoration: none;">Forgot your password?</a>
            </div>
        </div>
    </div>

    <!-- Edit Staff Modal -->
    <div id="editStaffModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeEditStaffModal()">&times;</span>
            <h2>Edit Staff Member</h2>
            <form id="editStaffForm">
                <div class="form-group">
                    <label for="editStaffId">Staff ID</label>
                    <input type="text" id="editStaffId" readonly style="background-color: #f3f4f6;">
                </div>
                <div class="form-group">
                    <label for="editStaffName">Name *</label>
                    <input type="text" id="editStaffName" required>
                </div>
                <div class="form-group">
                    <label for="editStaffEmail">Email</label>
                    <input type="email" id="editStaffEmail">
                </div>
                <div class="form-group">
                    <label for="editStaffDepartment">Department</label>
                    <select id="editStaffDepartment">
                        <option value="">Select department...</option>
                        <!-- Departments loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="editStaffPosition">Position</label>
                    <input type="text" id="editStaffPosition">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeEditStaffModal()" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Staff</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Staff Modal -->
    <div id="addStaffModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAddStaffModal()">&times;</span>
            <h2>Add New Staff Member</h2>
            <form id="addStaffForm">
                <div class="form-group">
                    <label for="addStaffId">Staff ID *</label>
                    <input type="text" id="addStaffId" placeholder="e.g., EMP001" required>
                </div>
                <div class="form-group">
                    <label for="addStaffName">Name *</label>
                    <input type="text" id="addStaffName" required>
                </div>
                <div class="form-group">
                    <label for="addStaffEmail">Email</label>
                    <input type="email" id="addStaffEmail">
                </div>
                <div class="form-group">
                    <label for="addStaffDepartment">Department</label>
                    <select id="addStaffDepartment">
                        <option value="">Select department...</option>
                        <!-- Departments loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="addStaffPosition">Position</label>
                    <input type="text" id="addStaffPosition">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeAddStaffModal()" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Staff</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Universal Undefined Prevention Utilities
        function safeGet(obj, path, fallback = 'N/A') {
            if (!obj || typeof obj !== 'object') return fallback;
            
            // Handle dot notation paths (e.g., 'user.profile.name')
            const keys = Array.isArray(path) ? path : path.split('.');
            let current = obj;
            
            for (const key of keys) {
                if (current === null || current === undefined || typeof current !== 'object') {
                    return fallback;
                }
                current = current[key];
            }
            
            // Return fallback for null, undefined, empty string, or NaN
            return (current === null || current === undefined || current === '' || Number.isNaN(current)) 
                ? fallback 
                : current;
        }
        
        function safeText(element, text, fallback = 'Loading...') {
            if (element) {
                element.textContent = text !== undefined && text !== null && text !== '' ? text : fallback;
            }
        }
        
        function safeHTML(element, html, fallback = '<div>Loading...</div>') {
            if (element) {
                element.innerHTML = html !== undefined && html !== null && html !== '' ? html : fallback;
            }
        }
        
        function safeNumber(value, fallback = 0) {
            const num = Number(value);
            return isNaN(num) ? fallback : num;
        }
        
        function safeArray(value, fallback = []) {
            return Array.isArray(value) ? value : fallback;
        }
        
        // Global variables
        let isAuthenticated = false;
        let authToken = null;
        let currentUser = null;

        // Authentication
        document.getElementById('authStatus').addEventListener('click', function() {
            if (isAuthenticated) {
                if (confirm('Are you sure you want to logout?')) {
                    logout();
                }
            } else {
                showLoginModal();
            }
        });

        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.token;
                    currentUser = data.user;
                    isAuthenticated = true;
                    
                    // Clear any old cached data first to prevent stale info
                    localStorage.removeItem('ppe_auth_token');
                    localStorage.removeItem('ppe_user_data');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    
                    // Store fresh user data
                    localStorage.setItem('ppe_auth_token', authToken);
                    localStorage.setItem('ppe_user_data', JSON.stringify(currentUser));
                    
                    hideLoginModal();
                    updateAuthStatus(); // This will now use fresh currentUser data
                    showToast(`👋 Welcome back, ${currentUser.name}!`, 'success');
                    
                    // Load dashboard data
                    loadDashboardData();
                    loadPendingApprovals();
                } else {
                    showToast('❌ Invalid credentials', 'error');
                }
            } catch (error) {
                showToast('❌ Login failed', 'error');
            }
        });

        function confirmLogout(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
            return false;
        }

        function logout() {
            isAuthenticated = false;
            authToken = null;
            currentUser = null;
            
            // Clear authentication data
            localStorage.removeItem('ppe_auth_token');
            localStorage.removeItem('ppe_user_data');
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            
            updateAuthStatus();
            showToast('👋 Logged out successfully', 'success');
            
            // Redirect to main login page after logout
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
        }

        function updateAuthStatus() {
            const authBtn = document.getElementById('authStatus');
            const dashboardContent = document.querySelector('.dashboard-content');
            
            if (isAuthenticated) {
                // Show user name without company reference
                const displayName = currentUser.name || 'Admin';
                    
                authBtn.textContent = `👋 ${displayName}`;
                authBtn.style.background = 'var(--primary-color)';
                authBtn.onclick = (e) => confirmLogout(e);
                dashboardContent.classList.add('authenticated');
                
                // Update page title for license-based system
                document.title = `PPE Management - Admin Dashboard`;
            } else {
                authBtn.textContent = '🔓 Login';
                authBtn.style.background = '#6b7280';
                authBtn.onclick = showLoginModal;
                dashboardContent.classList.remove('authenticated');
            }
        }

        // Dynamic user validation - sync with database
        async function validateUserData() {
            const storedUser = localStorage.getItem('ppe_user_data') || localStorage.getItem('user');
            
            if (!storedUser) return; // No cached user, nothing to validate
            
            try {
                const userData = JSON.parse(storedUser);
                if (!userData.id) return; // No user ID to validate
                
                // Check if cached user still exists and matches database
                const response = await fetch(`/api/auth/validate-user/${userData.id}`);
                
                if (!response.ok || response.status === 404) {
                    // User doesn't exist anymore or changed - clear cache
                    console.log('🔄 User validation failed, clearing stale cache...');
                    localStorage.removeItem('ppe_auth_token');
                    localStorage.removeItem('ppe_user_data');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    return;
                }
                
                const dbUser = await response.json();
                
                // Check if user data has changed (name, email, etc.)
                if (dbUser.name !== userData.name || dbUser.email !== userData.email) {
                    console.log('🔄 User data changed, updating cache...');
                    localStorage.setItem('ppe_user_data', JSON.stringify(dbUser));
                }
                
            } catch (error) {
                console.warn('User validation failed:', error);
                // Clear cache on any validation error
                localStorage.removeItem('ppe_auth_token');
                localStorage.removeItem('ppe_user_data');
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
            }
        }

        // Check for stored auth
        function checkStoredAuth() {
            // Check for stored authentication token
            const storedToken = localStorage.getItem('ppe_auth_token') || localStorage.getItem('authToken');
            const storedUser = localStorage.getItem('ppe_user_data') || localStorage.getItem('user');
            
            if (storedToken && storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    
                    // Dynamic validation - check if data looks valid
                    if (!userData || !userData.name || !userData.email || !userData.id) {
                        console.warn('🔄 Cached user data invalid, clearing...');
                        localStorage.clear(); // Clear all localStorage for fresh start
                        return;
                    }
                    
                    // Check if user has admin role (for backward compatibility)
                    if (userData.role && userData.role === 'STAFF') {
                        alert('Staff users should use the Worker Interface. Redirecting...');
                        window.location.href = 'worker.html';
                        return;
                    }
                    
                    authToken = storedToken;
                    currentUser = userData;
                    isAuthenticated = true;
                    hideLoginModal(); // Hide the login modal
                    updateAuthStatus(); // Update the auth status
                    
                    // Load dashboard data
                    loadDashboardData();
                    loadPendingApprovals();
                    
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    // Clear invalid stored data
                    localStorage.removeItem('ppe_auth_token');
                    localStorage.removeItem('ppe_user_data');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                }
            }
        }

        // Tab Management
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // IMMEDIATE FALLBACK: Ensure tab switching works even if animation fails
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            const immediateTarget = document.getElementById(`${tabName}-tab`);
            if (immediateTarget) {
                immediateTarget.classList.add('active');
                immediateTarget.style.display = 'block';
            }
            
            // Close any open analytics modal when switching tabs
            const analyticsModal = document.getElementById('analyticsModal');
            if (analyticsModal && !analyticsModal.classList.contains('hidden')) {
                closeAnalyticsModal();
            }
            
            // Update navigation active states
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.tab === tabName) {
                    item.classList.add('active');
                }
            });
            
            // Update page title and breadcrumb
            const pageTitle = document.querySelector('.page-title');
            const currentPageTitle = document.getElementById('currentPageTitle');
            
            const pageTitles = {
                'pending-approvals': 'Pending Approvals',
                'condition-reports': 'Condition Reports',
                'station-management': 'Station Management',
                'ppe-inventory': 'PPE & Inventory',
                'stock-alerts': 'Stock Alerts',
                'staff-management': 'Staff Management',
                'features': 'System Settings',
                'email-config': 'Email Settings',
                'reports': 'Reports',
                'dashboard': 'Dashboard Overview'
            };
            
            if (pageTitles[tabName]) {
                if (pageTitle) pageTitle.textContent = pageTitles[tabName];
                if (currentPageTitle) currentPageTitle.textContent = pageTitles[tabName];
            }
            
            // Close mobile sidebar on tab switch
            if (typeof closeMobileSidebar === 'function') {
                closeMobileSidebar();
            }
            
            // Smooth coordinated morphing animation sequence
            const dashboardStats = document.getElementById('dashboardStats');
            const contentArea = document.getElementById('contentArea');
            const currentActiveTab = document.querySelector('.tab-content.active');
            const targetTab = document.getElementById(`${tabName}-tab`);
            
            // Start morphing sequence with coordinated timing
            if (dashboardStats) dashboardStats.classList.add('morphing');
            if (contentArea) contentArea.classList.add('morphing');
            
            // Update navigation states smoothly
            document.querySelectorAll('.nav-item').forEach(item => {
                if (!item.classList.contains('active')) {
                    item.classList.add('morphing');
                }
            });
            
            // Animate out current tab content smoothly
            if (currentActiveTab && currentActiveTab.id !== `${tabName}-tab`) {
                currentActiveTab.style.animation = 'slideOutMorph 250ms cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
                currentActiveTab.classList.add('morphing-out');
            }
            
            // Single coordinated timeout for all changes
            setTimeout(() => {
                // Dashboard morphing logic
                if (tabName === 'dashboard') {
                    if (dashboardStats) {
                        dashboardStats.classList.remove('compact');
                        dashboardStats.classList.add('full');
                    }
                } else {
                    if (dashboardStats) {
                        dashboardStats.classList.remove('full');
                        dashboardStats.classList.add('compact');
                        
                        // Add contextual highlighting immediately
                        highlightContextualStats(tabName);
                    }
                }
                
                // Tab content switching - all in one coordinated step
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active', 'morphing-out');
                    content.style.display = 'none';
                });
                
                if (targetTab) {
                    targetTab.style.display = 'block';
                    targetTab.classList.add('active');
                }
                
                // Clean up all morphing states together
                if (dashboardStats) dashboardStats.classList.remove('morphing');
                if (contentArea) contentArea.classList.remove('morphing');
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('morphing');
                });
            }, 120); // Single coordinated timing
            
            if (tabName === 'pending-approvals' && isAuthenticated) {
                loadPendingApprovals();
            } else if (tabName === 'condition-reports' && isAuthenticated) {
                loadConditionReports();
            } else if (tabName === 'ppe-inventory' && isAuthenticated) {
                loadPPEInventoryManagement();
            } else if (tabName === 'stock-alerts' && isAuthenticated) {
                loadStockAlerts();
            } else if (tabName === 'thresholds' && isAuthenticated) {
                loadThresholds();
            } else if (tabName === 'station-management' && isAuthenticated) {
                loadStationManagement();
            } else if (tabName === 'staff-management' && isAuthenticated) {
                loadStaffManagement();
            } else if (tabName === 'features' && isAuthenticated) {
                loadFeatures();
            } else if (tabName === 'email-config' && isAuthenticated) {
                loadEmailConfiguration();
            } else if (tabName === 'reports' && isAuthenticated) {
                loadReports();
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalStock').textContent = stats?.totalStock?.toLocaleString() || '0';
                    document.getElementById('lowStock').textContent = stats?.lowStockItems || '0';
                    document.getElementById('dailyIssued').textContent = stats?.dailyIssued || '0';
                }
                
                if (isAuthenticated) {
                    loadPendingApprovalsCount();
                }
            } catch (error) {
                console.log('Dashboard load failed:', error);
            }
        }

        async function loadPendingApprovalsCount() {
            try {
                const response = await fetch('/api/approval/pending', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('ppe_auth_token')}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('pendingApprovals').textContent = data.count || 0;
                }
            } catch (error) {
                console.log('Failed to load pending approvals count:', error);
            }
        }

        // Approval workflow functions
        async function loadPendingApprovals() {
            if (!isAuthenticated) return;
            
            try {
                const response = await fetch('/api/approval/pending', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('ppe_auth_token')}` }
                });
                
                if (!response.ok) throw new Error('Failed to load pending approvals');
                
                const data = await response.json();
                displayPendingApprovals(data.pendingRequests);
            } catch (error) {
                console.error('Load pending approvals error:', error);
                document.getElementById('pendingApprovalsList').innerHTML = `
                    <p style="text-align: center; padding: 40px; color: #dc2626;">
                        Error loading pending approvals. Please try again.
                    </p>
                `;
            }
        }

        function displayPendingApprovals(requests) {
            const container = document.getElementById('pendingApprovalsList');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; padding: 40px; color: #6b7280;">
                        ✅ No pending approvals. All requests have been processed.
                    </p>
                `;
                return;
            }
            
            container.innerHTML = requests.map(request => `
                <div class="approval-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 8px 0; color: #1f2937; font-weight: 600;">
                                Request #${request.id.substring(0, 8)}
                            </h4>
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">
                                Submitted: ${formatWithTimezoneLocal(request.created_at)}
                            </p>
                        </div>
                        <div style="padding: 4px 12px; background: #fef3c7; color: #92400e; border-radius: 6px; font-size: 12px; font-weight: 600;">
                            PENDING
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                        <div>
                            <strong style="color: #374151;">Station:</strong><br>
                            <span style="color: #6b7280;">${request.station_name}</span><br>
                            <small style="color: #9ca3af;">${request.station_location}</small>
                        </div>
                        <div>
                            <strong style="color: #374151;">Items Requested:</strong><br>
                            <span style="color: #6b7280;">${request.requested_items || 'Loading...'}</span>
                        </div>
                        <div>
                            <strong style="color: #374151;">Staff:</strong><br>
                            <span style="color: #6b7280;">${request.staff_name || 'Unknown'}</span><br>
                            <small style="color: #9ca3af;">ID: ${request.staff_id || 'N/A'} • ${request.department || 'N/A'}</small>
                        </div>
                    </div>
                    
                    ${request.notes ? `
                        <div style="margin-bottom: 16px;">
                            <strong style="color: #374151;">Notes:</strong><br>
                            <span style="color: #6b7280;">${request.notes}</span>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="approveRequest('${request.id}')" class="btn-primary">
                            ✅ Approve
                        </button>
                        <button onclick="rejectRequest('${request.id}')" class="btn-danger">
                            ❌ Reject
                        </button>
                        <button onclick="viewRequestDetails('${request.id}')" class="btn-secondary">
                            📋 Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function approveRequest(requestId) {
            const notes = prompt('Approval notes (optional):');
            if (notes === null) return;
            
            try {
                const response = await fetch(`/api/approval/approve/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('ppe_auth_token')}`
                    },
                    body: JSON.stringify({ notes })
                });
                
                if (!response.ok) throw new Error('Failed to approve request');
                
                showToast('✅ Request approved successfully!', 'success');
                loadPendingApprovals();
                loadPendingApprovalsCount();
            } catch (error) {
                showToast('❌ Failed to approve request', 'error');
            }
        }

        async function rejectRequest(requestId) {
            const reason = prompt('Reason for rejection:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/approval/reject/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('ppe_auth_token')}`
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (!response.ok) throw new Error('Failed to reject request');
                
                showToast('❌ Request rejected', 'success');
                loadPendingApprovals();
                loadPendingApprovalsCount();
            } catch (error) {
                showToast('❌ Failed to reject request', 'error');
            }
        }

        async function viewRequestDetails(requestId) {
            try {
                const response = await fetch(`/api/approval/request/${requestId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('ppe_auth_token')}` }
                });
                
                if (!response.ok) throw new Error('Failed to load request details');
                
                const data = await response.json();
                const request = data.request;
                const items = data.items;
                
                alert(`Request Details:
                
ID: ${request.id}
Station: ${request.station_name}
Staff: ${request.staff_name || 'Unknown'} (${request.staff_id || 'N/A'})
Department: ${request.department || 'N/A'}
Created: ${formatWithTimezoneLocal(request.created_at)}
Status: ${request.status}

Items:
${items.map(item => `• ${item.item_name} (${item.quantity}x) - Stock: ${item.current_stock}`).join('\n')}

Notes: ${request.notes || 'None'}`);
                
            } catch (error) {
                showToast('❌ Failed to load request details', 'error');
            }
        }

        // Table sorting functionality
        let sortState = {}; // Track sort direction for each column
        
        function sortTable(columnIndex, tableBodyId, dataType = 'text') {
            const tbody = document.getElementById(tableBodyId);
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Skip if no data rows (e.g., "Loading..." or "No data" message)
            if (rows.length === 1 && rows[0].cells.length === 1) {
                return;
            }
            
            // Get current sort direction for this column
            const currentSort = sortState[columnIndex] || 'asc';
            const newSort = currentSort === 'asc' ? 'desc' : 'asc';
            sortState[columnIndex] = newSort;
            
            // Update sort indicators
            updateSortIndicators(columnIndex, newSort);
            
            // Sort the rows
            rows.sort((a, b) => {
                let aValue = a.cells[columnIndex].textContent.trim();
                let bValue = b.cells[columnIndex].textContent.trim();
                
                // Handle different data types
                if (dataType === 'number') {
                    aValue = parseInt(aValue) || 0;
                    bValue = parseInt(bValue) || 0;
                } else {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }
                
                let comparison = 0;
                if (aValue < bValue) comparison = -1;
                else if (aValue > bValue) comparison = 1;
                
                return newSort === 'asc' ? comparison : -comparison;
            });
            
            // Reorder the rows in the table
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function updateSortIndicators(activeColumnIndex, direction) {
            // Clear all sort indicators
            document.querySelectorAll('.sort-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active');
                if (index === activeColumnIndex) {
                    indicator.textContent = direction === 'asc' ? '↑' : '↓';
                    indicator.classList.add('active');
                } else {
                    indicator.textContent = '↕️';
                }
            });
        }
        
        // Inventory search/filter functionality
        function filterInventory() {
            const searchInput = document.getElementById('inventorySearch');
            const searchTerm = searchInput.value.toLowerCase().trim();
            const tbody = document.getElementById('inventoryTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                // Skip header rows or single-cell rows (loading/no data)
                if (row.cells.length < 2) {
                    return;
                }
                
                const ppeItem = row.cells[0].textContent.toLowerCase();
                const station = row.cells[1].textContent.toLowerCase();
                const stock = row.cells[2].textContent.toLowerCase();
                const status = row.cells[4].textContent.toLowerCase();
                
                const matchesSearch = searchTerm === '' || 
                    ppeItem.includes(searchTerm) || 
                    station.includes(searchTerm) || 
                    stock.includes(searchTerm) || 
                    status.includes(searchTerm);
                
                row.style.display = matchesSearch ? '' : 'none';
            });
        }

        // Inventory functions
        async function loadInventory() {
            try {
                console.log('Loading inventory data...');
                // Add cache busting parameter to ensure fresh data
                const response = await fetch(`/api/inventory-management/inventory?_t=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const inventory = await response.json();
                    console.log('Inventory loaded:', inventory.length, 'items');
                    displayInventory(inventory);
                } else {
                    console.error('Failed to load inventory:', response.status);
                    showToast('❌ Failed to load inventory', 'error');
                }
            } catch (error) {
                console.error('Load inventory error:', error);
                showToast('❌ Failed to load inventory', 'error');
            }
        }

        function displayInventory(inventory) {
            const tbody = document.getElementById('inventoryTableBody');
            
            if (!inventory || inventory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">No inventory data available</td></tr>';
                return;
            }

            tbody.innerHTML = inventory.map(item => `
                <tr>
                    <td>${item.item_name}</td>
                    <td>${item.station_name}</td>
                    <td>${item.current_stock}</td>
                    <td>${item.max_capacity}</td>
                    <td>
                        <span class="status-${item.current_stock > 20 ? 'good' : item.current_stock > 0 ? 'low' : 'out'}">
                            ${item.current_stock > 20 ? 'GOOD' : item.current_stock > 0 ? 'LOW' : 'OUT'}
                        </span>
                    </td>
                    <td>
                        <button onclick="editStock('${item.station_id}', '${item.ppe_item_id}', ${item.current_stock}, '${item.item_name}')" class="btn-primary" style="font-size: 12px; padding: 4px 8px;">
                            Edit
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function editStock(stationId, ppeItemId, currentStock, itemName) {
            const newStock = prompt(`Enter new stock quantity for ${itemName} (current: ${currentStock}):`);
            if (newStock === null || newStock === '') return;
            
            const quantity = parseInt(newStock);
            if (isNaN(quantity) || quantity < 0) {
                showToast('❌ Invalid quantity', 'error');
                return;
            }
            
            try {
                console.log(`Updating stock for ${itemName}: ${currentStock} → ${quantity}`);
                
                // Calculate the difference and operation
                const difference = Math.abs(quantity - currentStock);
                const operation = quantity > currentStock ? 'ADD' : 'SUBTRACT';
                
                if (difference === 0) {
                    showToast('ℹ️ No change in stock quantity', 'info');
                    return;
                }
                
                const response = await fetch('/api/inventory-management/stock/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        stationId,
                        ppeItemId,
                        quantity: difference,
                        operation
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Stock update result:', result);
                    showToast(`✅ ${itemName} stock updated: ${currentStock} → ${quantity}`, 'success');
                    
                    // Reload both inventory and thresholds to sync data
                    loadInventory();
                    
                    // Check if threshold tab is currently active and reload it
                    const thresholdTab = document.querySelector('[onclick*="thresholds"]');
                    const thresholdContent = document.getElementById('thresholds');
                    if (thresholdContent && thresholdContent.style.display !== 'none') {
                        loadThresholds();
                    }
                } else {
                    const error = await response.json();
                    console.error('Stock update failed:', error);
                    showToast(`❌ Failed to update stock: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('Stock update error:', error);
                showToast('❌ Failed to update stock', 'error');
            }
        }

        // Utility functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Stock Alerts Functions
        async function loadStockAlerts() {
            try {
                const response = await fetch('/api/inventory-management/alerts', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const alerts = await response.json();
                    displayStockAlerts(alerts);
                } else {
                    showToast('❌ Failed to load stock alerts', 'error');
                }
            } catch (error) {
                console.error('Load stock alerts error:', error);
                showToast('❌ Failed to load stock alerts', 'error');
            }
        }
        
        function displayStockAlerts(alerts) {
            const container = document.getElementById('stockAlertsContent');
            
            if (alerts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">✅ No active stock alerts</div>';
                return;
            }
            
            const alertsHTML = alerts.map(alert => `
                <div class="alert-card ${alert.severity.toLowerCase()}">
                    <div class="alert-header">
                        <h4 class="alert-title">${alert.item_name} - ${alert.station_name}</h4>
                        <span class="alert-severity ${alert.severity.toLowerCase()}">${alert.severity}</span>
                    </div>
                    <div class="alert-info">
                        <p><strong>Current Stock:</strong> ${alert.current_stock} units</p>
                        <p><strong>Threshold:</strong> ${alert.threshold_value} units</p>
                        <p><strong>Location:</strong> ${alert.location}</p>
                        <p><strong>Alert Type:</strong> ${alert.alert_type.replace('_', ' ')}</p>
                        <p><strong>Created:</strong> ${formatWithTimezoneLocal(alert.created_at)}</p>
                        <button class="btn-secondary" onclick="acknowledgeAlert('${alert.id}')">✅ Acknowledge</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = alertsHTML;
        }
        
        async function acknowledgeAlert(alertId) {
            try {
                const response = await fetch(`/api/inventory-management/alerts/${alertId}/acknowledge`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showToast('✅ Alert acknowledged', 'success');
                    loadStockAlerts();
                } else {
                    showToast('❌ Failed to acknowledge alert', 'error');
                }
            } catch (error) {
                console.error('Acknowledge alert error:', error);
                showToast('❌ Failed to acknowledge alert', 'error');
            }
        }
        
        function refreshAlerts() {
            animateRefreshButton(event, () => loadStockAlerts());
        }
        
        // Threshold Management Functions
        async function loadThresholds() {
            try {
                console.log('Loading threshold data...');
                const response = await fetch('/api/inventory-management/inventory', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const inventory = await response.json();
                    console.log('Thresholds loaded:', inventory.length, 'items');
                    displayThresholds(inventory);
                } else {
                    console.error('Failed to load thresholds:', response.status);
                    showToast('❌ Failed to load thresholds', 'error');
                }
            } catch (error) {
                console.error('Load thresholds error:', error);
                showToast('❌ Failed to load thresholds', 'error');
            }
        }
        
        function displayThresholds(inventory) {
            const tableBody = document.getElementById('thresholdTableBody');
            
            if (inventory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">No inventory items found</td></tr>';
                return;
            }
            
            const thresholdRows = inventory.map(item => `
                <tr data-station="${item.station_id}" data-item="${item.ppe_item_id}">
                    <td>${item.item_name}</td>
                    <td>${item.station_name}</td>
                    <td>${item.current_stock}</td>
                    <td>
                        <input type="number" class="threshold-input" 
                               value="${item.min_threshold || 10}" 
                               min="1" max="999"
                               onchange="markThresholdChanged(this, 'min')"
                               data-original="${item.min_threshold || 10}">
                    </td>
                    <td>
                        <input type="number" class="threshold-input" 
                               value="${item.critical_threshold || 5}" 
                               min="1" max="999"
                               onchange="markThresholdChanged(this, 'critical')"
                               data-original="${item.critical_threshold || 5}">
                    </td>
                    <td>
                        <span class="stock-status ${(item.stock_status || 'UNKNOWN').toLowerCase()}">${item.stock_status || 'UNKNOWN'}</span>
                    </td>
                    <td>
                        <button class="btn-secondary btn-sm" onclick="resetThreshold(this)">↶ Reset</button>
                    </td>
                </tr>
            `).join('');
            
            tableBody.innerHTML = thresholdRows;
        }
        
        function markThresholdChanged(input, type) {
            const row = input.closest('tr');
            const original = input.dataset.original;
            const current = input.value;
            
            if (original !== current) {
                row.style.backgroundColor = '#fef3c7';
                input.style.borderColor = '#f59e0b';
            } else {
                row.style.backgroundColor = '';
                input.style.borderColor = '#d1d5db';
            }
        }
        
        function resetThreshold(button) {
            const row = button.closest('tr');
            const inputs = row.querySelectorAll('.threshold-input');
            
            inputs.forEach(input => {
                input.value = input.dataset.original;
                input.style.borderColor = '#d1d5db';
            });
            
            row.style.backgroundColor = '';
        }
        
        async function saveAllThresholds() {
            const changedRows = document.querySelectorAll('#thresholdTableBody tr[style*="background-color"]');
            
            if (changedRows.length === 0) {
                showToast('ℹ️ No changes to save', 'info');
                return;
            }
            
            const updates = [];
            
            changedRows.forEach(row => {
                const stationId = row.dataset.station;
                const ppeItemId = row.dataset.item;
                const minInput = row.querySelector('.threshold-input[onchange*="min"]');
                const criticalInput = row.querySelector('.threshold-input[onchange*="critical"]');
                
                updates.push({
                    stationId,
                    ppeItemId,
                    minThreshold: parseInt(minInput.value),
                    criticalThreshold: parseInt(criticalInput.value)
                });
            });
            
            try {
                const response = await fetch('/api/inventory-management/thresholds/bulk-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ updates })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const successCount = result.results.filter(r => r.success).length;
                    const failCount = result.results.filter(r => !r.success).length;
                    
                    showToast(`✅ ${successCount} thresholds updated successfully${failCount > 0 ? `, ${failCount} failed` : ''}`, 'success');
                    loadThresholds();
                } else {
                    showToast('❌ Failed to save thresholds', 'error');
                }
            } catch (error) {
                console.error('Save thresholds error:', error);
                showToast('❌ Failed to save thresholds', 'error');
            }
        }
        
        function filterThresholds() {
            const searchTerm = document.getElementById('thresholdSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#thresholdTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function showAddItemModal() {
            showToast('🛡️ PPE Item management coming soon!', 'success');
        }

        // Removed exportData() and bulkUpdate() - functionality available in PPE Inventory section

        // Station Management Functions
        async function loadStationManagement() {
            try {
                console.log('Loading station management...');
                
                // Check if stations exist and show setup guidance
                await checkStationSetupStatus();
                
                // Load stations list
                await refreshStationList();
                
            } catch (error) {
                console.error('Failed to load station management:', error);
                document.getElementById('stationsContent').innerHTML = `
                    <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px;">
                        <p style="color: #dc2626; margin: 0;">❌ Failed to load stations: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function checkStationSetupStatus() {
            try {
                console.log('🔍 Checking station setup status...');
                const response = await fetch('/api/stations');
                const data = await response.json();
                console.log('📊 Station status data:', data);
                
                // The API returns array directly, not wrapped in a stations property
                const stations = Array.isArray(data) ? data : (data.stations || []);
                const statusDiv = document.getElementById('stationSetupStatus');
                
                if (!stations || stations.length === 0) {
                    statusDiv.innerHTML = `
                        <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 32px;">⚠️</div>
                                <div>
                                    <h4 style="margin: 0 0 8px 0; color: #92400e;">No Stations Configured</h4>
                                    <p style="margin: 0; color: #92400e;">You need to configure at least one station before you can add PPE types or accept worker requests.</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    const activeStations = stations.filter(s => s.active);
                    statusDiv.innerHTML = `
                        <div style="background: #f8f9fa; border: 2px solid #000000; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 32px;">✅</div>
                                <div>
                                    <h4 style="margin: 0 0 8px 0; color: #065f46;">Stations Configured</h4>
                                    <p style="margin: 0; color: #065f46;">${activeStations.length} active station(s) ready for PPE distribution.</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to check station status:', error);
            }
        }
        
        async function refreshStationList() {
            try {
                console.log('🔄 Refreshing station list...');
                const response = await fetch('/api/stations');
                console.log('📡 Station API response status:', response.status);
                const data = await response.json();
                console.log('📊 Station data received:', data);
                
                const content = document.getElementById('stationsContent');
                
                // The API returns array directly, not wrapped in a stations property
                const stations = Array.isArray(data) ? data : (data.stations || []);
                console.log('📋 Processed stations:', stations);
                
                if (!stations || stations.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 16px;">🏢</div>
                            <h3 style="margin: 0 0 12px 0;">No Stations Configured</h3>
                            <p style="margin: 0;">Click "Add New Station" to create your first station location.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div style="display: grid; gap: 16px;">
                `;
                
                stations.forEach(station => {
                    const statusBadge = station.active 
                        ? '<span style="background: #000000; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">Active</span>'
                        : '<span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">Inactive</span>';
                    
                    html += `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: white;">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <h4 style="margin: 0; color: #374151;">${station.name}</h4>
                                        ${statusBadge}
                                    </div>
                                    <p style="margin: 0; color: #6b7280; font-size: 14px;"><strong>ID:</strong> ${station.id}</p>
                                    <p style="margin: 0; color: #6b7280; font-size: 14px;"><strong>Location:</strong> ${station.location}</p>
                                    ${station.description ? `<p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">${station.description}</p>` : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="toggleStationStatus('${station.id}', ${!station.active})" 
                                            style="padding: 4px 8px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer;">
                                        ${station.active ? '❌ Deactivate' : '✅ Activate'}
                                    </button>
                                    <button onclick="editStation('${station.id}')" 
                                            style="padding: 4px 8px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer;">
                                        ✏️ Edit
                                    </button>
                                    <button onclick="deleteStation('${station.id}')" 
                                            style="padding: 4px 8px; font-size: 12px; border: 1px solid #dc2626; border-radius: 4px; background: #fee2e2; color: #dc2626; cursor: pointer;">
                                        🗑️ Delete
                                    </button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; font-size: 12px; color: #6b7280;">
                                <span>QR: ${station.qr_code || 'Not generated'}</span>
                                <span>•</span>
                                <span>Created: ${formatDateOnlyLocal(station.created_at)}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                content.innerHTML = html;
                
            } catch (error) {
                console.error('Failed to load stations:', error);
                document.getElementById('stationsContent').innerHTML = `
                    <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px;">
                        <p style="color: #dc2626; margin: 0;">❌ Failed to load stations: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function showAddStation() {
            document.getElementById('addStationForm').style.display = 'block';
            document.getElementById('stationId').focus();
        }
        
        function hideAddStation() {
            document.getElementById('addStationForm').style.display = 'none';
            // Clear form
            document.getElementById('stationId').value = '';
            document.getElementById('stationName').value = '';
            document.getElementById('stationLocation').value = '';
            document.getElementById('stationDescription').value = '';
        }
        
        async function addStation() {
            const stationId = document.getElementById('stationId').value.trim();
            const stationName = document.getElementById('stationName').value.trim();
            const stationLocation = document.getElementById('stationLocation').value.trim();
            const stationDescription = document.getElementById('stationDescription').value.trim();
            
            // Validation
            if (!stationId || !stationName || !stationLocation) {
                alert('Please fill in all required fields (Station ID, Name, and Location)');
                return;
            }
            
            // Validate station ID format
            if (!/^[a-zA-Z0-9-]+$/.test(stationId)) {
                alert('Station ID can only contain letters, numbers, and hyphens');
                return;
            }
            
            try {
                const response = await fetch('/api/stations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        id: stationId,
                        name: stationName,
                        location: stationLocation,
                        description: stationDescription
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ Station "${stationName}" created successfully!`);
                    hideAddStation();
                    await refreshStationList();
                    await checkStationSetupStatus();
                } else {
                    alert(`❌ Failed to create station: ${result.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Failed to add station:', error);
                alert('❌ Failed to create station. Please try again.');
            }
        }
        
        async function toggleStationStatus(stationId, newStatus) {
            try {
                const response = await fetch(`/api/stations/${stationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        active: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    await refreshStationList();
                    await checkStationSetupStatus();
                } else {
                    alert(`❌ Failed to update station: ${result.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Failed to toggle station status:', error);
                alert('❌ Failed to update station status. Please try again.');
            }
        }
        
        async function deleteStation(stationId) {
            try {
                // First attempt - check if station can be deleted
                const response = await fetch(`/api/stations/${stationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ ${result.message}`);
                    await refreshStationList();
                    await checkStationSetupStatus();
                } else if (response.status === 400 && result.details) {
                    // Station has dependencies - show options
                    await handleStationDeletionWithDependencies(stationId, result);
                } else {
                    alert(`❌ Failed to delete station: ${result.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Failed to delete station:', error);
                alert('❌ Failed to delete station. Please try again.');
            }
        }
        
        async function handleStationDeletionWithDependencies(stationId, errorData) {
            const { details } = errorData;
            
            let message = `⚠️ Cannot delete station "${stationId}":\n\n`;
            message += `${errorData.error}\n\n`;
            
            if (details.inventoryCount) {
                message += `📦 Inventory Details:\n`;
                message += `   • ${details.inventoryCount} PPE types\n`;
                message += `   • ${details.totalStock} total items\n`;
                details.inventoryItems.forEach(item => {
                    message += `   • ${item.name}: ${item.stock} units\n`;
                });
                message += `\n`;
            }
            
            if (details.pendingRequests) {
                message += `📋 ${details.pendingRequests} pending PPE requests\n\n`;
            }
            
            message += `What would you like to do?\n\n`;
            message += `1. Cancel - Keep the station\n`;
            message += `2. Transfer inventory to another station\n`;
            message += `3. Force delete (⚠️ WILL LOSE ALL DATA)`;
            
            const choice = prompt(message + `\n\nEnter your choice (1, 2, or 3):`);
            
            if (choice === '2') {
                await handleInventoryTransfer(stationId);
            } else if (choice === '3') {
                await handleForceDelete(stationId);
            }
            // Choice 1 or invalid choice = cancel (do nothing)
        }
        
        async function handleInventoryTransfer(stationId) {
            // Get list of other stations for transfer
            try {
                const response = await fetch('/api/stations');
                const stations = Array.isArray(response) ? response : await response.json();
                const otherStations = stations.filter(s => s.id !== stationId && s.active);
                
                if (otherStations.length === 0) {
                    alert('❌ No other active stations available for inventory transfer.');
                    return;
                }
                
                let transferMessage = `Select destination station for inventory transfer:\n\n`;
                otherStations.forEach((station, index) => {
                    transferMessage += `${index + 1}. ${station.name} (${station.id})\n`;
                });
                
                const choice = prompt(transferMessage + `\nEnter station number (1-${otherStations.length}):`);
                const stationIndex = parseInt(choice) - 1;
                
                if (stationIndex >= 0 && stationIndex < otherStations.length) {
                    const targetStation = otherStations[stationIndex];
                    
                    if (confirm(`Transfer all inventory from "${stationId}" to "${targetStation.name}"?`)) {
                        await executeStationDelete(stationId, { transferTo: targetStation.id });
                    }
                }
                
            } catch (error) {
                console.error('Failed to get stations for transfer:', error);
                alert('❌ Failed to get station list for transfer.');
            }
        }
        
        async function handleForceDelete(stationId) {
            const confirmMessage = `⚠️ FORCE DELETE WARNING ⚠️\n\n` +
                `This will permanently delete station "${stationId}" and:\n` +
                `• Delete ALL inventory at this station\n` +
                `• Cancel any pending PPE requests\n` +
                `• Remove all related data\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Type "DELETE" to confirm:`;
            
            const confirmation = prompt(confirmMessage);
            
            if (confirmation === 'DELETE') {
                await executeStationDelete(stationId, { force: true });
            }
        }
        
        async function executeStationDelete(stationId, options = {}) {
            try {
                const queryParams = new URLSearchParams();
                if (options.force) queryParams.append('force', 'true');
                if (options.transferTo) queryParams.append('transferTo', options.transferTo);
                
                const url = `/api/stations/${stationId}?${queryParams.toString()}`;
                
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ ${result.message}`);
                    if (result.details && result.details.inventoryTransferredTo) {
                        alert(`📦 Inventory successfully transferred to station: ${result.details.inventoryTransferredTo}`);
                    }
                    await refreshStationList();
                    await checkStationSetupStatus();
                } else {
                    alert(`❌ Failed to delete station: ${result.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Failed to execute station delete:', error);
                alert('❌ Failed to delete station. Please try again.');
            }
        }
        
        function editStation(stationId) {
            // For now, show a simple alert. Could be expanded to inline editing
            alert(`Edit functionality for station "${stationId}" could be implemented here.`);
        }
        
        function generateQRCodes() {
            alert('QR Code generation functionality could be implemented here.');
        }

        // Staff Management Functions
        async function loadStaffManagement() {
            try {
                console.log('Loading staff management...');
                
                // First check employee limits
                const employeeLimitResponse = await fetch('/api/features/employee-limit', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (employeeLimitResponse.ok) {
                    const employeeLimitData = await employeeLimitResponse.json();
                    const employeeLimit = employeeLimitData.employee_limit;
                    
                    if (employeeLimit.exceeded) {
                        displayStaffManagementLocked(employeeLimit);
                        return;
                    }
                }
                
                await Promise.all([loadStaffStats(), loadStaffList()]);
            } catch (error) {
                console.error('Load staff management error:', error);
                showToast('❌ Failed to load staff management', 'error');
            }
        }

        function displayStaffManagementLocked(employeeLimit) {
            // Defensive check - unlimited plans should never be locked
            if (employeeLimit.is_unlimited || employeeLimit.max_employees === -1) {
                console.warn('displayStaffManagementLocked called for unlimited plan - this should not happen');
                return;
            }
            
            const container = document.querySelector('#staff-management-tab .card');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="background: #fee2e2; border: 2px solid #fecaca; border-radius: 12px; padding: 30px; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🔒</div>
                        <h3 style="color: #dc2626; margin: 0 0 12px 0; font-size: 24px;">Staff Management Locked</h3>
                        <p style="color: #7f1d1d; margin: 0 0 16px 0; font-size: 16px; line-height: 1.5;">
                            Your current license allows <strong>${employeeLimit.max_employees} employees</strong>, but you have <strong>${employeeLimit.current_employees} active employees</strong>.
                        </p>
                        <p style="color: #7f1d1d; margin: 0; font-size: 14px;">
                            You need to deactivate <strong>${employeeLimit.excess_employees} employees</strong> or upgrade your license to access staff management.
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; max-width: 600px; margin: 0 auto;">
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #374151;">📞 Contact Sales</h4>
                            <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">Upgrade to Pro or Enterprise</p>
                            <button onclick="contactSales()" class="btn-primary" style="width: 100%;">
                                Upgrade License
                            </button>
                        </div>
                        
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #374151;">👥 Bulk Deactivate</h4>
                            <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">Remove inactive employees</p>
                            <button onclick="showBulkDeactivation()" class="btn-secondary" style="width: 100%;">
                                Manage Staff
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                        <p style="margin: 0; font-size: 14px; color: #0c4a6e;">
                            <strong>Current Status:</strong> ${employeeLimit.current_employees}/${employeeLimit.max_employees} employees (${employeeLimit.excess_employees} over limit)
                        </p>
                    </div>
                </div>
            `;
        }

        async function loadStaffStats() {
            try {
                const response = await fetch('/api/staff/stats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    displayStaffStats(stats);
                }
            } catch (error) {
                console.error('Load staff stats error:', error);
            }
        }

        function displayStaffStats(stats) {
            const container = document.getElementById('staffStatsContainer');
            container.innerHTML = `
                <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #1f2937;">${stats.total_staff || 0}</div>
                    <div style="font-size: 12px; color: #6b7280;">Total Staff</div>
                </div>
                <div style="background: #d1fae5; padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #065f46;">${stats.active_staff || 0}</div>
                    <div style="font-size: 12px; color: #047857;">Active</div>
                </div>
                <div style="background: #fee2e2; padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #7f1d1d;">${stats.inactive_staff || 0}</div>
                    <div style="font-size: 12px; color: #991b1b;">Inactive</div>
                </div>
                <div style="background: #dbeafe; padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #1e3a8a;">${stats.departments || 0}</div>
                    <div style="font-size: 12px; color: #1d4ed8;">Departments</div>
                </div>
            `;
        }

        async function loadStaffList() {
            try {
                const response = await fetch('/api/staff?active=all', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const staff = await response.json();
                    displayStaffList(staff);
                }
            } catch (error) {
                console.error('Load staff list error:', error);
            }
        }

        // Store original staff data for filtering
        let originalStaffData = [];

        function displayStaffList(staff) {
            const tbody = document.getElementById('staffTableBody');
            
            // Store original data for filtering
            originalStaffData = staff || [];
            
            if (!staff || staff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">No staff records found</td></tr>';
                updateStaffFilterInfo(0, 0, 0);
                return;
            }

            tbody.innerHTML = staff.map(member => `
                <tr class="staff-row" data-status="${member.active ? 'active' : 'inactive'}" data-name="${member.name.toLowerCase()}" data-id="${member.staff_id.toLowerCase()}">
                    <td style="font-weight: 500;">${member.staff_id}</td>
                    <td>${member.name}</td>
                    <td>${member.department || '-'}</td>
                    <td>${member.position || '-'}</td>
                    <td>
                        <span style="background: ${member.active ? '#d1fae5' : '#fee2e2'}; color: ${member.active ? '#065f46' : '#7f1d1d'}; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                            ${member.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button onclick="editStaffMember('${member.staff_id}')" class="btn-secondary" style="font-size: 12px; padding: 4px 8px; margin-right: 4px;">
                            Edit
                        </button>
                        ${member.active ? 
                            `<button onclick="deactivateStaffMember('${member.staff_id}')" class="btn-danger" style="font-size: 12px; padding: 4px 8px;">Deactivate</button>` :
                            `<button onclick="reactivateStaffMember('${member.staff_id}')" class="btn-success" style="font-size: 12px; padding: 4px 8px; margin-right: 4px;">Reactivate</button>
                             <button onclick="permanentDeleteStaff('${member.staff_id}', '${member.name}')" class="btn-danger" style="font-size: 12px; padding: 4px 8px; background: #dc2626;">🗑️ Delete</button>`
                        }
                    </td>
                </tr>
            `).join('');
            
            // Update filter info
            const activeCount = staff.filter(s => s.active).length;
            const inactiveCount = staff.filter(s => !s.active).length;
            updateStaffFilterInfo(staff.length, activeCount, inactiveCount);
            
            // Apply current filters
            applyCurrentFilters();
        }
        
        function updateStaffFilterInfo(total, active, inactive) {
            const infoElement = document.getElementById('staffFilterInfo');
            infoElement.innerHTML = `Total: ${total} | Active: ${active} | Inactive: ${inactive}`;
            
            // Show/hide bulk delete button based on inactive count
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            if (bulkDeleteBtn) {
                bulkDeleteBtn.style.display = inactive > 0 ? 'inline-block' : 'none';
            }
        }

        function downloadStaffTemplate() {
            window.open('/api/staff/template', '_blank');
        }

        function showStaffImport() {
            document.getElementById('staffImportModal').style.display = 'block';
        }

        function closeStaffImportModal() {
            document.getElementById('staffImportModal').style.display = 'none';
            document.getElementById('staffFileInput').value = '';
            document.getElementById('selectedFileName').textContent = 'No file selected';
            document.getElementById('uploadStaffBtn').disabled = true;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('selectedFileName').textContent = file.name;
                document.getElementById('uploadStaffBtn').disabled = false;
            } else {
                document.getElementById('selectedFileName').textContent = 'No file selected';
                document.getElementById('uploadStaffBtn').disabled = true;
            }
        }

        async function uploadStaffFile() {
            const fileInput = document.getElementById('staffFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('❌ Please select a file', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadStaffBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            try {
                const formData = new FormData();
                formData.append('staffFile', file);
                
                const response = await fetch('/api/staff/import', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(`✅ Import completed: ${result.successCount} staff added, ${result.errorCount} errors`, 'success');
                    
                    if (result.errors && result.errors.length > 0) {
                        console.log('Import errors:', result.errors);
                        showToast(`⚠️ ${result.errorCount} rows had errors - check console for details`, 'warning');
                    }
                    
                    closeStaffImportModal();
                    loadStaffManagement();
                } else {
                    showToast(`❌ Import failed: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showToast('❌ Upload failed. Please try again.', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload & Import';
            }
        }

        function showAddStaff() {
            document.getElementById('addStaffModal').style.display = 'block';
        }

        function refreshStaffList() {
            animateRefreshButton(event, () => loadStaffManagement());
        }

        async function editStaffMember(staffId) {
            try {
                // Get staff data
                const response = await fetch(`/api/staff/${staffId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch staff data');
                }
                
                const staff = await response.json();
                
                // Populate form
                document.getElementById('editStaffId').value = staff.staff_id;
                document.getElementById('editStaffName').value = staff.name || '';
                document.getElementById('editStaffEmail').value = staff.email || '';
                document.getElementById('editStaffDepartment').value = staff.department || '';
                document.getElementById('editStaffPosition').value = staff.position || '';
                
                // Show modal
                document.getElementById('editStaffModal').style.display = 'block';
                
            } catch (error) {
                console.error('Edit staff error:', error);
                showToast('❌ Failed to load staff data', 'error');
            }
        }

        async function deactivateStaffMember(staffId) {
            if (!confirm(`Are you sure you want to deactivate staff member ${staffId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/staff/${staffId}/deactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast(`✅ Staff ${staffId} deactivated successfully`, 'success');
                    loadStaffManagement();
                } else {
                    showToast(`❌ ${result.message || 'Failed to deactivate staff'}`, 'error');
                }
                
            } catch (error) {
                console.error('Deactivate staff error:', error);
                showToast('❌ Failed to deactivate staff', 'error');
            }
        }

        function closeEditStaffModal() {
            document.getElementById('editStaffModal').style.display = 'none';
        }

        function closeAddStaffModal() {
            document.getElementById('addStaffModal').style.display = 'none';
            document.getElementById('addStaffForm').reset();
        }

        // Edit staff form submission
        document.getElementById('editStaffForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const staffId = document.getElementById('editStaffId').value;
            const formData = {
                name: document.getElementById('editStaffName').value,
                email: document.getElementById('editStaffEmail').value,
                department: document.getElementById('editStaffDepartment').value,
                position: document.getElementById('editStaffPosition').value
            };
            
            try {
                const response = await fetch(`/api/staff/${staffId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast(`✅ Staff ${staffId} updated successfully`, 'success');
                    closeEditStaffModal();
                    loadStaffManagement();
                } else {
                    showToast(`❌ ${result.message || 'Failed to update staff'}`, 'error');
                }
                
            } catch (error) {
                console.error('Update staff error:', error);
                showToast('❌ Failed to update staff', 'error');
            }
        });

        // Add staff form submission
        document.getElementById('addStaffForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                staffId: document.getElementById('addStaffId').value,
                name: document.getElementById('addStaffName').value,
                email: document.getElementById('addStaffEmail').value,
                department: document.getElementById('addStaffDepartment').value,
                position: document.getElementById('addStaffPosition').value
            };
            
            try {
                const response = await fetch('/api/staff/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast(`✅ Staff ${formData.staffId} added successfully`, 'success');
                    closeAddStaffModal();
                    loadStaffManagement();
                } else {
                    showToast(`❌ ${result.message || 'Failed to add staff'}`, 'error');
                    closeAddStaffModal(); // Close modal on error too
                }
                
            } catch (error) {
                console.error('Add staff error:', error);
                showToast('❌ Failed to add staff', 'error');
                closeAddStaffModal(); // Close modal on error too
            }
        });

        async function reactivateStaffMember(staffId) {
            if (!confirm(`Are you sure you want to reactivate staff member ${staffId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/staff/${staffId}/reactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast(`✅ Staff ${staffId} reactivated successfully`, 'success');
                    loadStaffManagement();
                } else {
                    showToast(`❌ ${result.message || 'Failed to reactivate staff'}`, 'error');
                }
                
            } catch (error) {
                console.error('Reactivate staff error:', error);
                showToast('❌ Failed to reactivate staff', 'error');
            }
        }

        // Removed showSystemSettings() - placeholder function no longer needed
        
        function contactSales() {
            showToast('📞 Please contact support to upgrade your license', 'success');
        }
        
        function showBulkDeactivation() {
            showToast('👥 Bulk deactivation feature coming soon!', 'success');
        }
        
        // Advanced Reports Functions (Pro Feature)
        async function loadReports() {
            try {
                // Try to check license status, but continue if auth fails
                let licenseTier = null;
                try {
                    // Use localStorage token if authToken is null
                    const token = authToken || localStorage.getItem('ppe_auth_token');
                    
                    if (token) {
                        const response = await fetch('/api/features/license-status', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const licenseData = await response.json();
                            licenseTier = licenseData.license?.subscription_tier;
                            
                            if (licenseTier === 'basic') {
                                displayReportsLocked();
                                return;
                            }
                        }
                    }
                } catch (licenseError) {
                    console.log('License check failed, proceeding with reports interface:', licenseError.message);
                }
                
                // Always show the reports interface (including scheduled reports)
                displayReportsInterface();
                
            } catch (error) {
                console.error('Load reports error:', error);
                // Still try to show the reports interface even if there was an error
                displayReportsInterface();
                showToast('⚠️ Reports loaded with limited functionality', 'warning');
            }
        }
        
        function displayReportsLocked() {
            const container = document.getElementById('reportsContent');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="background: #fef3c7; border: 2px solid #fde68a; border-radius: 12px; padding: 30px; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <h3 style="color: #d97706; margin: 0 0 12px 0; font-size: 24px;">Advanced Reports - Pro Feature</h3>
                        <p style="color: #92400e; margin: 0 0 16px 0; font-size: 16px; line-height: 1.5;">
                            Unlock powerful analytics and detailed reporting with <strong>Pro (RM 89/month)</strong> or <strong>Enterprise (RM 149/month)</strong> license.
                        </p>
                        <p style="color: #92400e; margin: 0; font-size: 14px;">
                            Get usage analytics, department insights, cost analysis, and exportable reports.
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; max-width: 800px; margin: 0 auto;">
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #374151;">📈 Usage Analytics</h4>
                            <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">Track PPE usage trends over time</p>
                        </div>
                        
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #374151;">🏢 Department Reports</h4>
                            <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">Analyze usage by department</p>
                        </div>
                        
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #374151;">💰 Cost Analysis</h4>
                            <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">Track PPE costs and budget</p>
                        </div>
                        
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #374151;">📋 Export Reports</h4>
                            <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">Export data to CSV/Excel</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button onclick="contactSales()" class="btn-primary" style="padding: 12px 24px; font-size: 16px;">
                            🚀 Upgrade to Pro License
                        </button>
                    </div>
                </div>
            `;
        }
        
        function displayReportsInterface() {
            const container = document.getElementById('reportsContent');
            container.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="reportPeriod" onchange="loadMiniCharts()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                        
                        <button onclick="refreshReports()" class="btn-secondary">🔄 Refresh</button>
                        <button onclick="exportAllReports()" class="btn-primary">📤 Export All (CSV)</button>
                        <button onclick="exportStaffAudit()" class="btn-primary" style="background: #dc2626;">🔍 Staff Audit Export</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Usage Analytics Card -->
                    <div onclick="openAnalyticsChart('usage')" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 25px rgba(59,130,246,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
                        <h4 style="margin: 0 0 16px 0; color: #374151; display: flex; align-items: center; gap: 8px;">
                            📈 Usage Analytics
                            <span style="font-size: 12px; color: #6b7280; font-weight: normal;">Click for detailed charts</span>
                        </h4>
                        <div id="usageAnalyticsContent">
                            <div class="mini-chart-container">
                                <canvas id="miniUsageChart"></canvas>
                            </div>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">PPE request trends over time</p>
                        </div>
                    </div>
                    
                    <!-- Department Analytics Card -->
                    <div onclick="openAnalyticsChart('department')" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;">
                        <h4 style="margin: 0 0 16px 0; color: #374151; display: flex; align-items: center; gap: 8px;">
                            🏢 Department Reports
                            <span style="font-size: 12px; color: #6b7280; font-weight: normal;">Click for detailed charts</span>
                        </h4>
                        <div id="departmentAnalyticsContent">
                            <div class="mini-chart-container">
                                <canvas id="miniDepartmentChart"></canvas>
                            </div>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Department usage comparison</p>
                        </div>
                    </div>
                    
                    <!-- PPE Analytics Card -->
                    <div onclick="openAnalyticsChart('ppe')" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;">
                        <h4 style="margin: 0 0 16px 0; color: #374151; display: flex; align-items: center; gap: 8px;">
                            🛡️ PPE Analytics
                            <span style="font-size: 12px; color: #6b7280; font-weight: normal;">Click for detailed charts</span>
                        </h4>
                        <div id="ppeAnalyticsContent">
                            <div class="mini-chart-container">
                                <canvas id="miniPPEChart"></canvas>
                            </div>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">PPE item usage analysis</p>
                        </div>
                    </div>
                    
                    <!-- Cost Analysis Card -->
                    <div onclick="openAnalyticsChart('cost')" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;">
                        <h4 style="margin: 0 0 16px 0; color: #374151; display: flex; align-items: center; gap: 8px;">
                            💰 Cost Analysis
                            <span style="font-size: 12px; color: #6b7280; font-weight: normal;">Click for detailed charts</span>
                        </h4>
                        <div id="costAnalysisContent">
                            <div class="mini-chart-container">
                                <canvas id="miniCostChart"></canvas>
                            </div>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">PPE cost tracking & budgets</p>
                        </div>
                    </div>
                    
                    <!-- Staff Performance Card (Worker Tracking) -->
                    <div onclick="openAnalyticsChart('staff')" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;">
                        <h4 style="margin: 0 0 16px 0; color: #374151; display: flex; align-items: center; gap: 8px;">
                            👥 Worker Tracking
                            <span style="font-size: 12px; color: #6b7280; font-weight: normal;">Click for detailed charts</span>
                        </h4>
                        <div id="staffAnalyticsContent">
                            <div class="mini-chart-container">
                                <canvas id="miniStaffChart"></canvas>
                            </div>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Individual worker PPE usage</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Load mini-charts after interface is displayed
            setTimeout(() => {
                loadMiniCharts();
            }, 100);
        }
        
        async function loadMiniCharts() {
            if (!isAuthenticated) return;
            
            try {
                const period = document.getElementById('reportPeriod')?.value || '30';
                
                // Load mini-charts for each panel
                await Promise.allSettled([
                    loadMiniChart('usage', 'miniUsageChart', period),
                    loadMiniChart('department', 'miniDepartmentChart', period),
                    loadMiniChart('ppe', 'miniPPEChart', period),
                    loadMiniChart('cost', 'miniCostChart', period),
                    loadMiniChart('staff', 'miniStaffChart', period)
                ]);
            } catch (error) {
                console.error('Error loading mini-charts:', error);
            }
        }
        
        async function loadMiniChart(type, canvasId, period) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            try {
                let endpoint;
                switch (type) {
                    case 'usage':
                        endpoint = `/api/reports/usage-analytics?period=${period}&groupBy=day`;
                        break;
                    case 'department':
                        endpoint = `/api/reports/department-analytics?period=${period}`;
                        break;
                    case 'ppe':
                        endpoint = `/api/reports/ppe-analytics?period=${period}`;
                        break;
                    case 'cost':
                        endpoint = `/api/reports/cost-analysis?period=${period}`;
                        break;
                    case 'staff':
                        endpoint = `/api/reports/staff-analytics?period=${period}`;
                        break;
                    default:
                        return;
                }
                
                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    createMiniChart(canvas, type, data);
                }
            } catch (error) {
                console.error(`Error loading mini-chart ${type}:`, error);
            }
        }
        
        function createMiniChart(canvas, type, data) {
            const ctx = canvas.getContext('2d');
            
            // Clear any existing chart
            if (canvas.chart) {
                canvas.chart.destroy();
            }
            
            // Debug: Log the data structure
            console.log(`Mini-chart data for ${type}:`, data);
            
            const colorMap = {
                'usage': '#3B82F6',
                'department': '#06B6D4', 
                'ppe': '#8B5CF6',
                'cost': '#10B981',
                'staff': '#F59E0B'
            };
            
            let chartConfig;
            
            // Check if data exists and has the expected structure
            if (!data || !data.data || !Array.isArray(data.data) || data.data.length === 0) {
                console.warn(`No valid data for mini-chart ${type}`);
                return;
            }
            
            switch (type) {
                case 'usage':
                    // Handle different possible data structures for usage analytics
                    const usageData = data.data.slice(-7);
                    let labels, values;
                    
                    if (usageData[0] && usageData[0].date && usageData[0].total_requests !== undefined) {
                        // Structure: {date: '2024-01-01', total_requests: 5}
                        labels = usageData.map(item => formatDateOnlyLocal(item.date));
                        values = usageData.map(item => item.total_requests);
                    } else if (usageData[0] && usageData[0].date && usageData[0].requests !== undefined) {
                        // Alternative structure: {date: '2024-01-01', requests: 5}
                        labels = usageData.map(item => formatDateOnlyLocal(item.date));
                        values = usageData.map(item => item.requests);
                    } else {
                        // Fallback: create simple incremental data
                        labels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
                        values = [1, 2, 1, 3, 2, 4, 3]; // Simple demo data
                    }
                    
                    chartConfig = {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                borderColor: colorMap[type],
                                backgroundColor: colorMap[type] + '20',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0
                            }]
                        }
                    };
                    break;
                    
                case 'department':
                    const topDepts = data.data.slice(0, 5);
                    if (topDepts.length === 0) {
                        // Fallback data
                        chartConfig = {
                            type: 'doughnut',
                            data: {
                                labels: ['No Data'],
                                datasets: [{
                                    data: [1],
                                    backgroundColor: ['#E5E7EB']
                                }]
                            }
                        };
                    } else {
                        chartConfig = {
                            type: 'doughnut',
                            data: {
                                labels: topDepts.map(item => item.department || 'Unknown'),
                                datasets: [{
                                    data: topDepts.map(item => item.total_requests || 0),
                                    backgroundColor: [
                                        '#06B6D4', '#3B82F6', '#8B5CF6', '#10B981', '#F59E0B'
                                    ]
                                }]
                            }
                        };
                    }
                    break;
                    
                case 'ppe':
                    const topPPE = data.data.slice(0, 5);
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: topPPE.map(item => (item.ppe_item || 'Unknown').split(' ')[0]),
                            datasets: [{
                                data: topPPE.map(item => item.total_quantity || 0),
                                backgroundColor: colorMap[type]
                            }]
                        }
                    };
                    break;
                    
                case 'cost':
                    const topCosts = data.data.slice(0, 5);
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: topCosts.map(item => (item.ppe_item || 'Unknown').split(' ')[0]),
                            datasets: [{
                                data: topCosts.map(item => item.total_cost || 0),
                                backgroundColor: colorMap[type]
                            }]
                        }
                    };
                    break;
                    
                case 'staff':
                    const topStaff = data.data.slice(0, 5);
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: topStaff.map(item => (item.staff_name || 'Unknown').split(' ')[0]),
                            datasets: [{
                                data: topStaff.map(item => item.total_requests || 0),
                                backgroundColor: colorMap[type]
                            }]
                        }
                    };
                    break;
                    
                default:
                    console.warn(`Unknown chart type: ${type}`);
                    return;
            }
            
            chartConfig.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                scales: (type === 'department') ? {} : {
                    x: { 
                        display: false,
                        grid: { display: false }
                    },
                    y: { 
                        display: false,
                        grid: { display: false }
                    }
                },
                animation: {
                    duration: 800,
                    easing: 'easeOutQuart'
                },
                layout: {
                    padding: 5
                },
                elements: {
                    point: { radius: 0 },
                    line: { borderWidth: 2 },
                    bar: {
                        // Dynamic bar width based on data count
                        borderRadius: 4,
                        borderSkipped: false
                    }
                },
                // Adjust bar width for different data sizes
                datasets: {
                    bar: {
                        maxBarThickness: data.data.length === 1 ? 40 : (data.data.length <= 3 ? 60 : 80),
                        barPercentage: data.data.length === 1 ? 0.3 : (data.data.length <= 3 ? 0.6 : 0.8),
                        categoryPercentage: data.data.length === 1 ? 0.4 : (data.data.length <= 3 ? 0.7 : 0.9)
                    }
                }
            };
            
            canvas.chart = new Chart(ctx, chartConfig);
        }
        
        async function loadUsageAnalytics() {
            const period = document.getElementById('reportPeriod').value;
            const container = document.getElementById('usageAnalyticsContent');
            
            try {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">Loading...</p>';
                
                const response = await fetch(`/api/reports/usage-analytics?period=${period}&groupBy=day`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayUsageChart(data.data, container);
                } else {
                    const error = await response.json();
                    container.innerHTML = `<p style="color: #dc2626; margin: 0;">❌ ${error.message || 'Failed to load usage analytics'}</p>`;
                }
                
            } catch (error) {
                console.error('Usage analytics error:', error);
                container.innerHTML = '<p style="color: #dc2626; margin: 0;">❌ Failed to load data</p>';
            }
        }
        
        function displayUsageChart(data, container) {
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">No usage data available</p>';
                return;
            }
            
            const totalRequests = data.reduce((sum, item) => sum + (item.total_requests || 0), 0);
            const totalItems = data.reduce((sum, item) => sum + (item.total_items || 0), 0);
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                        <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${totalRequests}</div>
                        <div style="font-size: 12px; color: #6b7280;">Total Requests</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 6px;">
                        <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${totalItems}</div>
                        <div style="font-size: 12px; color: #6b7280;">Total Items</div>
                    </div>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
            `;
            
            data.slice(0, 10).forEach(item => {
                const approvalRate = item.total_requests > 0 ? ((item.approved_requests / item.total_requests) * 100).toFixed(1) : 0;
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                        <div>
                            <div style="font-weight: 500; font-size: 14px;">${item.period}</div>
                            <div style="font-size: 12px; color: #6b7280;">${approvalRate}% approved</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 500; color: #059669;">${item.total_requests}</div>
                            <div style="font-size: 12px; color: #6b7280;">${item.total_items} items</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function loadDepartmentAnalytics() {
            const period = document.getElementById('reportPeriod').value;
            const container = document.getElementById('departmentAnalyticsContent');
            
            try {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">Loading...</p>';
                
                const response = await fetch(`/api/reports/department-analytics?period=${period}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayDepartmentChart(data.data, container);
                } else {
                    const error = await response.json();
                    container.innerHTML = `<p style="color: #dc2626; margin: 0;">❌ ${error.message || 'Failed to load department analytics'}</p>`;
                }
                
            } catch (error) {
                console.error('Department analytics error:', error);
                container.innerHTML = '<p style="color: #dc2626; margin: 0;">❌ Failed to load data</p>';
            }
        }
        
        function displayDepartmentChart(data, container) {
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">No department data available</p>';
                return;
            }
            
            let html = '<div style="max-height: 250px; overflow-y: auto;">';
            
            data.slice(0, 8).forEach((dept, index) => {
                const color = `hsl(${(index * 45) % 360}, 70%, 50%)`;
                html += `
                    <div style="margin-bottom: 12px; padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 4px solid ${color};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 500; font-size: 14px;">${dept.department}</div>
                                <div style="font-size: 12px; color: #6b7280;">${dept.unique_requesters} employees</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 500; color: #059669;">${dept.total_requests}</div>
                                <div style="font-size: 12px; color: #6b7280;">${dept.approval_rate}% approved</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function loadPPEAnalytics() {
            const period = document.getElementById('reportPeriod').value;
            const container = document.getElementById('ppeAnalyticsContent');
            
            try {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">Loading...</p>';
                
                const response = await fetch(`/api/reports/ppe-analytics?period=${period}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayPPEChart(data.data, container);
                } else {
                    const error = await response.json();
                    container.innerHTML = `<p style="color: #dc2626; margin: 0;">❌ ${error.message || 'Failed to load PPE analytics'}</p>`;
                }
                
            } catch (error) {
                console.error('PPE analytics error:', error);
                container.innerHTML = '<p style="color: #dc2626; margin: 0;">❌ Failed to load data</p>';
            }
        }
        
        function displayPPEChart(data, container) {
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">No PPE data available</p>';
                return;
            }
            
            let html = '<div style="max-height: 250px; overflow-y: auto;">';
            
            data.slice(0, 6).forEach(item => {
                html += `
                    <div style="margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 500; font-size: 13px;">${item.ppe_item}</div>
                                <div style="font-size: 11px; color: #6b7280;">${item.ppe_type}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 500; color: #059669;">${item.total_quantity}</div>
                                <div style="font-size: 11px; color: #6b7280;">${item.fulfillment_rate}% fulfilled</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function loadCostAnalysis() {
            const period = document.getElementById('reportPeriod').value;
            const container = document.getElementById('costAnalysisContent');
            
            try {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">Loading...</p>';
                
                const response = await fetch(`/api/reports/cost-analysis?period=${period}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayCostChart(data, container);
                } else {
                    const error = await response.json();
                    container.innerHTML = `<p style="color: #dc2626; margin: 0;">❌ ${error.message || 'Failed to load cost analysis'}</p>`;
                }
                
            } catch (error) {
                console.error('Cost analysis error:', error);
                container.innerHTML = '<p style="color: #dc2626; margin: 0;">❌ Failed to load data</p>';
            }
        }
        
        function displayCostChart(data, container) {
            if (!data.summary || !data.data) {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">No cost data available</p>';
                return;
            }
            
            const { summary } = data;
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: #1f2937;">$${summary.total_cost}</div>
                        <div style="font-size: 12px; color: #6b7280;">Total Cost</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 6px;">
                        <div style="font-size: 14px; font-weight: bold; color: #1f2937;">$${summary.avg_cost_per_item}</div>
                        <div style="font-size: 12px; color: #6b7280;">Avg Cost/Item</div>
                    </div>
                </div>
            `;
            
            if (data.data.length === 0) {
                html += '<p style="color: #6b7280; margin: 0; font-size: 12px;">No detailed cost data available</p>';
            } else {
                html += '<div style="max-height: 150px; overflow-y: auto;">';
                data.data.slice(0, 5).forEach(item => {
                    html += `
                        <div style="margin-bottom: 6px; padding: 6px; background: #f9fafb; border-radius: 4px; font-size: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-weight: 500;">${item.ppe_item}</span>
                                <span style="color: #059669;">$${item.total_cost}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        async function loadStaffAnalytics() {
            const period = document.getElementById('reportPeriod').value;
            const container = document.getElementById('staffAnalyticsContent');
            
            try {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">Loading...</p>';
                
                const response = await fetch(`/api/reports/staff-analytics?period=${period}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayStaffChart(data.data, container);
                } else {
                    const error = await response.json();
                    container.innerHTML = `<p style="color: #dc2626; margin: 0;">❌ ${error.message || 'Failed to load staff analytics'}</p>`;
                }
                
            } catch (error) {
                console.error('Staff analytics error:', error);
                container.innerHTML = '<p style="color: #dc2626; margin: 0;">❌ Failed to load data</p>';
            }
        }
        
        function displayStaffChart(data, container) {
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; margin: 0;">No staff data available</p>';
                return;
            }
            
            let html = '<div style="max-height: 250px; overflow-y: auto;">';
            
            data.slice(0, 6).forEach(staff => {
                html += `
                    <div style="margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 500; font-size: 13px;">${staff.staff_name || 'Unknown'}</div>
                                <div style="font-size: 11px; color: #6b7280;">${staff.department || 'N/A'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 500; color: #059669;">${staff.total_requests}</div>
                                <div style="font-size: 11px; color: #6b7280;">${staff.total_items} items</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function refreshReports() {
            animateRefreshButton(event, async () => {
                displayReportsInterface();
                // Wait a bit for the interface to render, then refresh mini-charts
                setTimeout(() => {
                    loadMiniCharts();
                }, 200);
                showToast('📊 Reports and charts refreshed', 'success');
            });
        }
        
        async function getCurrentLicenseInfo() {
            try {
                const response = await fetch('/api/features/license-status', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.license;
                }
            } catch (error) {
                console.error('License check error:', error);
            }
            return null;
        }

        async function exportAllReports() {
            // Check license tier before proceeding
            const currentLicense = await getCurrentLicenseInfo();
            if (currentLicense?.subscription_tier === 'basic') {
                showToast('❌ Export feature requires Pro or Enterprise license', 'error');
                return;
            }
            
            const period = document.getElementById('reportPeriod').value;
            
            try {
                showToast('📤 Exporting reports...', 'success');
                
                const reportTypes = ['usage', 'department', 'ppe', 'cost', 'staff'];
                const exportPromises = reportTypes.map(type =>
                    fetch(`/api/reports/export/${type}?period=${period}&format=csv`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                );
                
                const responses = await Promise.all(exportPromises);
                
                for (let i = 0; i < responses.length; i++) {
                    if (responses[i].ok) {
                        const blob = await responses[i].blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${reportTypes[i]}-report-${period}days.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                }
                
                showToast('✅ Reports exported successfully', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showToast('❌ Failed to export reports', 'error');
            }
        }

        async function exportStaffAudit() {
            // Check license tier before proceeding
            const currentLicense = await getCurrentLicenseInfo();
            if (currentLicense?.subscription_tier === 'basic') {
                showToast('❌ Staff Audit Export requires Pro or Enterprise license', 'error');
                return;
            }
            
            const period = document.getElementById('reportPeriod').value;
            
            try {
                showToast('🔍 Exporting staff audit data...', 'success');
                
                const response = await fetch(`/api/reports/staff-audit-export?period=${period}&format=csv`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `staff-audit-detailed-${period}days.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showToast('✅ Staff audit export completed', 'success');
                } else {
                    const error = await response.json();
                    showToast(`❌ ${error.message || 'Failed to export staff audit'}`, 'error');
                }
                
            } catch (error) {
                console.error('Staff audit export error:', error);
                showToast('❌ Failed to export staff audit data', 'error');
            }
        }

        // PPE & Inventory Management Functions
        async function loadPPEInventoryManagement() {
            // Load both PPE types and inventory by default (PPE types first)
            await loadPPEManagement();
            // Preload inventory data for faster switching
            await loadInventory();
        }

        function switchPPESubTab(subTab) {
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
            
            if (subTab === 'types') {
                document.getElementById('ppeTypesSubTab').classList.add('active');
                document.getElementById('ppeTypesSection').style.display = 'block';
                document.getElementById('stockLevelsSection').style.display = 'none';
            } else if (subTab === 'stock') {
                document.getElementById('stockLevelsSubTab').classList.add('active');
                document.getElementById('ppeTypesSection').style.display = 'none';
                document.getElementById('stockLevelsSection').style.display = 'block';
                // Refresh inventory when switching to stock tab
                loadInventory();
            }
            
            // Re-adjust mobile spacing when switching sub-tabs
            if (window.innerWidth <= 640 && typeof adjustMobilePPEInventorySpacing === 'function') {
                setTimeout(adjustMobilePPEInventorySpacing, 100);
            }
        }

        // PPE Management Functions
        async function loadPPEManagement() {
            try {
                console.log('Loading PPE management...');
                
                // Load both PPE types and their inventory threshold data
                const [ppeResponse, inventoryResponse] = await Promise.all([
                    fetch('/api/ppe-types', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch('/api/inventory-management/inventory', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                if (ppeResponse.ok) {
                    const ppeTypes = await ppeResponse.json();
                    console.log('PPE types loaded:', ppeTypes.length);
                    
                    let ppeWithThresholds = ppeTypes;
                    
                    // If inventory data is available, merge threshold information
                    if (inventoryResponse.ok) {
                        const inventoryData = await inventoryResponse.json();
                        console.log('Inventory data loaded:', inventoryData.length);
                        
                        ppeWithThresholds = ppeTypes.map(ppe => {
                            const inventory = inventoryData.find(inv => inv.ppe_item_id === ppe.id);
                            return {
                                ...ppe,
                                current_stock: inventory ? inventory.current_stock : 0,
                                min_threshold_inventory: inventory ? inventory.min_threshold : ppe.min_threshold || 10,
                                critical_threshold: inventory ? inventory.critical_threshold : 5,
                                inventory_id: inventory ? inventory.id : null
                            };
                        });
                    }
                    
                    displayPPETypes(ppeWithThresholds);
                } else {
                    console.error('Failed to load PPE types:', ppeResponse.status);
                    showToast('❌ Failed to load PPE types', 'error');
                }
            } catch (error) {
                console.error('Load PPE management error:', error);
                showToast('❌ Failed to load PPE management', 'error');
            }
        }

        function displayPPETypes(ppeTypes) {
            const tbody = document.getElementById('ppeTableBody');
            
            if (!ppeTypes || ppeTypes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">No PPE types found. Click "Add New PPE Type" to get started.</td></tr>';
                return;
            }

            tbody.innerHTML = ppeTypes.map(ppe => `
                <tr>
                    <td style="font-size: 24px; text-align: center;">${ppe.symbol || '🛡️'}</td>
                    <td style="font-weight: 500;">${ppe.name}</td>
                    <td style="font-family: monospace; background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${ppe.type}</td>
                    <td style="color: #6b7280; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${ppe.description || '-'}</td>
                    <td style="text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 2px;">
                            <span style="color: #059669;">$</span>
                            <input type="number" id="cost_${ppe.id}" value="${(ppe.unit_cost || 0).toFixed(2)}" 
                                   style="width: 70px; text-align: center; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; color: #059669; font-weight: 500;"
                                   min="0" step="0.01" onchange="updateUnitCost('${ppe.id}', this.value)">
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <input type="number" id="min_${ppe.id}" value="${ppe.min_threshold_inventory || ppe.min_threshold || 10}" 
                               style="width: 60px; text-align: center; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px;"
                               min="0" max="999" onchange="updateThreshold('${ppe.id}', 'min', this.value)">
                    </td>
                    <td style="text-align: center;">
                        <input type="number" id="critical_${ppe.id}" value="${ppe.critical_threshold || 5}" 
                               style="width: 60px; text-align: center; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px;"
                               min="0" max="999" onchange="updateThreshold('${ppe.id}', 'critical', this.value)">
                    </td>
                    <td>
                        <button onclick="editPPEType('${ppe.id}')" class="btn-secondary" style="font-size: 12px; padding: 4px 8px; margin-right: 4px;">
                            Edit
                        </button>
                        <button onclick="deletePPEType('${ppe.id}', '${ppe.name}')" class="btn-danger" style="font-size: 12px; padding: 4px 8px;">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load stations for PPE assignment
        async function loadStationsForPPE() {
            try {
                const response = await fetch('/api/stations');
                const data = await response.json();
                const stations = data.stations || data; // Handle both API formats
                const activeStations = stations.filter(station => station.active);
                
                // Try to load for both static and dynamic modals
                const containers = [
                    document.getElementById('stationSelection'),      // Static modal
                    document.getElementById('dynStationSelection')    // Dynamic modal
                ];
                
                const stationHTML = activeStations.length === 0 ? 
                    '<div style="text-align: center; color: #f59e0b; padding: 10px;">No active stations found</div>' :
                    activeStations.map(station => `
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; padding: 4px; cursor: pointer;">
                            <input type="checkbox" value="${station.id}" style="margin: 0;">
                            <span style="font-weight: 500;">${station.name}</span>
                            <small style="color: #6b7280;">- ${station.location || 'No location'}</small>
                        </label>
                    `).join('');
                
                containers.forEach(container => {
                    if (container) {
                        container.innerHTML = stationHTML;
                    }
                });
                
                console.log(`✅ Loaded ${activeStations.length} stations for PPE assignment`);
                
            } catch (error) {
                console.error('Error loading stations for PPE:', error);
                const containers = [
                    document.getElementById('stationSelection'),
                    document.getElementById('dynStationSelection')
                ];
                containers.forEach(container => {
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 10px;">Error loading stations</div>';
                    }
                });
            }
        }

        function showAddPPEModal() {
            // Remove any existing dynamic modal
            const existingModal = document.getElementById('dynamicAddPPEModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal dynamically to bypass CSS conflicts
            const modalHTML = `
                <div id="dynamicAddPPEModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                " onclick="if (event.target === this) closeDynamicAddPPEModal()">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        padding: 24px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #1f2937; font-size: 20px;">➕ Add New PPE Type</h3>
                            <button onclick="closeDynamicAddPPEModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
                        </div>
                        
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">PPE Name *</label>
                                <input type="text" id="dynPpeName" placeholder="e.g., Safety Shoes" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Type Code *</label>
                                <input type="text" id="dynPpeType" placeholder="e.g., SHOES" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Symbol *</label>
                                <input type="text" id="dynPpeSymbol" placeholder="e.g., 👞" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <small style="color: #6b7280;">Use emoji symbols (Windows: Win + . or Mac: Cmd + Control + Space)</small>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description</label>
                                <textarea id="dynPpeDescription" placeholder="Brief description of the PPE item" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; height: 60px;"></textarea>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Available at Stations *</label>
                                <div id="dynStationSelection" style="max-height: 120px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; background: #f9fafb;">
                                    <div style="text-align: center; color: #6b7280; padding: 10px;">Loading stations...</div>
                                </div>
                                <small style="color: #6b7280;">Select which stations can request this PPE type</small>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Unit Cost ($)</label>
                                <input type="number" id="dynPpeUnitCost" placeholder="e.g., 25.50" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <small style="color: #6b7280;">Cost per unit for budget tracking and analytics</small>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Minimum Threshold</label>
                                <input type="number" id="dynPpeMinThreshold" value="10" min="1" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button onclick="closeDynamicAddPPEModal()" style="
                                padding: 12px 24px;
                                background: #6b7280;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                            ">Cancel</button>
                            <button onclick="addDynamicPPEType()" style="
                                padding: 12px 24px;
                                background: var(--primary-color);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                            ">Add PPE Type</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Load stations after modal is added to DOM
            setTimeout(() => loadStationsForPPE(), 100);
        }
        
        function closeDynamicAddPPEModal() {
            const modal = document.getElementById('dynamicAddPPEModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function addDynamicPPEType() {
            const name = document.getElementById('dynPpeName').value.trim();
            const type = document.getElementById('dynPpeType').value.trim().toUpperCase();
            const symbol = document.getElementById('dynPpeSymbol').value.trim();
            const description = document.getElementById('dynPpeDescription').value.trim();
            const unitCost = parseFloat(document.getElementById('dynPpeUnitCost').value) || 0;
            const minThreshold = parseInt(document.getElementById('dynPpeMinThreshold').value) || 10;
            
            // Get selected stations
            const selectedStations = Array.from(document.querySelectorAll('#dynStationSelection input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (!name || !type || !symbol) {
                showToast('❌ Please fill in all required fields', 'error');
                return;
            }
            
            if (selectedStations.length === 0) {
                showToast('❌ Please select at least one station for this PPE type', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/ppe-types', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        type,
                        symbol,
                        description,
                        unitCost,
                        minThreshold,
                        selectedStations
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(`✅ ${result.message}`, 'success');
                    closeDynamicAddPPEModal();
                    loadPPEManagement();
                } else {
                    showToast(`❌ ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Add PPE type error:', error);
                showToast('❌ Failed to add PPE type', 'error');
            }
        }
        

        function closeAddPPEModal(event) {
            if (event && event.target.className !== 'modal-overlay' && !event.target.innerHTML.includes('&times;')) return;
            
            const modal = document.getElementById('addPPEModal');
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.opacity = '0';
            
            // Clear form
            document.getElementById('ppeName').value = '';
            document.getElementById('ppeType').value = '';
            document.getElementById('ppeSymbol').value = '';
            document.getElementById('ppeDescription').value = '';
            document.getElementById('ppeUnitCost').value = '';
            document.getElementById('ppeMinThreshold').value = '10';
            document.getElementById('ppeInitialStock').value = '20';
        }

        async function addPPEType() {
            // Check if stations are configured before allowing PPE creation
            try {
                const stationsResponse = await fetch('/api/stations');
                const stationsData = await stationsResponse.json();
                
                if (!stationsData.stations || stationsData.stations.length === 0) {
                    showToast('⚠️ Please configure at least one station before adding PPE types', 'error');
                    // Optionally switch to station management tab
                    if (confirm('No stations configured. Would you like to configure stations now?')) {
                        switchTab('station-management');
                    }
                    return;
                }
                
                const activeStations = stationsData.stations.filter(s => s.active);
                if (activeStations.length === 0) {
                    showToast('⚠️ Please activate at least one station before adding PPE types', 'error');
                    if (confirm('No active stations found. Would you like to configure stations now?')) {
                        switchTab('station-management');
                    }
                    return;
                }
            } catch (error) {
                console.error('Failed to check stations:', error);
                showToast('❌ Failed to verify station configuration', 'error');
                return;
            }
            
            const name = document.getElementById('ppeName').value.trim();
            const type = document.getElementById('ppeType').value.trim().toUpperCase();
            const symbol = document.getElementById('ppeSymbol').value.trim();
            const description = document.getElementById('ppeDescription').value.trim();
            const unitCost = parseFloat(document.getElementById('ppeUnitCost').value) || 0;
            const minThreshold = parseInt(document.getElementById('ppeMinThreshold').value) || 10;
            const initialStock = parseInt(document.getElementById('ppeInitialStock').value) || 0;
            
            if (!name || !type || !symbol || initialStock < 0) {
                showToast('❌ Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/ppe-types', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        type,
                        symbol,
                        description,
                        unitCost,
                        minThreshold,
                        initialStock
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(`✅ ${result.message}`, 'success');
                    closeAddPPEModal();
                    loadPPEManagement();
                } else {
                    showToast(`❌ ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Add PPE type error:', error);
                showToast('❌ Failed to add PPE type', 'error');
            }
        }

        function refreshPPEList() {
            animateRefreshButton(event, () => loadPPEManagement());
        }

        // Staff filtering functions
        function filterStaffByStatus() {
            applyCurrentFilters();
        }
        
        function filterStaffBySearch() {
            applyCurrentFilters();
        }
        
        function applyCurrentFilters() {
            const statusFilter = document.getElementById('staffStatusFilter')?.value || 'all';
            const searchTerm = document.getElementById('staffSearchInput')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('.staff-row');
            
            let visibleCount = 0;
            let visibleActive = 0;
            let visibleInactive = 0;
            
            rows.forEach(row => {
                const status = row.dataset.status;
                const name = row.dataset.name;
                const id = row.dataset.id;
                
                // Apply status filter
                let showByStatus = true;
                if (statusFilter === 'active' && status !== 'active') showByStatus = false;
                if (statusFilter === 'inactive' && status !== 'inactive') showByStatus = false;
                
                // Apply search filter
                let showBySearch = true;
                if (searchTerm && !name.includes(searchTerm) && !id.includes(searchTerm)) {
                    showBySearch = false;
                }
                
                // Show/hide row
                const shouldShow = showByStatus && showBySearch;
                row.style.display = shouldShow ? '' : 'none';
                
                if (shouldShow) {
                    visibleCount++;
                    if (status === 'active') visibleActive++;
                    else visibleInactive++;
                }
            });
            
            // Update filter info with visible counts
            const infoElement = document.getElementById('staffFilterInfo');
            if (infoElement) {
                infoElement.innerHTML = `Showing: ${visibleCount} | Active: ${visibleActive} | Inactive: ${visibleInactive}`;
            }
        }

        // Permanent delete functions
        async function permanentDeleteStaff(staffId, staffName) {
            const confirmMsg = `⚠️ PERMANENT DELETE WARNING ⚠️\n\nThis will permanently remove "${staffName}" (${staffId}) from the system.\n\n• All historical PPE request data will be preserved\n• Staff will be completely removed from directory\n• This action CANNOT be undone\n\nAre you absolutely sure?`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/staff/${staffId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast(`✅ ${staffName} permanently deleted from system`, 'success');
                    loadStaffManagement(); // Reload the staff list
                } else {
                    showToast(`❌ ${result.message || 'Failed to delete staff'}`, 'error');
                }
                
            } catch (error) {
                console.error('Delete staff error:', error);
                showToast('❌ Failed to delete staff', 'error');
            }
        }
        
        async function bulkDeleteInactiveStaff() {
            const inactiveStaff = originalStaffData.filter(staff => !staff.active);
            
            if (inactiveStaff.length === 0) {
                showToast('ℹ️ No inactive staff found to delete', 'info');
                return;
            }
            
            const confirmMsg = `⚠️ BULK DELETE WARNING ⚠️\n\nThis will permanently delete ${inactiveStaff.length} inactive staff members:\n\n${inactiveStaff.map(s => `• ${s.name} (${s.staff_id})`).join('\n')}\n\nThis action CANNOT be undone!\n\nContinue?`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                let deletedCount = 0;
                let failedCount = 0;
                
                showToast('🔄 Deleting inactive staff...', 'info');
                
                for (const staff of inactiveStaff) {
                    try {
                        const response = await fetch(`/api/staff/${staff.staff_id}/delete`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        
                        if (response.ok) {
                            deletedCount++;
                        } else {
                            failedCount++;
                        }
                    } catch (error) {
                        failedCount++;
                    }
                }
                
                if (deletedCount > 0) {
                    showToast(`✅ Successfully deleted ${deletedCount} inactive staff members`, 'success');
                }
                
                if (failedCount > 0) {
                    showToast(`⚠️ Failed to delete ${failedCount} staff members`, 'error');
                }
                
                loadStaffManagement(); // Reload the staff list
                
            } catch (error) {
                console.error('Bulk delete error:', error);
                showToast('❌ Bulk delete operation failed', 'error');
            }
        }

        async function updateThreshold(ppeItemId, thresholdType, value) {
            try {
                const threshold = parseInt(value);
                if (isNaN(threshold) || threshold < 0) {
                    showToast('❌ Invalid threshold value', 'error');
                    loadPPEManagement(); // Reload to reset values
                    return;
                }
                
                // Update threshold in inventory table
                const response = await fetch('/api/inventory-management/thresholds/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        stationId: 'store-1', // Currently using single station
                        ppeItemId: ppeItemId,
                        minThreshold: thresholdType === 'min' ? threshold : undefined,
                        criticalThreshold: thresholdType === 'critical' ? threshold : undefined
                    })
                });
                
                if (response.ok) {
                    showToast(`✅ ${thresholdType === 'min' ? 'Minimum' : 'Critical'} threshold updated`, 'success');
                } else {
                    showToast('❌ Failed to update threshold', 'error');
                    loadPPEManagement(); // Reload to reset values
                }
            } catch (error) {
                console.error('Update threshold error:', error);
                showToast('❌ Failed to update threshold', 'error');
                loadPPEManagement(); // Reload to reset values
            }
        }
        
        async function updateUnitCost(ppeId, value) {
            try {
                const unitCost = parseFloat(value);
                if (isNaN(unitCost) || unitCost < 0) {
                    showToast('❌ Invalid unit cost value', 'error');
                    loadPPEManagement(); // Reload to reset values
                    return;
                }
                
                // First get the current PPE item details
                const getCurrentResponse = await fetch(`/api/ppe-types/${ppeId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!getCurrentResponse.ok) {
                    showToast('❌ Failed to fetch current PPE data', 'error');
                    return;
                }
                
                const currentPpe = await getCurrentResponse.json();
                
                // Update only the unit cost while preserving other fields
                const updateResponse = await fetch(`/api/ppe-types/${ppeId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name: currentPpe.name,
                        type: currentPpe.type,
                        description: currentPpe.description || '',
                        symbol: currentPpe.symbol || '🛡️',
                        unitCost: unitCost,
                        minThreshold: currentPpe.min_threshold || 10
                    })
                });
                
                if (updateResponse.ok) {
                    showToast(`✅ Unit cost updated to $${unitCost.toFixed(2)}`, 'success');
                } else {
                    showToast('❌ Failed to update unit cost', 'error');
                    loadPPEManagement(); // Reload to reset values
                }
                
            } catch (error) {
                console.error('Update unit cost error:', error);
                showToast('❌ Failed to update unit cost', 'error');
                loadPPEManagement(); // Reload to reset values
            }
        }

        async function showStockUpdateModal() {
            try {
                // Get all inventory data for the modal
                const response = await fetch('/api/inventory-management/inventory', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    showToast('❌ Failed to load inventory data', 'error');
                    return;
                }
                
                const inventory = await response.json();
                
                // Create modal HTML
                const modalHTML = `
                    <div id="stockUpdateModal" class="modal-overlay" onclick="closeStockModal(event)">
                        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #1f2937;">📦 Update Stock Levels</h3>
                                <button onclick="closeStockModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <input type="text" id="stockModalSearch" placeholder="🔍 Search PPE items..." 
                                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;"
                                       oninput="filterStockModal()">
                            </div>
                            
                            <div id="stockItemsList" style="max-height: 400px; overflow-y: auto;">
                                ${inventory.map(item => `
                                    <div class="stock-item" data-name="${item.item_name.toLowerCase()}" 
                                         style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; background: white;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${item.item_name}</strong>
                                                <div style="font-size: 14px; color: #6b7280;">${item.station_name}</div>
                                                <div style="font-size: 14px; color: ${item.current_stock <= 10 ? '#dc2626' : '#059669'};">
                                                    Current: ${item.current_stock} / ${item.max_capacity}
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <button onclick="quickStockUpdate('${item.station_id}', '${item.ppe_item_id}', ${item.current_stock}, '${item.item_name}', 'subtract')"
                                                        class="btn-secondary" style="width: 40px; height: 40px; font-size: 18px; padding: 0;">−</button>
                                                <input type="number" id="stock_${item.ppe_item_id}" value="${item.current_stock}" min="0" max="999"
                                                       style="width: 80px; text-align: center; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;">
                                                <button onclick="quickStockUpdate('${item.station_id}', '${item.ppe_item_id}', ${item.current_stock}, '${item.item_name}', 'add')"
                                                        class="btn-primary" style="width: 40px; height: 40px; font-size: 18px; padding: 0;">+</button>
                                            </div>
                                        </div>
                                        <div style="margin-top: 12px;">
                                            <button onclick="applyStockUpdate('${item.station_id}', '${item.ppe_item_id}', ${item.current_stock}, '${item.item_name}')"
                                                    class="btn-primary" style="width: 100%; font-size: 14px;">Apply Changes</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: right;">
                                <button onclick="closeStockModal()" class="btn-secondary" style="margin-right: 12px;">Cancel</button>
                                <button onclick="bulkRestockAll()" class="btn-primary">🔄 Bulk Restock All (50 units)</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
            } catch (error) {
                console.error('Stock modal error:', error);
                showToast('❌ Failed to open stock update modal', 'error');
            }
        }

        function closeStockModal(event) {
            if (event && event.target.className !== 'modal-overlay') return;
            
            const modal = document.getElementById('stockUpdateModal');
            if (modal) {
                modal.remove();
            }
        }

        function filterStockModal() {
            const searchTerm = document.getElementById('stockModalSearch').value.toLowerCase();
            const items = document.querySelectorAll('.stock-item');
            
            items.forEach(item => {
                const itemName = item.dataset.name;
                item.style.display = itemName.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function quickStockUpdate(stationId, ppeItemId, currentStock, itemName, operation) {
            const input = document.getElementById(`stock_${ppeItemId}`);
            const currentValue = parseInt(input.value) || 0;
            
            if (operation === 'add') {
                input.value = currentValue + 1;
            } else if (operation === 'subtract' && currentValue > 0) {
                input.value = currentValue - 1;
            }
        }

        async function applyStockUpdate(stationId, ppeItemId, originalStock, itemName) {
            const input = document.getElementById(`stock_${ppeItemId}`);
            const newStock = parseInt(input.value) || 0;
            
            if (newStock === originalStock) {
                showToast('ℹ️ No changes to apply', 'info');
                return;
            }
            
            try {
                const difference = Math.abs(newStock - originalStock);
                const operation = newStock > originalStock ? 'ADD' : 'SUBTRACT';
                
                const response = await fetch('/api/inventory-management/stock/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        stationId,
                        ppeItemId,
                        quantity: difference,
                        operation
                    })
                });
                
                if (response.ok) {
                    showToast(`✅ ${itemName}: ${originalStock} → ${newStock}`, 'success');
                    
                    // Update the display immediately
                    const stockItem = input.closest('.stock-item');
                    const currentDisplay = stockItem.querySelector('div:nth-child(3)');
                    currentDisplay.innerHTML = `Current: ${newStock} / ${stockItem.querySelector('div:nth-child(3)').textContent.split('/')[1]}`;
                    currentDisplay.style.color = newStock <= 10 ? '#dc2626' : '#059669';
                    
                    // Reload main inventory table
                    loadInventory();
                } else {
                    showToast(`❌ Failed to update ${itemName}`, 'error');
                }
            } catch (error) {
                console.error('Apply stock update error:', error);
                showToast(`❌ Failed to update ${itemName}`, 'error');
            }
        }

        async function bulkRestockAll() {
            if (!confirm('This will set all PPE items in ALL stations to 50 units. Continue?')) return;
            
            try {
                console.log('Starting bulk restock for all stations...');
                
                const response = await fetch('/api/inventory-management/bulk-restock-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        quantity: 50
                    })
                });

                const data = await response.json();
                console.log('Bulk restock response:', data);
                
                if (data.success) {
                    const message = `✅ Restocked ${data.totalItemsRestocked} items across ${data.successfulStations}/${data.totalStations} stations`;
                    showToast(message, 'success');
                    
                    // Show detailed results in console
                    console.log('Detailed Results:');
                    data.details.forEach(detail => {
                        if (detail.success) {
                            console.log(`✅ ${detail.stationName}: ${detail.itemsRestocked} items restocked`);
                        } else {
                            console.error(`❌ ${detail.stationName}: ${detail.error}`);
                        }
                    });
                    
                    closeStockModal();
                    loadInventory(); // Refresh the inventory display
                } else {
                    showToast(`❌ Bulk restock failed: ${data.message}`, 'error');
                    console.error('Bulk restock failed:', data);
                }
                
                // Show any failures
                if (data.failedStations > 0) {
                    console.warn(`${data.failedStations} stations failed to restock. Check details above.`);
                }
                
            } catch (error) {
                console.error('Bulk restock error:', error);
                showToast('❌ Network error during bulk restock', 'error');
            }
        }

        function refreshStockLevels() {
            animateRefreshButton(event, () => loadInventory());
        }

        function editPPEType(ppeId) {
            showToast(`✏️ Edit PPE type feature coming soon!`, 'info');
        }

        async function deletePPEType(ppeId, ppeName) {
            if (!confirm(`Are you sure you want to delete "${ppeName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/ppe-types/${ppeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(`✅ ${result.message}`, 'success');
                    loadPPEManagement();
                } else {
                    showToast(`❌ ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Delete PPE type error:', error);
                showToast('❌ Failed to delete PPE type', 'error');
            }
        }


        // Contextual stat highlighting based on active tab
        function highlightContextualStats(tabName) {
            // Remove all existing highlights
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('stat-highlighted');
            });
            
            // Add contextual highlighting based on tab
            const statMappings = {
                'ppe-inventory': ['totalStock', 'lowStock'],
                'stock-alerts': ['lowStock'],
                'condition-reports': ['totalStock'],
                'station-management': ['totalStock'],
                'staff-management': ['pendingApprovals'],
                'reports': ['dailyIssued', 'totalStock'],
                'email-config': ['pendingApprovals'],
                'features': ['totalStock']
            };
            
            if (statMappings[tabName]) {
                statMappings[tabName].forEach(statId => {
                    const statElement = document.getElementById(statId);
                    if (statElement) {
                        const statCard = statElement.closest('.stat-card');
                        if (statCard) {
                            statCard.classList.add('stat-highlighted');
                        }
                    }
                });
            }
        }
        
        // Add dashboard quick-expand functionality
        function addDashboardInteractions() {
            const dashboardStats = document.getElementById('dashboardStats');
            if (!dashboardStats) return;
            
            // Click compact dashboard to expand temporarily
            dashboardStats.addEventListener('click', function(e) {
                if (this.classList.contains('compact') && !e.target.closest('[onclick]')) {
                    switchTab('dashboard'); // Switch to dashboard tab with full dashboard
                }
            });
            
            // Add subtle hover effect for compact mode
            dashboardStats.addEventListener('mouseenter', function() {
                if (this.classList.contains('compact')) {
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                }
            });
            
            dashboardStats.addEventListener('mouseleave', function() {
                if (this.classList.contains('compact')) {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                }
            });
        }
        
        // Initialize with authentication check
        async function initializeAdmin() {
            await validateUserData(); // Dynamic validation first
            checkStoredAuth();
            
            // Initialize dashboard interactions
            addDashboardInteractions();
            
            // Load departments for staff management
            await loadDepartments();
            
            // Set dashboard as default active tab
            switchTab('dashboard');
            
            // Always hide login modal first
            hideLoginModal();
            
            // If not authenticated, show login modal automatically
            if (!isAuthenticated) {
                showLoginModal();
                return;
            }
            
            // Only load dashboard if authenticated
            loadDashboardData();
        }
        
        // Load features for the company
        async function loadFeatures() {
            try {
                // Check if we have an auth token
                if (!authToken) {
                    console.error('No auth token available for features request');
                    document.getElementById('featuresContent').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc2626;">
                            <h4>Authentication Required</h4>
                            <p style="margin: 10px 0; font-size: 14px;">Please log in to view features</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                🔄 Refresh Page
                            </button>
                        </div>
                    `;
                    return;
                }

                console.log('Loading features with auth token:', authToken ? 'Present' : 'Missing');
                const response = await fetch('/api/features', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayFeatures(data);
                } else {
                    console.error('Features API error:', data);
                    document.getElementById('featuresContent').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc2626;">
                            <h4>Failed to load features</h4>
                            <p style="margin: 10px 0; font-size: 14px;">Status: ${response.status} ${response.statusText}</p>
                            <p style="margin: 10px 0; font-size: 12px;">Error: ${data.error || data.message || 'Unknown error'}</p>
                            <button onclick="loadFeatures()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                🔄 Retry
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Load features error:', error);
                document.getElementById('featuresContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc2626;">
                        <h4>Error loading features</h4>
                        <p style="margin: 10px 0; font-size: 14px;">Error: ${error.message}</p>
                        <p style="margin: 10px 0; font-size: 12px; color: #666;">Check browser console for more details</p>
                        <button onclick="loadFeatures()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            🔄 Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Display features by tier
        function displayFeatures(data) {
            const content = document.getElementById('featuresContent');
            
            const tierNames = {
                basic: 'Basic Plan',
                pro: 'Pro Plan (RM 89/month)',
                enterprise: 'Enterprise Plan (RM 149/month)'
            };
            
            const tierDescriptions = {
                basic: 'Essential PPE management features',
                pro: 'Advanced analytics and reporting',
                enterprise: 'Full customization and enterprise features'
            };
            
            // Check if we have license information
            if (data.requires_license || !data.license_status || data.license_status.status === 'invalid') {
                content.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="color: #dc2626; margin: 0 0 8px 0;">🔒 License Required</h3>
                            <p style="color: #7f1d1d; margin: 0 0 12px 0;">
                                ${data.message || data.error || 'No valid license found. Please activate your license to access features.'}
                            </p>
                        </div>
                        
                        <!-- License Activation Section -->
                        <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
                            <h4 style="color: #374151; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">🔐</span>
                                License Activation
                            </h4>
                            
                            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <button onclick="showLicenseMethod('file')" id="fileTabBtn" class="btn-secondary" style="flex: 1; padding: 12px;">
                                    📄 Upload License File
                                </button>
                                <button onclick="showLicenseMethod('text')" id="textTabBtn" class="btn-secondary" style="flex: 1; padding: 12px;">
                                    📝 Enter License Key
                                </button>
                            </div>
                            
                            <!-- File Upload Method -->
                            <div id="licenseFileMethod" style="display: none;">
                                <form id="licenseFileForm" enctype="multipart/form-data">
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select License File (.lic):</label>
                                        <div id="fileDropZone" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;">
                                            <div style="color: #6b7280; margin-bottom: 8px; font-size: 48px;">📁</div>
                                            <p style="margin: 0 0 8px 0; color: #374151;">Click to select or drag and drop your license file</p>
                                            <p style="margin: 0; color: #9ca3af; font-size: 14px;">Supported: .lic files (max 1MB)</p>
                                            <input type="file" id="licenseFileInput" name="licenseFile" accept=".lic" style="display: none;" />
                                        </div>
                                        <div id="selectedFileName" style="margin-top: 8px; color: #059669; font-weight: 500; display: none;"></div>
                                    </div>
                                    <button type="submit" class="btn-primary" style="width: 100%; padding: 12px;">
                                        🚀 Activate License
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Text Input Method -->
                            <div id="licenseTextMethod" style="display: none;">
                                <form id="licenseTextForm">
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">License Key:</label>
                                        <textarea id="licenseKeyInput" placeholder="Paste your license key here..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 14px; resize: vertical;"></textarea>
                                        <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 14px;">Enter the complete license key provided by your administrator</p>
                                    </div>
                                    <button type="submit" class="btn-primary" style="width: 100%; padding: 12px;">
                                        🚀 Activate License
                                    </button>
                                </form>
                            </div>
                            
                            <div id="licenseActivationStatus" style="margin-top: 16px; display: none;"></div>
                        </div>
                        
                        <div style="color: #6b7280; text-align: center;">
                            <p style="margin: 0 0 8px 0;">Need a license? Contact your system administrator</p>
                            <p style="margin: 0; font-size: 14px;">License files should be provided by authorized personnel only</p>
                        </div>
                    </div>
                `;
                
                // Initialize license activation interface
                initializeLicenseActivation();
                return;
            }
            
            const license = data.license_status;
            const statusColor = license.status === 'active' ? '#059669' : 
                               license.status === 'expiring_soon' ? '#d97706' : '#dc2626';
            const statusIcon = license.status === 'active' ? '✅' : 
                              license.status === 'expiring_soon' ? '⚠️' : '❌';
            
            let html = `
                <div style="margin-bottom: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                    <h4 style="margin: 0 0 8px 0; color: #0c4a6e;">📄 License Information</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
                        <div>
                            <strong>Client:</strong> ${license.client_name || 'Unknown'}<br>
                            <strong>Subscription:</strong> ${license.subscription_tier?.toUpperCase() || 'Unknown'}
                        </div>
                        <div>
                            <strong>Status:</strong> <span style="color: ${statusColor};">${statusIcon} ${license.status?.toUpperCase() || 'UNKNOWN'}</span><br>
                            <strong>Expires:</strong> ${license.expiration_date ? formatDateOnlyLocal(license.expiration_date) : 'Unknown'}
                        </div>
                        <div>
                            <strong>Days Remaining:</strong> ${license.days_remaining || 0}<br>
                            <strong>Max Employees:</strong> ${license.max_employees === -1 ? 'Unlimited' : license.max_employees}
                        </div>
                        <div id="employeeLimitAlert"></div>
                    </div>
                    <p style="margin: 0; color: #075985;">
                        ${data.enabled_count} of ${data.total_count} features enabled
                    </p>
                    <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <button onclick="toggleLicenseManagement()" class="btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                            🔧 Manage License
                        </button>
                    </div>
                </div>
                
                <!-- License Management Section (Initially Hidden) -->
                <div id="licenseManagementSection" style="display: none; margin-bottom: 24px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px;">
                    <h4 style="color: #374151; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">🔧</span>
                        License Management
                    </h4>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <button onclick="showManagementLicenseMethod('file')" id="managementFileTabBtn" class="btn-secondary" style="flex: 1; padding: 12px;">
                            📄 Upload New License File
                        </button>
                        <button onclick="showManagementLicenseMethod('text')" id="managementTextTabBtn" class="btn-secondary" style="flex: 1; padding: 12px;">
                            📝 Enter New License Key
                        </button>
                    </div>
                    
                    <!-- File Upload Method -->
                    <div id="managementLicenseFileMethod" style="display: none;">
                        <form id="managementLicenseFileForm" enctype="multipart/form-data">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select License File (.lic):</label>
                                <div id="managementFileDropZone" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;">
                                    <div style="color: #6b7280; margin-bottom: 8px; font-size: 48px;">📁</div>
                                    <p style="margin: 0 0 8px 0; color: #374151;">Click to select or drag and drop your license file</p>
                                    <p style="margin: 0; color: #9ca3af; font-size: 14px;">This will replace your current license</p>
                                    <input type="file" id="managementLicenseFileInput" name="licenseFile" accept=".lic" style="display: none;" />
                                </div>
                                <div id="managementSelectedFileName" style="margin-top: 8px; color: #059669; font-weight: 500; display: none;"></div>
                            </div>
                            <button type="submit" class="btn-primary" style="width: 100%; padding: 12px;">
                                🚀 Update License
                            </button>
                        </form>
                    </div>
                    
                    <!-- Text Input Method -->
                    <div id="managementLicenseTextMethod" style="display: none;">
                        <form id="managementLicenseTextForm">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">New License Key:</label>
                                <textarea id="managementLicenseKeyInput" placeholder="Paste your new license key here..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 14px; resize: vertical;"></textarea>
                                <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 14px;">This will replace your current license</p>
                            </div>
                            <button type="submit" class="btn-primary" style="width: 100%; padding: 12px;">
                                🚀 Update License
                            </button>
                        </form>
                    </div>
                    
                    <div id="managementLicenseActivationStatus" style="margin-top: 16px; display: none;"></div>
                </div>
            `;
            
            Object.keys(data.features).forEach(tier => {
                const features = data.features[tier];
                const enabled = features.filter(f => f.enabled).length;
                const total = features.length;
                
                html += `
                    <div style="margin-bottom: 16px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <div onclick="toggleTierFeatures('${tier}')" style="background: ${tier === 'basic' ? '#f3f4f6' : tier === 'pro' ? '#fef3c7' : '#f3e8ff'}; padding: 16px; cursor: pointer; user-select: none; transition: background-color 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <h4 style="margin: 0 0 4px 0; color: #1f2937;">${tierNames[tier]}</h4>
                                    <p style="margin: 0; color: #6b7280; font-size: 14px;">${tierDescriptions[tier]}</p>
                                    <div style="margin-top: 8px;">
                                        <span style="font-size: 12px; color: ${enabled === total ? '#059669' : '#d97706'}; font-weight: 600;">
                                            ${enabled}/${total} features enabled
                                        </span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; color: #6b7280;">
                                    <span id="tier-arrow-${tier}" style="font-size: 20px; transition: transform 0.2s;">▼</span>
                                </div>
                            </div>
                        </div>
                        <div id="tier-content-${tier}" style="padding: 16px; display: none; border-top: 1px solid #e5e7eb;">
                `;
                
                if (features.length === 0) {
                    html += '<p style="color: #6b7280; margin: 0;">No features in this tier</p>';
                } else {
                    features.forEach(feature => {
                        const status = feature.enabled ? '✅' : '🔒';
                        const statusColor = feature.enabled ? '#059669' : '#6b7280';
                        
                        html += `
                            <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                                <span style="margin-right: 8px; font-size: 18px;">${status}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: ${statusColor};">${feature.name}</div>
                                    <div style="font-size: 14px; color: #6b7280;">${feature.description}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div></div>';
            });
            
            content.innerHTML = html;
        }
        
        // Toggle tier features dropdown
        function toggleTierFeatures(tier) {
            const content = document.getElementById(`tier-content-${tier}`);
            const arrow = document.getElementById(`tier-arrow-${tier}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        // Initialize license activation interface
        function initializeLicenseActivation() {
            // Show file method by default
            showLicenseMethod('file');
            
            // Setup file drop zone
            const dropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('licenseFileInput');
            
            if (dropZone && fileInput) {
                dropZone.addEventListener('click', () => fileInput.click());
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#3b82f6';
                    dropZone.style.backgroundColor = '#eff6ff';
                });
                
                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#d1d5db';
                    dropZone.style.backgroundColor = 'transparent';
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#d1d5db';
                    dropZone.style.backgroundColor = 'transparent';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        showSelectedFile(files[0]);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        showSelectedFile(e.target.files[0]);
                    }
                });
            }
            
            // Setup form handlers
            const fileForm = document.getElementById('licenseFileForm');
            const textForm = document.getElementById('licenseTextForm');
            
            if (fileForm) {
                fileForm.addEventListener('submit', handleFileUpload);
            }
            
            if (textForm) {
                textForm.addEventListener('submit', handleTextActivation);
            }
        }
        
        // Show selected license method
        function showLicenseMethod(method) {
            const fileMethod = document.getElementById('licenseFileMethod');
            const textMethod = document.getElementById('licenseTextMethod');
            const fileBtn = document.getElementById('fileTabBtn');
            const textBtn = document.getElementById('textTabBtn');
            
            if (method === 'file') {
                fileMethod.style.display = 'block';
                textMethod.style.display = 'none';
                fileBtn.classList.remove('btn-secondary');
                fileBtn.classList.add('btn-primary');
                textBtn.classList.remove('btn-primary');
                textBtn.classList.add('btn-secondary');
            } else {
                fileMethod.style.display = 'none';
                textMethod.style.display = 'block';
                textBtn.classList.remove('btn-secondary');
                textBtn.classList.add('btn-primary');
                fileBtn.classList.remove('btn-primary');
                fileBtn.classList.add('btn-secondary');
            }
        }
        
        // Show selected file name
        function showSelectedFile(file) {
            const selectedFileName = document.getElementById('selectedFileName');
            if (selectedFileName) {
                selectedFileName.textContent = `✅ Selected: ${file.name}`;
                selectedFileName.style.display = 'block';
            }
        }
        
        // Handle file upload activation
        async function handleFileUpload(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('licenseFileInput');
            const statusDiv = document.getElementById('licenseActivationStatus');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showLicenseStatus('error', '❌ Please select a license file');
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.lic')) {
                showLicenseStatus('error', '❌ Please select a valid .lic license file');
                return;
            }
            
            const formData = new FormData();
            formData.append('licenseFile', file);
            
            try {
                showLicenseStatus('loading', '⏳ Uploading and validating license...');
                
                const response = await fetch('/api/license/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showLicenseStatus('success', `✅ ${result.message}`);
                    setTimeout(() => {
                        showToast('🎉 License activated successfully! Refreshing features...', 'success');
                        loadFeatures(); // Reload the features
                    }, 1500);
                } else {
                    showLicenseStatus('error', `❌ ${result.error || 'License activation failed'}`);
                }
                
            } catch (error) {
                console.error('License upload error:', error);
                showLicenseStatus('error', '❌ Network error. Please try again.');
            }
        }
        
        // Handle text input activation
        async function handleTextActivation(e) {
            e.preventDefault();
            
            const licenseKeyInput = document.getElementById('licenseKeyInput');
            const licenseKey = licenseKeyInput.value.trim();
            
            if (!licenseKey) {
                showLicenseStatus('error', '❌ Please enter a license key');
                return;
            }
            
            try {
                showLicenseStatus('loading', '⏳ Validating license key...');
                
                const response = await fetch('/api/license/activate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ licenseKey })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showLicenseStatus('success', `✅ ${result.message}`);
                    setTimeout(() => {
                        showToast('🎉 License activated successfully! Refreshing features...', 'success');
                        loadFeatures(); // Reload the features
                    }, 1500);
                } else {
                    showLicenseStatus('error', `❌ ${result.error || 'License activation failed'}`);
                }
                
            } catch (error) {
                console.error('License activation error:', error);
                showLicenseStatus('error', '❌ Network error. Please try again.');
            }
        }
        
        // Show license activation status
        function showLicenseStatus(type, message) {
            const statusDiv = document.getElementById('licenseActivationStatus');
            if (!statusDiv) return;
            
            const colors = {
                loading: { bg: '#fef3c7', border: '#fde68a', text: '#d97706' },
                success: { bg: '#dcfce7', border: '#bbf7d0', text: '#059669' },
                error: { bg: '#fee2e2', border: '#fecaca', text: '#dc2626' }
            };
            
            const color = colors[type] || colors.error;
            
            statusDiv.innerHTML = `
                <div style="background: ${color.bg}; border: 1px solid ${color.border}; border-radius: 6px; padding: 12px; color: ${color.text};">
                    ${message}
                </div>
            `;
            statusDiv.style.display = 'block';
        }
        
        // Toggle license management section
        function toggleLicenseManagement() {
            const section = document.getElementById('licenseManagementSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                initializeManagementLicenseInterface();
            } else {
                section.style.display = 'none';
            }
        }
        
        // Initialize license management interface
        function initializeManagementLicenseInterface() {
            // Show file method by default
            showManagementLicenseMethod('file');
            
            // Setup file drop zone
            const dropZone = document.getElementById('managementFileDropZone');
            const fileInput = document.getElementById('managementLicenseFileInput');
            
            if (dropZone && fileInput) {
                dropZone.addEventListener('click', () => fileInput.click());
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#3b82f6';
                    dropZone.style.backgroundColor = '#eff6ff';
                });
                
                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#d1d5db';
                    dropZone.style.backgroundColor = 'transparent';
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#d1d5db';
                    dropZone.style.backgroundColor = 'transparent';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        showManagementSelectedFile(files[0]);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        showManagementSelectedFile(e.target.files[0]);
                    }
                });
            }
            
            // Setup form handlers
            const fileForm = document.getElementById('managementLicenseFileForm');
            const textForm = document.getElementById('managementLicenseTextForm');
            
            if (fileForm) {
                fileForm.addEventListener('submit', handleManagementFileUpload);
            }
            
            if (textForm) {
                textForm.addEventListener('submit', handleManagementTextActivation);
            }
        }
        
        // Show selected license method for management
        function showManagementLicenseMethod(method) {
            const fileMethod = document.getElementById('managementLicenseFileMethod');
            const textMethod = document.getElementById('managementLicenseTextMethod');
            const fileBtn = document.getElementById('managementFileTabBtn');
            const textBtn = document.getElementById('managementTextTabBtn');
            
            if (method === 'file') {
                fileMethod.style.display = 'block';
                textMethod.style.display = 'none';
                fileBtn.classList.remove('btn-secondary');
                fileBtn.classList.add('btn-primary');
                textBtn.classList.remove('btn-primary');
                textBtn.classList.add('btn-secondary');
            } else {
                fileMethod.style.display = 'none';
                textMethod.style.display = 'block';
                textBtn.classList.remove('btn-secondary');
                textBtn.classList.add('btn-primary');
                fileBtn.classList.remove('btn-primary');
                fileBtn.classList.add('btn-secondary');
            }
        }
        
        // Show selected file name for management
        function showManagementSelectedFile(file) {
            const selectedFileName = document.getElementById('managementSelectedFileName');
            if (selectedFileName) {
                selectedFileName.textContent = `✅ Selected: ${file.name}`;
                selectedFileName.style.display = 'block';
            }
        }
        
        // Handle management file upload
        async function handleManagementFileUpload(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('managementLicenseFileInput');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showManagementLicenseStatus('error', '❌ Please select a license file');
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.lic')) {
                showManagementLicenseStatus('error', '❌ Please select a valid .lic license file');
                return;
            }
            
            const formData = new FormData();
            formData.append('licenseFile', file);
            
            try {
                showManagementLicenseStatus('loading', '⏳ Uploading and validating new license...');
                
                const response = await fetch('/api/license/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showManagementLicenseStatus('success', `✅ ${result.message}`);
                    setTimeout(() => {
                        showToast('🎉 License updated successfully! Refreshing features...', 'success');
                        loadFeatures(); // Reload the features
                        document.getElementById('licenseManagementSection').style.display = 'none';
                    }, 1500);
                } else {
                    showManagementLicenseStatus('error', `❌ ${result.error || 'License update failed'}`);
                }
                
            } catch (error) {
                console.error('License upload error:', error);
                showManagementLicenseStatus('error', '❌ Network error. Please try again.');
            }
        }
        
        // Handle management text activation
        async function handleManagementTextActivation(e) {
            e.preventDefault();
            
            const licenseKeyInput = document.getElementById('managementLicenseKeyInput');
            const licenseKey = licenseKeyInput.value.trim();
            
            if (!licenseKey) {
                showManagementLicenseStatus('error', '❌ Please enter a license key');
                return;
            }
            
            try {
                showManagementLicenseStatus('loading', '⏳ Validating new license key...');
                
                const response = await fetch('/api/license/activate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ licenseKey })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showManagementLicenseStatus('success', `✅ ${result.message}`);
                    setTimeout(() => {
                        showToast('🎉 License updated successfully! Refreshing features...', 'success');
                        loadFeatures(); // Reload the features
                        document.getElementById('licenseManagementSection').style.display = 'none';
                    }, 1500);
                } else {
                    showManagementLicenseStatus('error', `❌ ${result.error || 'License update failed'}`);
                }
                
            } catch (error) {
                console.error('License activation error:', error);
                showManagementLicenseStatus('error', '❌ Network error. Please try again.');
            }
        }
        
        // Show management license status
        function showManagementLicenseStatus(type, message) {
            const statusDiv = document.getElementById('managementLicenseActivationStatus');
            if (!statusDiv) return;
            
            const colors = {
                loading: { bg: '#fef3c7', border: '#fde68a', text: '#d97706' },
                success: { bg: '#dcfce7', border: '#bbf7d0', text: '#059669' },
                error: { bg: '#fee2e2', border: '#fecaca', text: '#dc2626' }
            };
            
            const color = colors[type] || colors.error;
            
            statusDiv.innerHTML = `
                <div style="background: ${color.bg}; border: 1px solid ${color.border}; border-radius: 6px; padding: 12px; color: ${color.text};">
                    ${message}
                </div>
            `;
            statusDiv.style.display = 'block';
        }
        
        
        // Animate refresh button with spinning effect
        function animateRefreshButton(event, callback) {
            if (!event || !event.target) return;
            
            const button = event.target.closest('button');
            if (!button) return;
            
            // Add spinning animation
            button.classList.add('refreshing');
            button.disabled = true;
            
            // Execute the callback function
            const result = callback();
            
            // If callback returns a promise, wait for it
            if (result && typeof result.then === 'function') {
                result.finally(() => {
                    setTimeout(() => {
                        button.classList.remove('refreshing');
                        button.disabled = false;
                    }, 500); // Minimum animation time
                });
            } else {
                setTimeout(() => {
                    button.classList.remove('refreshing');
                    button.disabled = false;
                }, 500);
            }
        }

        // Professional Analytics Chart Functions
        let currentChart = null;
        let currentAnalyticsType = null;

        // Handle window resize for mobile responsiveness
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                // Refresh current chart with new mobile settings
                if (currentChart && currentAnalyticsType) {
                    loadProfessionalChart(currentAnalyticsType);
                }
                
                // Refresh mini charts as well
                if (window.location.hash === '#reports' || document.querySelector('.reports-container')) {
                    loadMiniCharts();
                }
            }, 300);
        });

        async function openAnalyticsChart(type) {
            currentAnalyticsType = type;
            const modal = document.getElementById('analyticsModal');
            const titleMap = {
                'usage': '📈 Usage Analytics - Professional Charts',
                'department': '🏢 Department Reports - Professional Charts', 
                'ppe': '🛡️ PPE Analytics - Professional Charts',
                'cost': '💰 Cost Analysis - Professional Charts',
                'staff': '👥 Worker Tracking - Professional Charts'
            };
            
            document.getElementById('analyticsModalTitle').textContent = titleMap[type] || '📊 Professional Analytics';
            
            // Add zoom-in animation effect
            modal.style.transform = 'scale(0.8)';
            modal.style.opacity = '0';
            modal.classList.remove('hidden');
            
            // Animate modal appearance
            requestAnimationFrame(() => {
                modal.style.transition = 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                modal.style.transform = 'scale(1)';
                modal.style.opacity = '1';
            });
            
            // Load chart data
            await loadProfessionalChart(type);
        }

        function closeAnalyticsModal() {
            const modal = document.getElementById('analyticsModal');
            
            // Add zoom-out animation effect
            modal.style.transition = 'all 0.2s ease-out';
            modal.style.transform = 'scale(0.8)';
            modal.style.opacity = '0';
            
            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.style.transform = '';
                modal.style.opacity = '';
                modal.style.transition = '';
            }, 200);
            
            // Destroy current chart
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
        }

        async function refreshChart() {
            if (currentAnalyticsType) {
                animateRefreshButton(event, () => loadProfessionalChart(currentAnalyticsType));
            }
        }

        async function loadProfessionalChart(type) {
            const period = document.getElementById('chartPeriod').value;
            const container = document.getElementById('analyticsChartContainer');
            
            try {
                // Show loading
                container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 16px;">⏳</div><p>Loading professional analytics...</p></div>';
                
                let endpoint, chartConfig;
                
                switch (type) {
                    case 'usage':
                        endpoint = `/api/reports/usage-analytics?period=${period}&groupBy=day`;
                        chartConfig = createUsageChart;
                        break;
                    case 'department':
                        endpoint = `/api/reports/department-analytics?period=${period}`;
                        chartConfig = createDepartmentChart;
                        break;
                    case 'ppe':
                        endpoint = `/api/reports/ppe-analytics?period=${period}`;
                        chartConfig = createPPEChart;
                        break;
                    case 'cost':
                        endpoint = `/api/reports/cost-analysis?period=${period}`;
                        chartConfig = createCostChart;
                        break;
                    case 'staff':
                        endpoint = `/api/reports/staff-analytics?period=${period}`;
                        chartConfig = createStaffChart;
                        break;
                    default:
                        throw new Error('Unknown chart type');
                }
                
                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Restore canvas
                    container.innerHTML = '<canvas id="analyticsChart" width="800" height="400"></canvas>';
                    
                    // Create chart
                    await chartConfig(data);
                } else {
                    const error = await response.json();
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;"><div style="font-size: 48px; margin-bottom: 16px;">❌</div><p>${error.message || 'Failed to load analytics data'}</p></div>`;
                }
                
            } catch (error) {
                console.error('Chart loading error:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;"><div style="font-size: 48px; margin-bottom: 16px;">❌</div><p>Failed to load chart data</p></div>';
            }
        }

        async function createUsageChart(data) {
            console.log('🎯 Creating usage chart with data:', data);
            
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            const chartData = data.data.slice(-30); // Last 30 data points
            console.log('📊 Chart data points:', chartData.length, chartData);
            
            // Handle empty data
            if (chartData.length === 0) {
                console.log('❌ No chart data available');
                document.getElementById('analyticsChartContainer').innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;"><div style="font-size: 48px; margin-bottom: 16px;">📊</div><p>No usage data available for the selected period.<br><small>Submit some PPE requests to see analytics.</small></p></div>';
                return;
            }
            
            // Use bar chart for single data point, line chart for multiple
            const chartType = chartData.length === 1 ? 'bar' : 'line';
            console.log('📈 Using chart type:', chartType);
            
            currentChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: chartData.map(item => item.period),
                    datasets: [{
                        label: 'Total Requests',
                        data: chartData.map(item => item.total_requests),
                        borderColor: '#3b82f6',
                        backgroundColor: chartType === 'bar' ? 'rgba(59, 130, 246, 0.7)' : 'rgba(59, 130, 246, 0.1)',
                        tension: chartType === 'line' ? 0.4 : 0
                    }, {
                        label: 'Total Items',
                        data: chartData.map(item => item.total_items),
                        borderColor: '#000000',
                        backgroundColor: chartType === 'bar' ? 'rgba(16, 185, 129, 0.7)' : 'rgba(16, 185, 129, 0.1)',
                        tension: chartType === 'line' ? 0.4 : 0
                    }, {
                        label: 'Approved Requests',
                        data: chartData.map(item => item.approved_requests),
                        borderColor: '#059669',
                        backgroundColor: chartType === 'bar' ? 'rgba(5, 150, 105, 0.7)' : 'rgba(5, 150, 105, 0.1)',
                        tension: chartType === 'line' ? 0.4 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'PPE Usage Trends Over Time',
                            font: {
                                size: window.innerWidth <= 768 ? 14 : 16
                            }
                        },
                        legend: {
                            position: window.innerWidth <= 768 ? 'bottom' : 'top',
                            display: window.innerWidth > 480,
                            labels: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                boxWidth: window.innerWidth <= 480 ? 10 : 15
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                maxRotation: window.innerWidth <= 480 ? 90 : 45
                            }
                        }
                    }
                }
            });
        }

        async function createDepartmentChart(data) {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            // Filter and clean department data
            let chartData = data.data
                .filter(item => item.department && item.department.trim() !== '') // Remove empty departments
                .map(item => ({
                    ...item,
                    department: item.department === 'Unknown Department' || item.department === 'Unknown' ? 'Unspecified' : item.department
                }))
                .slice(0, 10); // Top 10 departments
            
            // If no valid departments, show placeholder
            if (chartData.length === 0) {
                chartData = [{ department: 'No Data Available', total_requests: 1 }];
            }
            
            currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.map(item => item.department),
                    datasets: [{
                        data: chartData.map(item => item.total_requests),
                        backgroundColor: [
                            '#3B82F6', '#06B6D4', '#8B5CF6', '#10B981', '#F59E0B',
                            '#EF4444', '#EC4899', '#6366F1', '#84CC16', '#F97316'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'PPE Requests by Department',
                            font: {
                                size: window.innerWidth <= 768 ? 14 : 16
                            }
                        },
                        legend: {
                            position: window.innerWidth <= 768 ? 'bottom' : 'right',
                            display: window.innerWidth > 480,
                            labels: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                boxWidth: window.innerWidth <= 480 ? 10 : 15,
                                padding: window.innerWidth <= 480 ? 10 : 20
                            }
                        }
                    }
                }
            });
        }

        async function createStaffChart(data) {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            const chartData = data.data.slice(0, 15); // Top 15 workers
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(item => item.staff_name),
                    datasets: [{
                        label: 'Total Requests',
                        data: chartData.map(item => item.total_requests),
                        backgroundColor: '#3B82F6'
                    }, {
                        label: 'Total Items',
                        data: chartData.map(item => item.total_items),
                        backgroundColor: '#06B6D4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Individual Worker PPE Usage',
                            font: {
                                size: window.innerWidth <= 768 ? 14 : 16
                            }
                        },
                        legend: {
                            display: window.innerWidth > 480,
                            position: window.innerWidth <= 768 ? 'bottom' : 'top',
                            labels: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                boxWidth: window.innerWidth <= 480 ? 10 : 15
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                maxRotation: window.innerWidth <= 480 ? 90 : 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 4,
                            borderSkipped: false
                        }
                    },
                    datasets: {
                        bar: {
                            maxBarThickness: chartData.length === 1 ? 60 : (chartData.length <= 3 ? 80 : 120),
                            barPercentage: chartData.length === 1 ? 0.4 : (chartData.length <= 3 ? 0.7 : 0.8),
                            categoryPercentage: chartData.length === 1 ? 0.5 : (chartData.length <= 3 ? 0.8 : 0.9)
                        }
                    }
                }
            });
        }

        async function createPPEChart(data) {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            const chartData = data.data.slice(0, 10); // Top 10 PPE items
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(item => item.ppe_item),
                    datasets: [{
                        label: 'Total Quantity',
                        data: chartData.map(item => item.total_quantity),
                        backgroundColor: '#8B5CF6'
                    }]
                },
                options: {
                    indexAxis: window.innerWidth <= 768 ? 'x' : 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Most Requested PPE Items',
                            font: {
                                size: window.innerWidth <= 768 ? 14 : 16
                            }
                        },
                        legend: {
                            display: window.innerWidth > 480,
                            position: window.innerWidth <= 768 ? 'bottom' : 'top',
                            labels: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                maxRotation: window.innerWidth <= 480 ? 90 : 45
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 4,
                            borderSkipped: false
                        }
                    },
                    datasets: {
                        bar: {
                            maxBarThickness: chartData.length === 1 ? 60 : (chartData.length <= 3 ? 80 : 120),
                            barPercentage: chartData.length === 1 ? 0.4 : (chartData.length <= 3 ? 0.7 : 0.8),
                            categoryPercentage: chartData.length === 1 ? 0.5 : (chartData.length <= 3 ? 0.8 : 0.9)
                        }
                    }
                }
            });
        }

        async function createCostChart(data) {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            const chartData = data.data.slice(0, 10); // Top 10 cost items
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(item => item.ppe_item),
                    datasets: [{
                        label: 'Total Cost ($)',
                        data: chartData.map(item => item.total_cost),
                        backgroundColor: '#10B981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'PPE Cost Analysis',
                            font: {
                                size: window.innerWidth <= 768 ? 14 : 16
                            }
                        },
                        legend: {
                            display: window.innerWidth > 480,
                            position: window.innerWidth <= 768 ? 'bottom' : 'top',
                            labels: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                maxRotation: window.innerWidth <= 480 ? 90 : 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                },
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 4,
                            borderSkipped: false
                        }
                    },
                    datasets: {
                        bar: {
                            maxBarThickness: chartData.length === 1 ? 60 : (chartData.length <= 3 ? 80 : 120),
                            barPercentage: chartData.length === 1 ? 0.4 : (chartData.length <= 3 ? 0.7 : 0.8),
                            categoryPercentage: chartData.length === 1 ? 0.5 : (chartData.length <= 3 ? 0.8 : 0.9)
                        }
                    }
                }
            });
        }

        async function exportChart() {
            if (currentChart) {
                const link = document.createElement('a');
                link.download = `${currentAnalyticsType}-analytics-chart.png`;
                link.href = currentChart.toBase64Image();
                link.click();
                showToast('📊 Chart exported successfully', 'success');
            }
        }

        // Check employee limits and show alerts
        async function checkEmployeeLimits() {
            try {
                const response = await fetch('/api/features/employee-limit', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const employeeLimit = data.employee_limit;
                    const alertDiv = document.getElementById('employeeLimitAlert');
                    
                    // Only update if the element exists (Features section is visible)
                    if (!alertDiv) {
                        return; // Element not found, probably Features section not loaded yet
                    }
                    
                    // Handle unlimited employees properly
                    if (employeeLimit.is_unlimited || employeeLimit.max_employees === -1) {
                        alertDiv.innerHTML = `
                            <div style="background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 8px; padding: 12px; margin-top: 12px;">
                                <h5 style="color: #059669; margin: 0 0 4px 0;">✅ Unlimited Employees</h5>
                                <p style="color: #047857; margin: 0; font-size: 14px;">
                                    ${employeeLimit.current_employees} active employees. Your plan includes unlimited employee access.
                                </p>
                            </div>
                        `;
                    } else if (employeeLimit.exceeded) {
                        alertDiv.innerHTML = `
                            <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-top: 12px;">
                                <h5 style="color: #dc2626; margin: 0 0 4px 0;">⚠️ Employee Limit Exceeded</h5>
                                <p style="color: #7f1d1d; margin: 0; font-size: 14px;">
                                    You have ${employeeLimit.current_employees} active employees but your license only allows ${employeeLimit.max_employees}. 
                                    Please deactivate ${employeeLimit.current_employees - employeeLimit.max_employees} employees or upgrade your license.
                                </p>
                            </div>
                        `;
                    } else if (employeeLimit.remaining <= 5 && employeeLimit.remaining > 0) {
                        alertDiv.innerHTML = `
                            <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 12px; margin-top: 12px;">
                                <h5 style="color: #d97706; margin: 0 0 4px 0;">⚠️ Approaching Employee Limit</h5>
                                <p style="color: #92400e; margin: 0; font-size: 14px;">
                                    You have ${employeeLimit.current_employees} of ${employeeLimit.max_employees} employees. Only ${employeeLimit.remaining} slots remaining.
                                </p>
                            </div>
                        `;
                    } else {
                        alertDiv.innerHTML = `
                            <div style="background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 8px; padding: 12px; margin-top: 12px;">
                                <h5 style="color: #059669; margin: 0 0 4px 0;">✅ Employee Limit OK</h5>
                                <p style="color: #047857; margin: 0; font-size: 14px;">
                                    ${employeeLimit.current_employees} of ${employeeLimit.max_employees} employees used. ${employeeLimit.remaining} slots available.
                                </p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error checking employee limits:', error);
            }
        }
        
        // ==========================================
        // DEPARTMENT MANAGEMENT FUNCTIONS
        // ==========================================
        
        // Load departments into dropdown
        async function loadDepartments() {
            try {
                const response = await fetch('/api/departments', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const departments = data.departments || [];
                    
                    // Update both dropdowns
                    const editSelect = document.getElementById('editStaffDepartment');
                    const addSelect = document.getElementById('addStaffDepartment');
                    
                    // Clear existing options (except first)
                    editSelect.innerHTML = '<option value="">Select department...</option>';
                    addSelect.innerHTML = '<option value="">Select department...</option>';
                    
                    // Add departments
                    departments.forEach(dept => {
                        const option = `<option value="${dept.name}">${dept.name}</option>`;
                        editSelect.innerHTML += option;
                        addSelect.innerHTML += option;
                    });
                    
                    // Add "Add New Department" option
                    const addNewOption = '<option value="__ADD_NEW__" style="font-style: italic; color: #059669;">+ Add New Department</option>';
                    editSelect.innerHTML += addNewOption;
                    addSelect.innerHTML += addNewOption;
                    
                } else {
                    console.error('Failed to load departments');
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }
        
        // Handle department selection (including add new)
        function handleDepartmentSelection(selectElement) {
            if (selectElement.value === '__ADD_NEW__') {
                const newDepartment = prompt('Enter new department name:');
                if (newDepartment && newDepartment.trim()) {
                    addNewDepartment(newDepartment.trim(), selectElement);
                } else {
                    selectElement.value = ''; // Reset selection
                }
            }
        }
        
        // Add new department
        async function addNewDepartment(name, selectElement) {
            try {
                const response = await fetch('/api/departments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        name: name,
                        description: `${name} department`
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(`✅ Department "${name}" added successfully`, 'success');
                    
                    // Reload departments
                    await loadDepartments();
                    
                    // Select the new department
                    selectElement.value = name;
                } else {
                    const error = await response.json();
                    showToast(`❌ Failed to add department: ${error.error}`, 'error');
                    selectElement.value = ''; // Reset selection
                }
            } catch (error) {
                console.error('Error adding department:', error);
                showToast('❌ Failed to add department', 'error');
                selectElement.value = ''; // Reset selection
            }
        }
        
        // Add event listeners for department selection
        document.addEventListener('DOMContentLoaded', () => {
            const editDeptSelect = document.getElementById('editStaffDepartment');
            const addDeptSelect = document.getElementById('addStaffDepartment');
            
            if (editDeptSelect) {
                editDeptSelect.addEventListener('change', () => handleDepartmentSelection(editDeptSelect));
            }
            
            if (addDeptSelect) {
                addDeptSelect.addEventListener('change', () => handleDepartmentSelection(addDeptSelect));
            }
        });

        // Initialize
        initializeAdmin();
        
        // Check employee limits after loading features
        setTimeout(() => {
            checkEmployeeLimits();
        }, 1000);
        // ==========================================
        // EMAIL CONFIGURATION FUNCTIONS
        // ==========================================
        
        // Toggle email configuration sections
        function toggleEmailSection(sectionName) {
            const content = document.getElementById(`${sectionName}-content`);
            const arrow = document.getElementById(`${sectionName}-arrow`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(-90deg)';
            }
        }
        
        // Store the actual password for visibility toggle
        let actualPassword = '';
        
        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('smtpPass');
            const toggleButton = document.getElementById('togglePassword');
            
            if (passwordInput.type === 'password') {
                // Show password
                passwordInput.type = 'text';
                
                // If we have the actual password stored, show it; otherwise show what's in the field
                if (actualPassword && passwordInput.value === '••••••••') {
                    passwordInput.value = actualPassword;
                }
                
                toggleButton.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.94 17.94C16.2 19.57 14.21 20.5 12 20.5C5 20.5 1 12.5 1 12.5C2.24 10.39 4.24 8.47 6.69 7.14L17.94 17.94Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M1 1L23 23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9.9 4.24C10.6 4.07 11.3 4 12 4C19 4 23 12 23 12C22.18 13.35 21.22 14.58 20.16 15.69L17.16 12.69C17.16 12.46 17.16 12.23 17.16 12C17.16 9.79 15.37 8 13.16 8C12.93 8 12.7 8 12.47 8.04L9.9 4.24Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`;
                toggleButton.title = 'Hide password';
            } else {
                // Hide password
                passwordInput.type = 'password';
                if (actualPassword) {
                    passwordInput.value = '••••••••';
                }
                toggleButton.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`;
                toggleButton.title = 'Show password';
            }
        }
        
        // Load email configuration
        async function loadEmailConfiguration() {
            try {
                console.log('📧 Loading email configuration...');
                
                // Load SMTP configuration
                const configResponse = await fetch('/api/email-config/config', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (configResponse.ok) {
                    const data = await configResponse.json();
                    const config = data.config;
                    
                    // Fetch the real password for visibility toggle
                    try {
                        const passwordResponse = await fetch('/api/email-config/real-password', {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        if (passwordResponse.ok) {
                            const passwordData = await passwordResponse.json();
                            if (passwordData.success) {
                                actualPassword = passwordData.password;
                                console.log('📧 Real password stored for visibility toggle');
                            }
                        }
                    } catch (error) {
                        console.log('⚠️ Could not fetch real password for visibility toggle:', error);
                    }
                    
                    // Populate form fields
                    document.getElementById('smtpHost').value = config.smtp_host || '';
                    document.getElementById('smtpPort').value = config.smtp_port || 587;
                    document.getElementById('smtpUser').value = config.smtp_user || '';
                    document.getElementById('smtpPass').value = config.smtp_pass || '';
                    document.getElementById('smtpFrom').value = config.smtp_from || '';
                    document.getElementById('companyName').value = config.company_name || '';
                    document.getElementById('smtpSecure').checked = config.smtp_secure === 1;
                    document.getElementById('emailEnabled').checked = config.enabled === 1;
                    document.getElementById('testEmail').value = config.test_email || '';
                    document.getElementById('safetyOfficerEmail').value = config.safety_officer_email || '';
                    document.getElementById('storePersonnelEmail').value = config.store_personnel_email || '';
                    document.getElementById('adminEmail').value = config.admin_email || '';
                    
                    console.log('📧 Recipient emails loaded:', {
                        safety_officer: config.safety_officer_email,
                        store_personnel: config.store_personnel_email,
                        admin: config.admin_email
                    });
                    
                    // Sections start collapsed by default - users can expand as needed
                    
                    console.log('✅ Email configuration loaded');
                } else {
                    console.error('Failed to load email configuration:', configResponse.status);
                }
                
                // Load notification preferences
                await loadNotificationPreferences();
                
            } catch (error) {
                console.error('Load email configuration error:', error);
                showToast('❌ Failed to load email configuration', 'error');
            }
        }
        
        // Save email configuration
        async function saveEmailConfiguration() {
            try {
                const config = {
                    smtp_host: document.getElementById('smtpHost').value,
                    smtp_port: parseInt(document.getElementById('smtpPort').value),
                    smtp_user: document.getElementById('smtpUser').value,
                    smtp_pass: document.getElementById('smtpPass').value,
                    smtp_from: document.getElementById('smtpFrom').value,
                    company_name: document.getElementById('companyName').value,
                    smtp_secure: document.getElementById('smtpSecure').checked,
                    enabled: document.getElementById('emailEnabled').checked,
                    test_email: document.getElementById('testEmail').value,
                    safety_officer_email: document.getElementById('safetyOfficerEmail').value,
                    store_personnel_email: document.getElementById('storePersonnelEmail').value,
                    admin_email: document.getElementById('adminEmail').value
                };
                
                // Validate required fields
                if (!config.smtp_host || !config.smtp_port || !config.smtp_user || !config.smtp_from) {
                    showToast('❌ Please fill in all required fields', 'error');
                    return;
                }
                
                const response = await fetch('/api/email-config/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    showToast('✅ Email configuration saved successfully', 'success');
                } else {
                    const error = await response.json();
                    showToast(`❌ ${error.error || 'Failed to save configuration'}`, 'error');
                }
                
            } catch (error) {
                console.error('Save email configuration error:', error);
                showToast('❌ Failed to save email configuration', 'error');
            }
        }
        
        // Test email configuration
        async function testEmailConfiguration() {
            try {
                const testEmailBtn = document.getElementById('testEmailBtn');
                const originalText = testEmailBtn.textContent;
                
                testEmailBtn.textContent = '📤 Sending...';
                testEmailBtn.disabled = true;
                
                const testEmail = document.getElementById('testEmail').value;
                
                const response = await fetch('/api/email-config/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ test_email: testEmail })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`✅ Test email sent to ${result.recipient}`, 'success');
                } else {
                    showToast(`❌ ${result.error || 'Failed to send test email'}`, 'error');
                }
                
            } catch (error) {
                console.error('Test email error:', error);
                showToast('❌ Failed to send test email', 'error');
            } finally {
                const testEmailBtn = document.getElementById('testEmailBtn');
                testEmailBtn.textContent = '📤 Send Test Email';
                testEmailBtn.disabled = false;
            }
        }
        
        // Load notification preferences
        async function loadNotificationPreferences() {
            try {
                const response = await fetch('/api/email-config/preferences', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayNotificationPreferences(data.preferences, data.admin_email);
                } else {
                    console.error('Failed to load notification preferences');
                }
                
            } catch (error) {
                console.error('Load notification preferences error:', error);
            }
        }
        
        // Display notification preferences
        function displayNotificationPreferences(preferences, adminEmail) {
            const container = document.getElementById('notificationPreferences');
            
            const notificationTypes = [
                { type: 'ppe_request_new', name: 'New PPE Requests', description: 'When workers submit new PPE requests' },
                { type: 'ppe_request_approved', name: 'PPE Request Approved', description: 'When PPE requests are approved' },
                { type: 'ppe_request_rejected', name: 'PPE Request Rejected', description: 'When PPE requests are rejected' },
                { type: 'stock_low', name: 'Low Stock Alerts', description: 'When PPE stock levels are low' },
                { type: 'stock_critical', name: 'Critical Stock Alerts', description: 'When PPE stock levels are critically low' },
                { type: 'license_expiring', name: 'License Expiration', description: 'When system license is about to expire' },
                { type: 'weekly_summary', name: 'Weekly Summary', description: 'Weekly PPE usage summary reports' },
                { type: 'monthly_summary', name: 'Monthly Summary', description: 'Monthly PPE usage summary reports' }
            ];
            
            let html = `
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <p style="margin: 0; color: #6b7280;">
                        📧 Notifications will be sent to: <strong>${adminEmail}</strong>
                    </p>
                </div>
                <div style="display: grid; gap: 12px;">
            `;
            
            notificationTypes.forEach(notifType => {
                const pref = preferences.find(p => p.notification_type === notifType.type);
                const isEnabled = pref ? pref.enabled === 1 : true;
                const frequency = pref ? pref.frequency : 'immediate';
                
                html += `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div>
                                <h5 style="margin: 0; font-weight: 600;">${notifType.name}</h5>
                                <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">${notifType.description}</p>
                            </div>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" ${isEnabled ? 'checked' : ''} 
                                       onchange="updateNotificationPreference('${notifType.type}', this.checked, '${frequency}')"
                                       style="margin: 0;">
                                <span style="font-weight: 500;">Enable</span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #6b7280; font-size: 14px;">Frequency:</span>
                            <select onchange="updateNotificationPreference('${notifType.type}', ${isEnabled}, this.value)"
                                    style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                                <option value="immediate" ${frequency === 'immediate' ? 'selected' : ''}>Immediate</option>
                                <option value="hourly" ${frequency === 'hourly' ? 'selected' : ''}>Hourly</option>
                                <option value="daily" ${frequency === 'daily' ? 'selected' : ''}>Daily</option>
                                <option value="weekly" ${frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                            </select>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <div style="margin-top: 16px;">
                    <button class="btn-primary" onclick="saveNotificationPreferences()">💾 Save Preferences</button>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Update notification preference
        function updateNotificationPreference(notificationType, enabled, frequency) {
            // This will be handled when saving all preferences
            console.log(`Preference updated: ${notificationType} = ${enabled}, frequency = ${frequency}`);
        }
        
        // Save notification preferences
        async function saveNotificationPreferences() {
            try {
                const container = document.getElementById('notificationPreferences');
                const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                const selects = container.querySelectorAll('select');
                
                const preferences = [];
                
                checkboxes.forEach((checkbox, index) => {
                    const notificationType = checkbox.getAttribute('onchange').match(/'([^']+)'/)[1];
                    const frequency = selects[index].value;
                    
                    preferences.push({
                        notification_type: notificationType,
                        enabled: checkbox.checked,
                        frequency: frequency
                    });
                });
                
                const response = await fetch('/api/email-config/preferences', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ preferences })
                });
                
                if (response.ok) {
                    showToast('✅ Notification preferences saved', 'success');
                } else {
                    const error = await response.json();
                    showToast(`❌ ${error.error || 'Failed to save preferences'}`, 'error');
                }
                
            } catch (error) {
                console.error('Save notification preferences error:', error);
                showToast('❌ Failed to save notification preferences', 'error');
            }
        }

        // ===== SCHEDULED REPORTS FUNCTIONS =====
        
        // Switch between reports sub-tabs
        function switchReportsSubTab(section) {
            // Update sub-tab buttons
            document.getElementById('reportsAnalyticsSubTab').classList.remove('active');
            document.getElementById('scheduledReportsSubTab').classList.remove('active');
            
            // Hide all sections
            document.getElementById('reportsAnalyticsSection').style.display = 'none';
            document.getElementById('scheduledReportsSection').style.display = 'none';
            
            // Show selected section and activate button
            if (section === 'analytics') {
                document.getElementById('reportsAnalyticsSubTab').classList.add('active');
                document.getElementById('reportsAnalyticsSection').style.display = 'block';
                // Load analytics if needed
                if (isAuthenticated) {
                    loadReports();
                }
            } else if (section === 'scheduled') {
                document.getElementById('scheduledReportsSubTab').classList.add('active');
                document.getElementById('scheduledReportsSection').style.display = 'block';
                // Load scheduled reports
                if (isAuthenticated) {
                    loadScheduledReports();
                }
            }
        }

        // Load scheduled reports
        async function loadScheduledReports() {
            try {
                const response = await fetch('/api/scheduled-reports', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayScheduledReports(data.reports);
                } else if (response.status === 401 || response.status === 403) {
                    // Authentication issue - show empty state
                    console.log('Authentication required for scheduled reports');
                    displayScheduledReports([]);
                } else {
                    showToast('❌ Failed to load scheduled reports', 'error');
                    displayScheduledReports([]);
                }
            } catch (error) {
                console.error('Load scheduled reports error:', error);
                // Still show the interface even if there's an error
                displayScheduledReports([]);
                showToast('⚠️ Scheduled reports loaded with limited functionality', 'warning');
            }
        }

        // Display scheduled reports in table
        function displayScheduledReports(reports) {
            const tbody = document.getElementById('scheduledReportsTableBody');
            
            if (!reports || reports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                            No scheduled reports found. Click "Schedule New Report" to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = reports.map(report => `
                <tr>
                    <td style="font-weight: 500;">${report.name}</td>
                    <td>
                        <span style="background: #e0f2fe; color: #0277bd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${formatReportType(report.report_type)}
                        </span>
                    </td>
                    <td style="font-family: monospace; font-size: 12px;">${formatCronSchedule(report.schedule_cron)}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${report.recipients}
                    </td>
                    <td style="font-size: 12px; color: #6b7280;">
                        ${report.last_run ? formatDateOnlyLocal(report.last_run) : 'Never'}
                    </td>
                    <td>
                        <span style="color: ${report.enabled ? '#059669' : '#dc2626'};">
                            ${report.enabled ? '🟢 Active' : '🔴 Disabled'}
                        </span>
                    </td>
                    <td>
                        <button onclick="testScheduledReport('${report.id}', '${report.report_type}', '${report.recipients}')" 
                                class="btn-secondary" style="font-size: 12px; padding: 4px 8px; margin-right: 4px;">
                            Test
                        </button>
                        <button onclick="editScheduledReport('${report.id}')" 
                                class="btn-secondary" style="font-size: 12px; padding: 4px 8px; margin-right: 4px;">
                            Edit
                        </button>
                        <button onclick="deleteScheduledReport('${report.id}', '${report.name}')" 
                                class="btn-danger" style="font-size: 12px; padding: 4px 8px;">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Format report type for display
        function formatReportType(reportType) {
            const types = {
                'daily_summary': 'Daily Summary',
                'weekly_analytics': 'Weekly Analytics', 
                'monthly_compliance': 'Monthly Compliance',
                'inventory_status': 'Inventory Status',
                'staff_usage': 'Staff Usage'
            };
            return types[reportType] || reportType;
        }

        // Format cron schedule for display
        function formatCronSchedule(cron) {
            const schedules = {
                '0 9 * * *': 'Daily at 9:00 AM',
                '0 9 * * 1': 'Weekly on Monday',
                '0 9 1 * *': 'Monthly on 1st',
                '0 9 * * 1,4': 'Mon & Thu at 9:00 AM',
                '0 18 * * *': 'Daily at 6:00 PM'
            };
            return schedules[cron] || cron;
        }

        // Show modal for adding scheduled report
        function showAddScheduledReportModal() {
            // Remove any existing modal
            const existingModal = document.getElementById('dynamicScheduledReportModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHTML = `
                <div id="dynamicScheduledReportModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                " onclick="if (event.target === this) closeScheduledReportModal()">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        padding: 24px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #1f2937; font-size: 20px;">⏰ Schedule New Report</h3>
                            <button onclick="closeScheduledReportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
                        </div>
                        
                        <div style="display: grid; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Report Name *</label>
                                <input type="text" id="schedReportName" placeholder="e.g., Daily Operations Summary" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Report Type *</label>
                                <select id="schedReportType" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="">Select report type...</option>
                                    <option value="daily_summary">📊 Daily Summary</option>
                                    <option value="weekly_analytics">📈 Weekly Analytics</option>
                                    <option value="monthly_compliance">📋 Monthly Compliance</option>
                                    <option value="inventory_status">📦 Inventory Status</option>
                                    <option value="staff_usage">👥 Staff Usage Report</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Schedule *</label>
                                <select id="schedReportSchedule" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="">Select schedule...</option>
                                    <option value="0 9 * * *">📅 Daily at 9:00 AM</option>
                                    <option value="0 9 * * 1">📅 Weekly on Monday</option>
                                    <option value="0 9 1 * *">📅 Monthly on 1st</option>
                                    <option value="0 9 * * 1,4">📅 Monday & Thursday</option>
                                    <option value="0 18 * * *">📅 Daily at 6:00 PM</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email Recipients *</label>
                                <input type="email" id="schedReportRecipients" placeholder="email1@company.com, email2@company.com" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <small style="color: #6b7280;">Separate multiple emails with commas</small>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description</label>
                                <textarea id="schedReportDescription" placeholder="Optional description for this scheduled report" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; height: 80px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="schedReportEnabled" checked style="width: 16px; height: 16px;">
                                <label for="schedReportEnabled" style="margin: 0; font-weight: 500;">Enable immediately after creation</label>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                            <button onclick="closeScheduledReportModal()" style="
                                padding: 12px 24px;
                                background: #6b7280;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                            ">Cancel</button>
                            <button onclick="createScheduledReport()" style="
                                padding: 12px 24px;
                                background: var(--primary-color);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                            ">Schedule Report</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close scheduled report modal
        function closeScheduledReportModal() {
            const modal = document.getElementById('dynamicScheduledReportModal');
            if (modal) {
                modal.remove();
            }
        }

        // Create new scheduled report
        async function createScheduledReport() {
            const name = document.getElementById('schedReportName').value.trim();
            const reportType = document.getElementById('schedReportType').value;
            const scheduleCron = document.getElementById('schedReportSchedule').value;
            const recipients = document.getElementById('schedReportRecipients').value.trim();
            const description = document.getElementById('schedReportDescription').value.trim();
            const enabled = document.getElementById('schedReportEnabled').checked;

            if (!name || !reportType || !scheduleCron || !recipients) {
                showToast('❌ Please fill in all required fields', 'error');
                return;
            }

            try {
                const response = await fetch('/api/scheduled-reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        reportType,
                        scheduleCron,
                        recipients,
                        description,
                        enabled
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`✅ ${result.message}`, 'success');
                    closeScheduledReportModal();
                    loadScheduledReports();
                } else {
                    showToast(`❌ ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Create scheduled report error:', error);
                showToast('❌ Failed to create scheduled report', 'error');
            }
        }

        // Test scheduled report
        async function testScheduledReport(reportId, reportType, recipients) {
            if (!confirm(`Send a test ${formatReportType(reportType)} report to ${recipients}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/scheduled-reports/test/${reportType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ recipients })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`✅ ${result.message}`, 'success');
                } else {
                    showToast(`❌ ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Test scheduled report error:', error);
                showToast('❌ Failed to send test report', 'error');
            }
        }

        // Edit scheduled report (placeholder)
        function editScheduledReport(reportId) {
            showToast('📝 Edit functionality coming soon', 'info');
        }

        // Delete scheduled report (placeholder)
        function deleteScheduledReport(reportId, reportName) {
            if (!confirm(`Delete scheduled report "${reportName}"?\n\nThis will stop the automated report generation.`)) {
                return;
            }
            showToast('🗑️ Delete functionality coming soon', 'info');
        }

        // Refresh scheduled reports
        function refreshScheduledReports() {
            animateRefreshButton(event, () => loadScheduledReports());
        }

        // ===============================
        // CONDITION REPORTS MANAGEMENT
        // ===============================

        // Load condition reports
        async function loadConditionReports() {
            try {
                const statusFilter = document.getElementById('conditionReportStatusFilter').value;
                const params = statusFilter !== 'all' ? `?status=${statusFilter}` : '';
                
                const response = await fetch(`/api/condition-reports/admin/all${params}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                const container = document.getElementById('conditionReportsList');

                if (response.ok && result.success) {
                    if (result.reports.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                                <p style="font-size: 18px; margin-bottom: 8px;">No condition reports found</p>
                                <p style="font-size: 14px;">Reports will appear here when staff submit PPE condition issues</p>
                            </div>
                        `;
                        return;
                    }

                    const reportsHTML = result.reports.map(report => {
                        const statusColor = {
                            'reported': '#dc2626',
                            'in_progress': '#f59e0b', 
                            'resolved': '#000000',
                            'dismissed': '#6b7280'
                        }[report.status] || '#6b7280';

                        const severityColor = {
                            'low': '#000000',
                            'medium': '#f59e0b',
                            'high': '#dc2626',
                            'critical': '#7c2d12'
                        }[report.severity] || '#6b7280';

                        const reportedDate = formatWithTimezoneLocal(report.created_at);
                        const resolvedDate = report.resolved_at ? formatWithTimezoneLocal(report.resolved_at) : null;

                        return `
                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: white;">
                                <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                            <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                                ${report.status.toUpperCase()}
                                            </span>
                                            <span style="background: ${severityColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                                ${report.severity.toUpperCase()}
                                            </span>
                                            <span style="color: #6b7280; font-size: 12px;">
                                                📅 ${reportedDate}
                                            </span>
                                        </div>
                                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                                            Reported by: ${report.staff_name} (${report.staff_id})
                                        </div>
                                        ${report.location ? `<div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">📍 Location: ${report.location}</div>` : ''}
                                    </div>
                                    ${report.photo_path ? `
                                        <button onclick="viewConditionReportPhoto('${report.photo_path}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            📷 View Photo
                                        </button>
                                    ` : ''}
                                </div>
                                
                                <div style="color: #1f2937; margin-bottom: 12px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                                    <strong>Description:</strong><br>
                                    ${report.description}
                                </div>
                                
                                ${report.resolution_notes ? `
                                    <div style="color: #1f2937; margin-bottom: 12px; padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #3b82f6;">
                                        <strong>Resolution Notes:</strong><br>
                                        ${report.resolution_notes}
                                        ${resolvedDate ? `<div style="color: #6b7280; font-size: 12px; margin-top: 8px;">Resolved on: ${resolvedDate}</div>` : ''}
                                        ${report.resolved_by ? `<div style="color: #6b7280; font-size: 12px;">Resolved by: ${report.resolved_by}</div>` : ''}
                                    </div>
                                ` : ''}
                                
                                ${report.status === 'reported' || report.status === 'in_progress' ? `
                                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                                        <button onclick="updateConditionReportStatus('${report.id}', 'in_progress')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            🔄 Mark In Progress
                                        </button>
                                        <button onclick="resolveConditionReport('${report.id}', '${report.staff_name}')" style="background: #000000; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ✅ Mark Resolved
                                        </button>
                                        <button onclick="updateConditionReportStatus('${report.id}', 'dismissed')" style="background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ❌ Dismiss
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = `
                        <div style="margin-bottom: 16px; color: #374151;">
                            <strong>Found ${result.reports.length} condition report${result.reports.length !== 1 ? 's' : ''}</strong>
                        </div>
                        ${reportsHTML}
                    `;

                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc2626;">
                            <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                            <p>Failed to load condition reports</p>
                            <p style="font-size: 14px; color: #6b7280;">${result.error || 'Unknown error'}</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Load condition reports error:', error);
                document.getElementById('conditionReportsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc2626;">
                        <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                        <p>Error loading condition reports</p>
                        <p style="font-size: 14px; color: #6b7280;">Check console for details</p>
                    </div>
                `;
            }
        }

        // Update condition report status
        async function updateConditionReportStatus(reportId, status) {
            try {
                const response = await fetch(`/api/condition-reports/${reportId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        status: status,
                        resolvedBy: 'admin',
                        resolutionNotes: `Status updated to ${status} by admin`
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`✅ ${result.message}`, 'success');
                    loadConditionReports(); // Refresh the list
                } else {
                    showToast(`❌ ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Update condition report status error:', error);
                showToast('❌ Failed to update condition report status', 'error');
            }
        }

        // Resolve condition report with custom notes
        async function resolveConditionReport(reportId, staffName) {
            const resolutionNotes = prompt(`Resolution notes for ${staffName}'s condition report:`, 'Issue has been addressed and resolved.');
            
            if (resolutionNotes === null) return; // User cancelled
            
            try {
                const response = await fetch(`/api/condition-reports/${reportId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        status: 'resolved',
                        resolvedBy: 'admin',
                        resolutionNotes: resolutionNotes || 'Resolved by admin'
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(`✅ ${result.message}`, 'success');
                    loadConditionReports(); // Refresh the list
                } else {
                    showToast(`❌ ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Resolve condition report error:', error);
                showToast('❌ Failed to resolve condition report', 'error');
            }
        }

        // View condition report photo
        function viewConditionReportPhoto(photoPath) {
            const photoUrl = `/api/condition-reports/photo/${photoPath}`;
            window.open(photoUrl, '_blank');
        }
        
        // Mobile sidebar functionality
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }
        

    </script>
        
                </div>
            </div>
        </main>
    </div>
    
    <!-- PWA Bottom Navigation (Mobile Only) -->
    <nav class="mobile-bottom-nav" id="mobileBottomNav">
        <div class="bottom-nav-container">
            <button class="bottom-nav-item active" onclick="switchTabMobile('dashboard')" data-tab="dashboard">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span class="nav-label">Home</span>
            </button>
            
            <button class="bottom-nav-item" onclick="switchTabMobile('pending-approvals')" data-tab="pending-approvals">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12,6 12,12 16,14"></polyline>
                </svg>
                <span class="nav-label">Requests</span>
            </button>
            
            <button class="bottom-nav-item" onclick="switchTabMobile('ppe-inventory')" data-tab="ppe-inventory">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8z"></path>
                    <polyline points="7.5,4.21 12,6.81 16.5,4.21"></polyline>
                </svg>
                <span class="nav-label">Stock</span>
            </button>
            
            <button class="bottom-nav-item" onclick="switchTabMobile('reports')" data-tab="reports">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M18 20V10"></path>
                    <path d="M12 20V4"></path>
                    <path d="M6 20v-6"></path>
                </svg>
                <span class="nav-label">Reports</span>
            </button>
            
            <button class="bottom-nav-item" onclick="showMobileMenuModal()" data-tab="more">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="19" cy="12" r="1"></circle>
                    <circle cx="5" cy="12" r="1"></circle>
                </svg>
                <span class="nav-label">More</span>
            </button>
        </div>
    </nav>
    
    <!-- Mobile Menu Modal -->
    <div class="modal" id="mobileMenuModal" style="display: none;">
        <div class="modal-content" style="max-width: 90%; margin-top: 20px;">
            <div class="modal-header">
                <h3>More Options</h3>
                <button class="modal-close" onclick="closeMobileMenuModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mobile-menu-grid">
                    <button class="mobile-menu-option" onclick="switchTabMobile('station-management')">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>Stations</span>
                    </button>
                    
                    <button class="mobile-menu-option" onclick="switchTabMobile('staff-management')">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>Staff</span>
                    </button>
                    
                    <button class="mobile-menu-option" onclick="switchTabMobile('features')">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        <span>Settings</span>
                    </button>
                    
                    <button class="mobile-menu-option" onclick="switchTabMobile('email-config')">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <span>Email</span>
                    </button>
                    
                    <a href="worker.html" class="mobile-menu-option">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <span>Worker View</span>
                    </a>
                    
                    <button class="mobile-menu-option" onclick="logout()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16,17 21,12 16,7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Mobile bottom navigation functions
        function switchTabMobile(tabName) {
            // Close mobile menu modal if open with fade effect
            closeMobileMenuModal();
            
            // Add fade out effect to current tab
            const currentTab = document.querySelector('.tab-content:not([style*="display: none"])');
            if (currentTab) {
                currentTab.classList.add('hiding');
                setTimeout(() => {
                    // Use existing switchTab function
                    switchTab(tabName);
                    
                    // Remove hiding class after switch
                    setTimeout(() => {
                        const allTabs = document.querySelectorAll('.tab-content');
                        allTabs.forEach(tab => tab.classList.remove('hiding'));
                    }, 50);
                }, 300);
            } else {
                // No current tab, switch immediately
                switchTab(tabName);
            }
            
            // Update bottom navigation active state
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            bottomNavItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-tab') === tabName) {
                    item.classList.add('active');
                }
            });
            
            // Update page title for mobile
            updateMobilePageTitle(tabName);
        }
        
        function updateMobilePageTitle(tabName) {
            const titleElement = document.querySelector('.page-title');
            if (!titleElement) return;
            
            const titles = {
                'dashboard': 'Dashboard',
                'pending-approvals': 'Pending Requests',
                'inventory': 'Inventory',
                'reports': 'Reports',
                'station-management': 'Stations',
                'staff-management': 'Staff Management',
                'features': 'Settings',
                'email-config': 'Email Settings'
            };
            
            titleElement.textContent = titles[tabName] || 'PPE Admin';
        }
        
        function showMobileMenuModal() {
            const modal = document.getElementById('mobileMenuModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.remove('closing');
                document.body.style.overflow = 'hidden';
                
                // Add touch scroll handling for modal content
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.maxHeight = '85vh';
                    modalContent.style.overflowY = 'auto';
                }
            }
        }
        
        function closeMobileMenuModal() {
            const modal = document.getElementById('mobileMenuModal');
            if (modal) {
                modal.classList.add('closing');
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.remove('closing');
                    document.body.style.overflow = 'auto';
                }, 300);
            }
        }
        
        // Enhanced modal interaction handling
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('mobileMenuModal');
            if (e.target === modal) {
                closeMobileMenuModal();
            }
        });
        
        // Add touch handling for mobile modal
        document.addEventListener('touchstart', function(e) {
            const modal = document.getElementById('mobileMenuModal');
            if (modal && e.target === modal) {
                closeMobileMenuModal();
            }
        });
        
        // Initialize mobile navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial active state for bottom nav
            const currentTab = document.querySelector('.nav-item.active')?.getAttribute('data-tab') || 'dashboard';
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            bottomNavItems.forEach(item => {
                if (item.getAttribute('data-tab') === currentTab) {
                    item.classList.add('active');
                }
            });
            
            updateMobilePageTitle(currentTab);
            
            // Dynamic mobile bottom spacing adjustment for PPE inventory
            adjustMobilePPEInventorySpacing();
            
            // Re-adjust spacing when window resizes or orientation changes
            window.addEventListener('resize', adjustMobilePPEInventorySpacing);
            window.addEventListener('orientationchange', function() {
                setTimeout(adjustMobilePPEInventorySpacing, 500); // Delay for orientation change completion
            });
        });
        
        // Dynamic function to adjust PPE inventory bottom spacing on mobile
        function adjustMobilePPEInventorySpacing() {
            // Only apply on mobile devices
            if (window.innerWidth > 640) return;
            
            const bottomNav = document.getElementById('mobileBottomNav');
            const ppeInventoryTab = document.getElementById('ppe-inventory-tab');
            const ppeSubSections = document.querySelectorAll('.ppe-sub-section');
            const tableContainers = document.querySelectorAll('.ppe-sub-section .table-container');
            const inventoryGrid = document.getElementById('inventoryGrid');
            
            if (!bottomNav || !ppeInventoryTab) return;
            
            // Get actual bottom navigation height
            const bottomNavHeight = bottomNav.offsetHeight;
            const safeAreaBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom') || '0', 10);
            const totalBottomSpace = bottomNavHeight + safeAreaBottom + 40; // Extra buffer
            
            // Apply dynamic spacing
            ppeInventoryTab.style.paddingBottom = `${totalBottomSpace + 40}px`;
            
            ppeSubSections.forEach((section, index) => {
                section.style.marginBottom = `${Math.max(80, totalBottomSpace)}px`;
                
                // Additional padding for last section
                if (index === ppeSubSections.length - 1) {
                    section.style.paddingBottom = `${Math.max(40, totalBottomSpace / 2)}px`;
                }
            });
            
            // Adjust table containers max height dynamically
            tableContainers.forEach(container => {
                const availableHeight = window.innerHeight - 350; // Account for header, tabs, bottom nav
                container.style.maxHeight = `${Math.max(300, availableHeight)}px`;
                container.style.marginBottom = `${Math.max(60, totalBottomSpace / 2)}px`;
            });
            
            // Adjust inventory grid if it exists
            if (inventoryGrid) {
                inventoryGrid.style.marginBottom = `${Math.max(80, totalBottomSpace)}px`;
                inventoryGrid.style.paddingBottom = `${Math.max(40, totalBottomSpace / 2)}px`;
            }
            
            console.log(`📱 PPE Inventory mobile spacing adjusted: ${totalBottomSpace}px bottom space`);
        }
        
        // Hook into tab switching to re-adjust spacing when navigating to PPE inventory
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            const result = originalSwitchTab.apply(this, arguments);
            
            // Re-adjust spacing when switching to PPE inventory tab
            if (tabName === 'ppe-inventory') {
                setTimeout(adjustMobilePPEInventorySpacing, 100);
            }
            
            return result;
        };
    </script>

    <!-- Dynamic Timezone Utilities (Embedded) -->
    <script>
        /**
         * Dynamic Timezone Detection and Conversion Utilities
         * Automatically detects user's timezone and converts UTC timestamps
         */

        class TimezoneUtils {
            constructor() {
                this.userTimezone = this.detectUserTimezone();
                this.initializeUtils();
            }

            /**
             * Detect user's timezone automatically
             * @returns {string} IANA timezone identifier
             */
            detectUserTimezone() {
                try {
                    // Primary: Use Intl.DateTimeFormat to get timezone
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    console.log(`🌍 Detected user timezone: ${timezone}`);
                    return timezone;
                } catch (error) {
                    console.warn('⚠️ Failed to detect timezone, using UTC as fallback:', error);
                    return 'UTC';
                }
            }

            /**
             * Get timezone display name and offset
             * @returns {Object} Timezone information
             */
            getTimezoneInfo() {
                try {
                    const now = new Date();
                    const formatter = new Intl.DateTimeFormat('en', {
                        timeZone: this.userTimezone,
                        timeZoneName: 'long'
                    });
                    
                    const parts = formatter.formatToParts(now);
                    const timeZoneName = parts.find(part => part.type === 'timeZoneName')?.value || this.userTimezone;
                    
                    // Calculate offset in hours
                    const offsetMs = now.getTimezoneOffset() * 60000;
                    const offsetHours = -offsetMs / 3600000;
                    const offsetString = offsetHours >= 0 ? `+${offsetHours}` : `${offsetHours}`;
                    
                    return {
                        timezone: this.userTimezone,
                        displayName: timeZoneName,
                        offset: offsetHours,
                        offsetString: `UTC${offsetString}`,
                        abbreviation: this.getTimezoneAbbreviation(now)
                    };
                } catch (error) {
                    console.warn('⚠️ Failed to get timezone info:', error);
                    return {
                        timezone: 'UTC',
                        displayName: 'Coordinated Universal Time',
                        offset: 0,
                        offsetString: 'UTC+0',
                        abbreviation: 'UTC'
                    };
                }
            }

            /**
             * Get timezone abbreviation (e.g., MYT, JST, EST)
             * @param {Date} date 
             * @returns {string}
             */
            getTimezoneAbbreviation(date = new Date()) {
                try {
                    const formatter = new Intl.DateTimeFormat('en', {
                        timeZone: this.userTimezone,
                        timeZoneName: 'short'
                    });
                    
                    const parts = formatter.formatToParts(date);
                    return parts.find(part => part.type === 'timeZoneName')?.value || this.userTimezone;
                } catch (error) {
                    return 'UTC';
                }
            }

            /**
             * Convert database timestamp to user's local timezone
             * @param {string|Date} timestamp - Timestamp from database (may be UTC or local)
             * @returns {Date} Date object properly adjusted
             */
            convertToLocalTime(timestamp) {
                try {
                    let date;
                    
                    if (typeof timestamp === 'string') {
                        // Check if timestamp has timezone info
                        if (timestamp.includes('T') && timestamp.includes('Z')) {
                            // This is UTC format (e.g., '2025-07-27T14:06:05.000Z')
                            date = new Date(timestamp);
                        } else if (timestamp.includes('T') && (timestamp.includes('+') || timestamp.includes('-'))) {
                            // This has timezone offset (e.g., '2025-07-27T14:06:05+08:00')
                            date = new Date(timestamp);
                        } else {
                            // This is local database time without timezone (e.g., '2025-07-27 14:06:05')
                            // Treat as local server time and convert properly
                            const localDate = new Date(timestamp);
                            
                            // Get the server timezone offset (assuming server is in same timezone)
                            const serverOffset = new Date().getTimezoneOffset();
                            
                            // If the parsed date shows wrong timezone, it means DB stores local time
                            // We need to adjust for this
                            const dbTimezoneName = this.detectDatabaseTimezone(timestamp, localDate);
                            
                            if (dbTimezoneName === 'local-as-utc') {
                                // Database stores local time but JS parses as UTC
                                // Add back the timezone offset to get correct time
                                date = new Date(localDate.getTime() + (8 * 60 * 60 * 1000)); // Add 8 hours for Malaysia
                            } else {
                                date = localDate;
                            }
                        }
                    } else {
                        date = timestamp;
                    }
                    
                    if (isNaN(date.getTime())) {
                        throw new Error('Invalid timestamp');
                    }

                    return date;
                } catch (error) {
                    console.warn('⚠️ Failed to convert timestamp:', error);
                    return new Date();
                }
            }

            /**
             * Detect how the database stores timestamps
             * @param {string} originalTimestamp 
             * @param {Date} parsedDate 
             * @returns {string} Database timezone behavior
             */
            detectDatabaseTimezone(originalTimestamp, parsedDate) {
                // If the original timestamp looks like local time but JS parsed it as UTC,
                // we can detect this by checking if the hours don't match what we expect
                
                // For Malaysia: if timestamp is '2025-07-27 14:06:05' and current time is ~22:06,
                // it means the DB stored local time but JS parsed it as UTC (shifted by 8 hours)
                
                const now = new Date();
                const timeDiffFromNow = Math.abs(now.getTime() - parsedDate.getTime()) / (1000 * 60 * 60); // hours
                
                // If the time difference is roughly 8 hours off, DB likely stores local time
                if (timeDiffFromNow > 6 && timeDiffFromNow < 10) {
                    return 'local-as-utc';
                }
                
                return 'proper-utc';
            }

            /**
             * Format timestamp in user's timezone with multiple options
             * @param {string|Date} utcTimestamp 
             * @param {Object} options - Formatting options
             * @returns {string} Formatted timestamp
             */
            formatInUserTimezone(utcTimestamp, options = {}) {
                try {
                    const date = this.convertToLocalTime(utcTimestamp);
                    
                    const defaultOptions = {
                        timeZone: this.userTimezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    };

                    const formatOptions = { ...defaultOptions, ...options };
                    return date.toLocaleString('en-GB', formatOptions);
                } catch (error) {
                    console.warn('⚠️ Failed to format timestamp:', error);
                    return 'Invalid Date';
                }
            }

            /**
             * Format timestamp as "time ago" (e.g., "2 hours ago") in user's timezone
             * @param {string|Date} utcTimestamp 
             * @returns {string} Relative time string
             */
            formatTimeAgo(utcTimestamp) {
                try {
                    const date = this.convertToLocalTime(utcTimestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    const diffWeeks = Math.floor(diffDays / 7);
                    const diffMonths = Math.floor(diffDays / 30);
                    
                    if (diffMs < 0) return 'In the future';
                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffHours < 24) return `${diffHours}h ago`;
                    if (diffDays < 7) return `${diffDays}d ago`;
                    if (diffWeeks < 4) return `${diffWeeks}w ago`;
                    if (diffMonths < 12) return `${diffMonths}mo ago`;
                    
                    // For older items, show actual date in user's timezone
                    return this.formatInUserTimezone(utcTimestamp, {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (error) {
                    console.warn('⚠️ Failed to format time ago:', error);
                    return 'Unknown time';
                }
            }

            /**
             * Format date only (no time) in user's timezone
             * @param {string|Date} utcTimestamp 
             * @returns {string} Formatted date
             */
            formatDateOnly(utcTimestamp) {
                return this.formatInUserTimezone(utcTimestamp, {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }

            /**
             * Format with timezone indicator for clarity
             * @param {string|Date} utcTimestamp 
             * @param {Object} options 
             * @returns {string} Formatted timestamp with timezone
             */
            formatWithTimezone(utcTimestamp, options = {}) {
                const formatted = this.formatInUserTimezone(utcTimestamp, options);
                const tzInfo = this.getTimezoneInfo();
                return `${formatted} (${tzInfo.abbreviation})`;
            }

            /**
             * Initialize global utility functions for backward compatibility
             */
            initializeUtils() {
                // Make utilities available globally
                window.TimezoneUtils = this;
                
                // Create global convenience functions
                window.formatInLocalTimezone = (timestamp, options) => this.formatInUserTimezone(timestamp, options);
                window.formatTimeAgoLocal = (timestamp) => this.formatTimeAgo(timestamp);
                window.formatDateOnlyLocal = (timestamp) => this.formatDateOnly(timestamp);
                window.formatWithTimezoneLocal = (timestamp, options) => this.formatWithTimezone(timestamp, options);
                
                console.log('🕐 Timezone utilities initialized for:', this.getTimezoneInfo());
            }

            /**
             * Debug information for troubleshooting
             * @returns {Object} Debug information
             */
            getDebugInfo() {
                const now = new Date();
                const utcString = now.toISOString();
                const localString = this.formatInUserTimezone(now);
                
                return {
                    detectedTimezone: this.userTimezone,
                    timezoneInfo: this.getTimezoneInfo(),
                    currentUTC: utcString,
                    currentLocal: localString,
                    browserTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneOffset: new Date().getTimezoneOffset()
                };
            }
        }

        // Initialize timezone utilities when script loads
        const timezoneUtils = new TimezoneUtils();
    </script>

</body>
</html>